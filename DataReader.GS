/**
 * ======================================================
 * DATA READER - GÃœNCELLENMÄ°Å VERSÄ°YON (TÃœM SÃœTUNLAR + GEÃ‡MÄ°Å FÄ°YATLAR)
 * ------------------------------------------------------
 * SORUMLULUKLAR:
 * 1. Google Sheet'ten HAM VERÄ°YÄ° okur (CONFIG.SHEETS.PORTFOY)
 * 2. TÃœM SÃœTUNLARI okur (A:AQ gibi) - 44 sÃ¼tun
 * 3. Veriyi temel JavaScript objelerine Ã§evirir
 * 4. HÄ°Ã‡BÄ°R finansal hesaplama yapmaz
 * 5. Cache mekanizmasÄ± iÃ§erir (performans iÃ§in)
 * 6. GeÃ§miÅŸ fiyat verilerini okur
 * ======================================================
 */
const DataReader = {

  /**
   * Cache iÃ§in Ã¶zellikler - GENÄ°ÅLETÄ°LMÄ°Å
   */
  _cache: {
    portfolio: null,
    historicalSTOCK: null,
    historicalCURRENCY: null,
    historicalGOLD: null,
    lastFetchPortfolio: null,
    lastFetchSTOCK: null,
    lastFetchCURRENCY: null,
    lastFetchGOLD: null,
    CACHE_DURATION: 5 * 60 * 1000, // 5 dakika (milisaniye)
  },

  // ==================== MEVCUT PORFÃ–Y OKUMA KODLARI ====================
  
  /**
   * Ana fonksiyon: PortfÃ¶y verilerini okur (cache'li)
   * @returns {Array<Object>} TÃ¼m portfÃ¶y verileri (tÃ¼m sÃ¼tunlar)
   */
  readPortfolio(forceRefresh = false) {
    console.log('ğŸ“– DataReader: PortfÃ¶y verileri okunuyor...');
    
    // Cache kontrolÃ¼
    if (!forceRefresh && this._cache.portfolio && this._cache.lastFetchPortfolio) {
      const age = new Date().getTime() - this._cache.lastFetchPortfolio.getTime();
      if (age < this._cache.CACHE_DURATION) {
        console.log('ğŸ’¾ Cache\'den veri dÃ¶ndÃ¼rÃ¼lÃ¼yor');
        return this._cache.portfolio;
      }
    }
    
    try {
      // 1. Sheet'i aÃ§
      const sheet = this._getPortfolioSheet();
      if (!sheet) {
        console.error('âŒ PortfÃ¶y sheet\'i bulunamadÄ±');
        return [];
      }

      // 2. TÃ¼m veriyi oku (tÃ¼m sÃ¼tunlar)
      const allData = this._readAllData(sheet);
      
      if (allData.length === 0) {
        console.warn('âš ï¸ PortfÃ¶y sheet\'inde veri yok');
        return [];
      }

      // 3. Veriyi CONFIG.COLUMNS yapÄ±sÄ±na gÃ¶re objelere dÃ¶nÃ¼ÅŸtÃ¼r
      const portfolio = this._convertToObjects(allData);
      
      // 4. Cache'e kaydet
      this._cache.portfolio = portfolio;
      this._cache.lastFetchPortfolio = new Date();
      
      console.log(`âœ… ${portfolio.length} portfÃ¶y kaydÄ± okundu ve cache'lendi`);
      return portfolio;
      
    } catch (error) {
      console.error('âŒ PortfÃ¶y okuma hatasÄ±:', error);
      return [];
    }
  },

  /**
   * Cache'i temizle
   */
  clearCache() {
    this._cache = {
      portfolio: null,
      historicalSTOCK: null,
      historicalCURRENCY: null,
      historicalGOLD: null,
      lastFetchPortfolio: null,
      lastFetchSTOCK: null,
      lastFetchCURRENCY: null,
      lastFetchGOLD: null,
      CACHE_DURATION: 5 * 60 * 1000,
    };
    console.log('ğŸ—‘ï¸ DataReader cache temizlendi');
  },

  // ==================== GEÃ‡MÄ°Å FÄ°YAT VERÄ°LERÄ° OKUMA ====================

  /**
   * Hisse geÃ§miÅŸ fiyatlarÄ±nÄ± oku
   */
  readHistoricalStockPrices(forceRefresh = false) {
    return this._readHistoricalData('HISSE_GECMIS_GUNLUK', 'STOCK', forceRefresh);
  },

  /**
   * DÃ¶viz geÃ§miÅŸ fiyatlarÄ±nÄ± oku
   */
  readHistoricalCurrencyPrices(forceRefresh = false) {
    return this._readHistoricalData('DOVIZ_GECMIS_GUNLUK', 'CURRENCY', forceRefresh);
  },

  /**
   * AltÄ±n geÃ§miÅŸ fiyatlarÄ±nÄ± oku
   */
  readHistoricalGoldPrices(forceRefresh = false) {
    return this._readHistoricalData('ALTIN_GECMIS_GUNLUK', 'GOLD', forceRefresh);
  },

  /**
   * Genel geÃ§miÅŸ veri okuma fonksiyonu
   */
  _readHistoricalData(sheetType, dataType, forceRefresh = false) {
    console.log(`ğŸ“Š DataReader: ${sheetType} geÃ§miÅŸ verileri okunuyor...`);
    
    // Cache kontrolÃ¼
    const cacheKey = `historical${dataType}`;
    if (!forceRefresh && this._cache[cacheKey] && this._cache[`lastFetch${dataType}`]) {
      const age = new Date().getTime() - this._cache[`lastFetch${dataType}`].getTime();
      if (age < this._cache.CACHE_DURATION) {
        console.log(`ğŸ’¾ ${sheetType} cache'den dÃ¶ndÃ¼rÃ¼lÃ¼yor`);
        return this._cache[cacheKey];
      }
    }
    
    try {
      const sheet = this._getHistoricalSheet(sheetType);
      if (!sheet) {
        console.error(`âŒ ${sheetType} sheet'i bulunamadÄ±`);
        return [];
      }

      // Veriyi oku
      const data = this._readHistoricalSheetData(sheet, sheetType);
      
      if (data.length === 0) {
        console.warn(`âš ï¸ ${sheetType} sheet'inde veri yok`);
        return [];
      }

      // Veriyi objelere dÃ¶nÃ¼ÅŸtÃ¼r
      const historicalData = this._convertHistoricalData(data, dataType);
      
      // Cache'e kaydet
      this._cache[cacheKey] = historicalData;
      this._cache[`lastFetch${dataType}`] = new Date();
      
      console.log(`âœ… ${historicalData.length} ${sheetType} kaydÄ± okundu ve cache'lendi`);
      return historicalData;
      
    } catch (error) {
      console.error(`âŒ ${sheetType} okuma hatasÄ±:`, error);
      return [];
    }
  },

  /**
   * GeÃ§miÅŸ veri sheet'ini getir
   */
  _getHistoricalSheet(sheetType) {
    try {
      const sheetConfig = CONFIG.SHEETS[sheetType];
      if (!sheetConfig) {
        console.error(`âŒ ${sheetType} konfigÃ¼rasyonu bulunamadÄ±`);
        return null;
      }
      
      // PortfÃ¶yle aynÄ± spreadsheet'i kullan
      const ss = SpreadsheetApp.openById(CONFIG.SHEETS.PORTFOY.ID);
      const sheet = ss.getSheetByName(sheetConfig.NAME);
      
      if (!sheet) {
        console.error(`âŒ Sheet "${sheetConfig.NAME}" bulunamadÄ±`);
        return null;
      }
      
      return sheet;
    } catch (error) {
      console.error(`âŒ Sheet aÃ§ma hatasÄ± (${sheetType}):`, error);
      return null;
    }
  },

  /**
   * Sheet'ten veriyi oku
   */
  _readHistoricalSheetData(sheet, sheetType) {
    try {
      const config = CONFIG.SHEETS[sheetType];
      
      // Son satÄ±r ve sÃ¼tun sayÄ±sÄ±nÄ± al
      const lastRow = sheet.getLastRow();
      const lastCol = sheet.getLastColumn();
      
      console.log(`   ğŸ“Š Sheet boyutu: ${lastRow} satÄ±r, ${lastCol} sÃ¼tun`);
      
      if (lastRow < config.FIRST_DATA_ROW) {
        return [];
      }
      
      // Okunacak satÄ±r sayÄ±sÄ±
      const startRow = config.FIRST_DATA_ROW;
      const numRows = lastRow - startRow + 1;
      
      console.log(`   ğŸ“– Okuma aralÄ±ÄŸÄ±: ${startRow}.satÄ±rdan ${numRows} satÄ±r, ${lastCol} sÃ¼tun`);
      
      const range = sheet.getRange(startRow, 1, numRows, lastCol);
      const data = range.getValues();
      
      console.log(`   ğŸ“¦ ${data.length} satÄ±r veri okundu`);
      return data;
      
    } catch (error) {
      console.error('âŒ GeÃ§miÅŸ veri okuma hatasÄ±:', error);
      return [];
    }
  },

  /**
   * GeÃ§miÅŸ veriyi objelere dÃ¶nÃ¼ÅŸtÃ¼r
   */
  _convertHistoricalData(data, dataType) {
    console.log(`   ğŸ”„ ${dataType} verisi object'lere dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼yor...`);
    
    // Sheet tipini belirle
    let sheetType, columnConfig;
    switch (dataType) {
      case 'STOCK':
        sheetType = 'HISSE_GECMIS_GUNLUK';
        columnConfig = CONFIG.SHEETS[sheetType].COLUMNS;
        break;
      case 'CURRENCY':
        sheetType = 'DOVIZ_GECMIS_GUNLUK';
        columnConfig = CONFIG.SHEETS[sheetType].COLUMNS;
        break;
      case 'GOLD':
        sheetType = 'ALTIN_GECMIS_GUNLUK';
        columnConfig = CONFIG.SHEETS[sheetType].COLUMNS;
        break;
      default:
        console.error(`âŒ Bilinmeyen dataType: ${dataType}`);
        return [];
    }
    
    return data.map((row, rowIndex) => {
      try {
        // Ä°lk sÃ¼tun (sembol/tÃ¼r) boÅŸsa atla
        const firstCol = columnConfig.SYMBOL !== undefined ? columnConfig.SYMBOL : columnConfig.TYPE;
        if (firstCol >= row.length || !row[firstCol]) {
          return null;
        }
        
        // Temel obje oluÅŸtur
        const obj = {
          // Sembol veya TÃ¼r
          symbol: dataType === 'GOLD' ? this._getValue(row, columnConfig.TYPE) : this._getValue(row, columnConfig.SYMBOL),
          
          // Tarih
          date: this._parseDate(this._getValue(row, columnConfig.DATE)),
          
          // Fiyat bilgileri
          open: this._getNumericValue(row, columnConfig.OPEN),
          high: this._getNumericValue(row, columnConfig.HIGH),
          low: this._getNumericValue(row, columnConfig.LOW),
          close: this._getNumericValue(row, columnConfig.CLOSE), // GÃ¼ncel fiyat
          
          // Asset tipi
          type: dataType,
          
          // Meta bilgiler
          __rawRow: row,
          __rowNumber: CONFIG.SHEETS[sheetType].FIRST_DATA_ROW + rowIndex
        };
        
        // Hacim (sadece hisse ve altÄ±n iÃ§in)
        if (dataType !== 'CURRENCY') {
          obj.volume = this._getNumericValue(row, columnConfig.VOLUME);
        }
        
        // Kaynak bilgisi
        if (dataType === 'CURRENCY') {
          // DÃ¶viz iÃ§in: kaynak ve zaman damgasÄ±
          const sourceField = this._getValue(row, columnConfig.SOURCE);
          obj.source = sourceField;
          
          // Zaman damgasÄ± varsa ekle
          if (columnConfig.TIMESTAMP !== undefined) {
            obj.timestamp = this._parseDate(this._getValue(row, columnConfig.TIMESTAMP));
          }
        } else {
          // Hisse ve altÄ±n iÃ§in kaynak
          obj.source = this._getValue(row, columnConfig.SOURCE);
        }
        
        return obj;
        
      } catch (error) {
        console.error(`âŒ ${dataType} satÄ±r ${rowIndex + 1} dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼rken hata:`, error);
        return null;
      }
    }).filter(item => item !== null);
  },

  // ==================== FÄ°YAT SORGULAMA FONKSÄ°YONLARI ====================

  /**
   * Bir varlÄ±ÄŸÄ±n gÃ¼ncel fiyatÄ±nÄ± getir
   */
  getCurrentPrice(symbol, assetType) {
    let historicalData;
    
    switch (assetType) {
      case 'STOCK':
        historicalData = this.readHistoricalStockPrices();
        break;
      case 'CURRENCY':
        historicalData = this.readHistoricalCurrencyPrices();
        break;
      case 'GOLD':
        historicalData = this.readHistoricalGoldPrices();
        break;
      default:
        console.error(`âŒ GeÃ§ersiz asset type: ${assetType}`);
        return null;
    }
    
    if (historicalData.length === 0) {
      console.warn(`âš ï¸ ${assetType} verisi boÅŸ`);
      return null;
    }
    
    // Sembole gÃ¶re filtrele (bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf duyarsÄ±z)
    const assetRecords = historicalData.filter(item => {
      if (!item || !item.symbol) return false;
      
      const itemSymbol = item.symbol.toString().trim().toLowerCase();
      const searchSymbol = symbol.toString().trim().toLowerCase();
      
      return itemSymbol === searchSymbol;
    });
    
    if (assetRecords.length === 0) {
      // Alternatif sembol arama
      console.log(`ğŸ” "${symbol}" iÃ§in alternatif arama yapÄ±lÄ±yor...`);
      
      // Dolar iÃ§in alternatifler
      if (symbol === 'USD' || symbol === 'USD/TRY') {
        const usdRecords = historicalData.filter(item => 
          item.symbol && item.symbol.toString().toLowerCase().includes('usd')
        );
        if (usdRecords.length > 0) {
          return this._getLatestRecord(usdRecords);
        }
      }
      
      // Euro iÃ§in alternatifler
      if (symbol === 'EUR' || symbol === 'EUR/TRY') {
        const eurRecords = historicalData.filter(item => 
          item.symbol && item.symbol.toString().toLowerCase().includes('eur')
        );
        if (eurRecords.length > 0) {
          return this._getLatestRecord(eurRecords);
        }
      }
      
      console.warn(`âš ï¸ "${symbol}" ${assetType} verisinde bulunamadÄ±`);
      return null;
    }
    
    return this._getLatestRecord(assetRecords);
  },

  /**
   * KayÄ±tlardan en gÃ¼ncel olanÄ± getir
   */
  _getLatestRecord(records) {
    if (!records || records.length === 0) {
      return null;
    }
    
    // Tarihe gÃ¶re sÄ±rala (en yeni en baÅŸta)
    const sorted = [...records].sort((a, b) => {
      const dateA = a.date ? new Date(a.date).getTime() : 0;
      const dateB = b.date ? new Date(b.date).getTime() : 0;
      return dateB - dateA;
    });
    
    const latest = sorted[0];
    
    return {
      price: latest.close,
      date: latest.date,
      source: latest.source || 'Unknown',
      symbol: latest.symbol,
      type: latest.type
    };
  },

  /**
   * Dolar fiyatÄ±nÄ± getir
   */
  getDolarPrice() {
    return this.getCurrentPrice('USDTRY=X', 'CURRENCY') || 
           this.getCurrentPrice('USD', 'CURRENCY');
  },

  /**
   * Euro fiyatÄ±nÄ± getir
   */
  getEuroPrice() {
    return this.getCurrentPrice('EURTRY=X', 'CURRENCY') || 
           this.getCurrentPrice('EUR', 'CURRENCY');
  },

  /**
   * Gram altÄ±n fiyatÄ±nÄ± getir
   */
  getGramAltinPrice() {
    return this.getCurrentPrice('gram-altin', 'GOLD');
  },

  /**
   * Ons altÄ±n fiyatÄ±nÄ± getir
   */
  getOnsAltinPrice() {
    return this.getCurrentPrice('ons', 'GOLD');
  },

  /**
   * PortfÃ¶ydeki bir varlÄ±ÄŸÄ±n fiyatÄ±nÄ± getir
   */
  getPortfolioItemPrice(item) {
    if (!item) return null;
    
    const { kategori, birimi, baslik } = item;
    
    // Kategoriye gÃ¶re asset type belirle
    if (kategori && kategori.includes('Borsa')) {
      return this.getCurrentPrice(baslik, 'STOCK');
    }
    else if (kategori === 'DÃ¶viz' || birimi === 'USD' || birimi === 'EUR') {
      const symbol = birimi === 'USD' ? 'USDTRY=X' : 
                     birimi === 'EUR' ? 'EURTRY=X' : birimi;
      return this.getCurrentPrice(symbol, 'CURRENCY');
    }
    else if (kategori && (kategori.includes('AltÄ±n') || kategori.includes('GÃ¼mÃ¼ÅŸ'))) {
      // BaÅŸlÄ±ktan altÄ±n tÃ¼rÃ¼nÃ¼ tahmin et
      const baslikLower = baslik.toLowerCase();
      let goldType;
      
      if (baslikLower.includes('gram')) goldType = 'gram-altin';
      else if (baslikLower.includes('ons')) goldType = 'ons';
      else if (baslikLower.includes('Ã§eyrek') || baslikLower.includes('ceyrek')) goldType = 'ceyrek-altin';
      else if (baslikLower.includes('yarÄ±m') || baslikLower.includes('yarim')) goldType = 'yarim-altin';
      else if (baslikLower.includes('tam')) goldType = 'tam-altin';
      else goldType = baslikLower;
      
      return this.getCurrentPrice(goldType, 'GOLD');
    }
    
    console.warn(`âš ï¸ Bilinmeyen kategori: ${kategori}`);
    return null;
  },

  /**
   * TÃ¼m Ã¶nemli fiyatlarÄ± getir
   */
  getAllImportantPrices() {
    return {
      dolar: this.getDolarPrice(),
      euro: this.getEuroPrice(),
      gramAltin: this.getGramAltinPrice(),
      onsAltin: this.getOnsAltinPrice(),
      timestamp: new Date()
    };
  },

  // ==================== DEBUG FONKSÄ°YONLARI ====================

  /**
   * GeÃ§miÅŸ veri yapÄ±sÄ±nÄ± debug et
   */
  debugHistoricalData() {
    console.log('ğŸ” DATA READER GEÃ‡MÄ°Å VERÄ° DEBUG');
    console.log('='.repeat(80));
    
    try {
      // Hisse verisi
      console.log('\nğŸ“ˆ HÄ°SSE VERÄ°SÄ°:');
      const stocks = this.readHistoricalStockPrices();
      console.log(`   Toplam kayÄ±t: ${stocks.length}`);
      
      if (stocks.length > 0) {
        const uniqueSymbols = [...new Set(stocks.map(item => item.symbol))];
        console.log(`   Benzersiz hisse sayÄ±sÄ±: ${uniqueSymbols.length}`);
        
        // Ä°lk 3 hisse iÃ§in gÃ¼ncel fiyat
        uniqueSymbols.slice(0, 3).forEach(symbol => {
          const price = this.getCurrentPrice(symbol, 'STOCK');
          if (price) {
            const dateStr = price.date ? 
              Utilities.formatDate(price.date, 'GMT', 'dd.MM.yyyy') : 'Tarih yok';
            console.log(`   ${symbol}: ${price.price} (${dateStr})`);
          }
        });
      }
      
      // DÃ¶viz verisi
      console.log('\nğŸ’± DÃ–VÄ°Z VERÄ°SÄ°:');
      const currencies = this.readHistoricalCurrencyPrices();
      console.log(`   Toplam kayÄ±t: ${currencies.length}`);
      
      // Ã–nemli dÃ¶vizler
      const importantCurrencies = ['USDTRY=X', 'EURTRY=X'];
      importantCurrencies.forEach(symbol => {
        const price = this.getCurrentPrice(symbol, 'CURRENCY');
        if (price) {
          const dateStr = price.date ? 
            Utilities.formatDate(price.date, 'GMT', 'dd.MM.yyyy') : 'Tarih yok';
          console.log(`   ${symbol}: ${price.price} (${dateStr})`);
        }
      });
      
      // AltÄ±n verisi
      console.log('\nğŸ… ALTIN VERÄ°SÄ°:');
      const golds = this.readHistoricalGoldPrices();
      console.log(`   Toplam kayÄ±t: ${golds.length}`);
      
      // Ã–nemli altÄ±n tÃ¼rleri
      const importantGolds = ['gram-altin', 'ons'];
      importantGolds.forEach(symbol => {
        const price = this.getCurrentPrice(symbol, 'GOLD');
        if (price) {
          const dateStr = price.date ? 
            Utilities.formatDate(price.date, 'GMT', 'dd.MM.yyyy') : 'Tarih yok';
          console.log(`   ${symbol}: ${price.price} (${dateStr})`);
        }
      });
      
    } catch (error) {
      console.error('âŒ GeÃ§miÅŸ veri debug hatasÄ±:', error);
    }
    
    console.log('\n' + '='.repeat(80));
  },

  /**
   * TÃ¼m verileri debug et
   */
  debugAllData() {
    console.log('ğŸ” DATA READER TÃœM VERÄ° DEBUG');
    console.log('='.repeat(80));
    
    // PortfÃ¶y
    console.log('\nğŸ“– PORFÃ–Y VERÄ°SÄ°:');
    const portfolio = this.readPortfolio();
    console.log(`   Toplam: ${portfolio.length} kayÄ±t`);
    
    if (portfolio.length > 0) {
      console.log('   Ä°lk 3 kayÄ±t:');
      portfolio.slice(0, 3).forEach(item => {
        console.log(`   - ${item.baslik} (${item.kategori}): ${item.adet} adet`);
      });
    }
    
    // Hisse
    console.log('\nğŸ“ˆ HÄ°SSE GEÃ‡MÄ°Å VERÄ°SÄ°:');
    const stocks = this.readHistoricalStockPrices();
    console.log(`   Toplam: ${stocks.length} kayÄ±t`);
    
    if (stocks.length > 0) {
      const uniqueStocks = [...new Set(stocks.map(s => s.symbol))];
      console.log(`   Benzersiz hisse: ${uniqueStocks.length}`);
    }
    
    // DÃ¶viz
    console.log('\nğŸ’± DÃ–VÄ°Z GEÃ‡MÄ°Å VERÄ°SÄ°:');
    const currencies = this.readHistoricalCurrencyPrices();
    console.log(`   Toplam: ${currencies.length} kayÄ±t`);
    
    if (currencies.length > 0) {
      const uniqueCurrencies = [...new Set(currencies.map(c => c.symbol))];
      console.log(`   Benzersiz dÃ¶viz: ${uniqueCurrencies.length}`);
    }
    
    // AltÄ±n
    console.log('\nğŸ… ALTIN GEÃ‡MÄ°Å VERÄ°SÄ°:');
    const golds = this.readHistoricalGoldPrices();
    console.log(`   Toplam: ${golds.length} kayÄ±t`);
    
    if (golds.length > 0) {
      const uniqueGolds = [...new Set(golds.map(g => g.symbol))];
      console.log(`   Benzersiz altÄ±n tÃ¼rÃ¼: ${uniqueGolds.length}`);
    }
    
    console.log('\n' + '='.repeat(80));
  },

  // ==================== MEVCUT YARDIMCI FONKSÄ°YONLAR ====================

  /**
   * PortfÃ¶y sheet'ini bul ve dÃ¶ndÃ¼r
   */
  _getPortfolioSheet() {
    try {
      const sheetConfig = CONFIG.SHEETS.PORTFOY;
      
      // Spesifik sheet ID varsa onu kullan, yoksa aktif spreadsheet'i
      let ss;
      if (sheetConfig.ID) {
        ss = SpreadsheetApp.openById(sheetConfig.ID);
      } else {
        ss = SpreadsheetApp.getActiveSpreadsheet();
      }
      
      const sheet = ss.getSheetByName(sheetConfig.NAME);
      
      if (!sheet) {
        console.error(`âŒ Sheet "${sheetConfig.NAME}" bulunamadÄ±`);
        console.log(`â„¹ï¸ Mevcut sheet'ler:`, ss.getSheets().map(s => s.getName()));
      }
      
      return sheet;
    } catch (error) {
      console.error('âŒ Sheet aÃ§ma hatasÄ±:', error);
      return null;
    }
  },

  /**
   * Sheet'ten tÃ¼m veriyi oku (tÃ¼m sÃ¼tunlar)
   */
  _readAllData(sheet) {
    try {
      const config = CONFIG.SHEETS.PORTFOY;
      
      // Son satÄ±r ve sÃ¼tun sayÄ±sÄ±nÄ± al
      const lastRow = sheet.getLastRow();
      const lastCol = sheet.getLastColumn();
      
      console.log(`ğŸ“Š Sheet boyutu: ${lastRow} satÄ±r, ${lastCol} sÃ¼tun`);
      
      if (lastRow <= 1) {
        return [];
      }
      
      // CONFIG'teki tÃ¼m sÃ¼tunlarÄ± kapsayacak ÅŸekilde oku
      // CONFIG.COLUMNS'taki maksimum sÃ¼tun indeksini bul
      const maxConfigCol = Math.max(...Object.values(CONFIG.COLUMNS));
      
      // Okunacak sÃ¼tun sayÄ±sÄ±: sheet'teki sÃ¼tun sayÄ±sÄ± ve CONFIG gereksinimi arasÄ±nda maksimum
      const numCols = Math.max(lastCol, maxConfigCol + 1);
      
      // CONFIG'te belirtilen ilk veri satÄ±rÄ±ndan baÅŸlayarak oku
      const startRow = config.FIRST_DATA_ROW;
      const numRows = lastRow - startRow + 1;
      
      console.log(`ğŸ“– Okuma aralÄ±ÄŸÄ±: ${startRow}.satÄ±rdan ${numRows} satÄ±r, ${numCols} sÃ¼tun`);
      console.log(`âš™ï¸ CONFIG gereksinimi: ${maxConfigCol + 1} sÃ¼tun`);
      
      const range = sheet.getRange(startRow, 1, numRows, numCols);
      const data = range.getValues();
      
      console.log(`ğŸ“¦ ${data.length} satÄ±r veri okundu (her satÄ±r ${data[0]?.length || 0} sÃ¼tun)`);
      return data;
      
    } catch (error) {
      console.error('âŒ Veri okuma hatasÄ±:', error);
      return [];
    }
  },

  /**
   * Ham veriyi CONFIG.COLUMNS yapÄ±sÄ±na gÃ¶re objelere dÃ¶nÃ¼ÅŸtÃ¼r (TÃœM SÃœTUNLAR)
   */
  _convertToObjects(data) {
    console.log('ğŸ”„ Ham veri object\'lere dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼yor...');
    
    return data.map((row, rowIndex) => {
      try {
        // TÃ¼m CONFIG.COLUMNS alanlarÄ±nÄ± oku
        const obj = {
          // Ham veriyi koru (debug iÃ§in)
          __rawRow: row,
          __rowNumber: CONFIG.SHEETS.PORTFOY.FIRST_DATA_ROW + rowIndex,
          
          // ==================== TEMEL BÄ°LGÄ°LER ====================
          id: this._getValue(row, CONFIG.COLUMNS.ID),
          tarih: this._parseDate(this._getValue(row, CONFIG.COLUMNS.TARIH)),
          islemTuru: this._getValue(row, CONFIG.COLUMNS.ISLEM_TURU),
          birimi: this._getValue(row, CONFIG.COLUMNS.BIRIMI),
          birimFiyat: this._getNumericValue(row, CONFIG.COLUMNS.BIRIM_FIYAT),
          baslik: this._getValue(row, CONFIG.COLUMNS.BASLIK),
          adet: this._getNumericValue(row, CONFIG.COLUMNS.ADET),
          kategori: this._getValue(row, CONFIG.COLUMNS.KATEGORI),
          platform: this._getValue(row, CONFIG.COLUMNS.PLATFORM),
          detaylar: this._getValue(row, CONFIG.COLUMNS.DETAYLAR),

          // ==================== YATIRILAN DEÄERLER ====================
          yatirilanTutar: this._getNumericValue(row, CONFIG.COLUMNS.YATIRILAN_TUTAR),
          yatirilanTL: this._getNumericValue(row, CONFIG.COLUMNS.YATIRILAN_TL),
          yatirilanUSD: this._getNumericValue(row, CONFIG.COLUMNS.YATIRILAN_USD),
          yatirilanEUR: this._getNumericValue(row, CONFIG.COLUMNS.YATIRILAN_EUR),
          yatirilanAltin: this._getNumericValue(row, CONFIG.COLUMNS.YATIRILAN_ALTIN),

          // ==================== GÃœNCEL DEÄERLER ====================
          guncelTutar: this._getNumericValue(row, CONFIG.COLUMNS.GUNCEL_TUTAR),
          guncelTL: this._getNumericValue(row, CONFIG.COLUMNS.GUNCEL_TL),
          guncelUSD: this._getNumericValue(row, CONFIG.COLUMNS.GUNCEL_USD),
          guncelEUR: this._getNumericValue(row, CONFIG.COLUMNS.GUNCEL_EUR),
          guncelAltin: this._getNumericValue(row, CONFIG.COLUMNS.GUNCEL_ALTIN),

          // ==================== KAR / ZARAR ====================
          karZararTutar: this._getNumericValue(row, CONFIG.COLUMNS.KAR_ZARAR_TUTAR),
          karZararTL: this._getNumericValue(row, CONFIG.COLUMNS.KAR_ZARAR_TL),
          karZararUSD: this._getNumericValue(row, CONFIG.COLUMNS.KAR_ZARAR_USD),
          karZararEUR: this._getNumericValue(row, CONFIG.COLUMNS.KAR_ZARAR_EUR),
          karZararYuzde: this._getNumericValue(row, CONFIG.COLUMNS.KAR_ZARAR_YUZDE),
          karZararAltin: this._getNumericValue(row, CONFIG.COLUMNS.KAR_ZARAR_ALTIN),

          // ==================== DURUM / GÃœNCELLEME ====================
          fiyatGuncelleme: this._parseDate(this._getValue(row, CONFIG.COLUMNS.FIYAT_GUNCELLEME)),
          durum: this._getValue(row, CONFIG.COLUMNS.DURUM),
          gunlukDegisim: this._getNumericValue(row, CONFIG.COLUMNS.GUNLUK_DEGISIM),
          gunlukDegisimTL: this._getNumericValue(row, CONFIG.COLUMNS.GUNLUK_DEGISIM_TL),

          // ==================== PORTFÃ–Y AÄIRLIK ====================
          portfoyAgirlik: this._getNumericValue(row, CONFIG.COLUMNS.PORTFOY_AGIRLIK),
          kategoriAgirlik: this._getNumericValue(row, CONFIG.COLUMNS.KATEGORI_AGIRLIK),

          // ==================== MALÄ°YET / GETÄ°RÄ° ====================
          ortalamaMaliyet: this._getNumericValue(row, CONFIG.COLUMNS.ORTALAMA_MALIYET),
          tutulmaSuresi: this._getNumericValue(row, CONFIG.COLUMNS.TUTULMA_SURESI),
          getiriYillik: this._getNumericValue(row, CONFIG.COLUMNS.GETIRI_YILLIK),

          // ==================== TEKNÄ°K ANALÄ°Z ====================
          rsi14: this._getNumericValue(row, CONFIG.COLUMNS.RSI_14),
          movingAverage50: this._getNumericValue(row, CONFIG.COLUMNS.MOVING_AVERAGE_50),

          // ==================== ALARM ====================
          alarmSeviyesi: this._getValue(row, CONFIG.COLUMNS.ALARM_SEVIYESI),
          hedefFiyat: this._getNumericValue(row, CONFIG.COLUMNS.HEDEF_FIYAT),
          stopLoss: this._getNumericValue(row, CONFIG.COLUMNS.STOP_LOSS),

          // ==================== METADATA ====================
          notlar: this._getValue(row, CONFIG.COLUMNS.NOTLAR),
          etiketler: this._getValue(row, CONFIG.COLUMNS.ETIKETLER),
          hesaplamaTarihi: this._parseDate(this._getValue(row, CONFIG.COLUMNS.HESAPLAMA_TARIHI)),
          veriKaynagi: this._getValue(row, CONFIG.COLUMNS.VERI_KAYNAGI),
        };

        // BoÅŸ satÄ±rlarÄ± filtrele (tÃ¼m alanlar boÅŸsa)
        const isEmpty = Object.values(obj).every(value => 
          value === undefined || value === null || value === '' || 
          (typeof value === 'number' && isNaN(value)) ||
          value === obj.__rawRow || value === obj.__rowNumber // Ã–zel alanlarÄ± hariÃ§ tut
        );

        return isEmpty ? null : obj;

      } catch (error) {
        console.error(`âŒ SatÄ±r ${rowIndex + 1} dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼rken hata:`, error);
        return null;
      }
    }).filter(item => item !== null); // null'larÄ± filtrele
  },

  /**
   * SatÄ±rdan deÄŸer al (gÃ¼venli)
   */
  _getValue(row, index) {
    if (!row || index < 0 || index >= row.length) {
      return '';
    }
    
    const value = row[index];
    
    // Null/undefined kontrolÃ¼
    if (value === null || value === undefined) {
      return '';
    }
    
    // String'e Ã§evir ve trim yap
    return value.toString().trim();
  },

 _getNumericValue(row, index) {
  const value = this._getValue(row, index);
  
  if (value === '') return 0;
  if (typeof value === 'number') return value;
  
  const str = value.toString().trim();
  
  // DEBUG: Hangi string geliyor gÃ¶relim
  console.log(`ğŸ”¢ DÃ¶nÃ¼ÅŸtÃ¼rÃ¼len string: "${str}"`);
  
  // 1. BoÅŸluklarÄ± temizle
  let cleanStr = str.replace(/\s/g, '');
  
  // 2. TÃœRKÃ‡E FORMAT: "1.234,56" veya "5.080,33"
  if (/^\d{1,3}(\.\d{3})*(,\d+)?$/.test(cleanStr)) {
    // Binlik ayraÃ§larÄ± (nokta) kaldÄ±r, ondalÄ±k ayracÄ±nÄ± (virgÃ¼l) noktaya Ã§evir
    cleanStr = cleanStr.replace(/\./g, '').replace(',', '.');
    const num = parseFloat(cleanStr);
    console.log(`   TÃ¼rkÃ§e format -> "${str}" -> "${cleanStr}" -> ${num}`);
    return isNaN(num) ? 0 : num;
  }
  
  // 3. Ä°NGÄ°LÄ°ZCE FORMAT: "1,234.56" veya "30.67"
  if (/^\d{1,3}(,\d{3})*(\.\d+)?$/.test(cleanStr)) {
    // Binlik ayraÃ§larÄ± (virgÃ¼l) kaldÄ±r
    cleanStr = cleanStr.replace(/,/g, '');
    const num = parseFloat(cleanStr);
    console.log(`   Ä°ngilizce format -> "${str}" -> "${cleanStr}" -> ${num}`);
    return isNaN(num) ? 0 : num;
  }
  
  // 4. BASÄ°T ONDALIK: "30,67" veya "12,89"
  if (/^\d+,\d+$/.test(cleanStr)) {
    cleanStr = cleanStr.replace(',', '.');
    const num = parseFloat(cleanStr);
    console.log(`   Basit ondalÄ±k -> "${str}" -> "${cleanStr}" -> ${num}`);
    return isNaN(num) ? 0 : num;
  }
  
  // 5. TAM SAYI: "1244"
  if (/^\d+$/.test(cleanStr)) {
    const num = parseFloat(cleanStr);
    console.log(`   Tam sayÄ± -> "${str}" -> ${num}`);
    return isNaN(num) ? 0 : num;
  }
  
  console.warn(`âš ï¸ SayÄ±ya Ã§evrilemedi: "${str}"`);
  return 0;
 },

  /**
   * Tarihi parse et
   */
  _parseDate(input) {
    if (!input) {
      return null;
    }
    
    // Zaten Date objesiyse
    if (input instanceof Date) {
      // GeÃ§erli bir tarih mi?
      if (isNaN(input.getTime())) {
        return null;
      }
      return input;
    }
    
    const str = input.toString().trim();
    
    // BoÅŸsa null dÃ¶ndÃ¼r
    if (str === '') {
      return null;
    }
    
    try {
      // "DD.MM.YYYY" formatÄ±
      const parts = str.split('.');
      if (parts.length === 3) {
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1; // Ay 0'dan baÅŸlar
        const year = parseInt(parts[2], 10);
        
        if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
          const fullYear = year < 100 ? 2000 + year : year;
          return new Date(fullYear, month, day);
        }
      }
      
      // "YYYY-MM-DD" formatÄ±
      const isoParts = str.split('-');
      if (isoParts.length === 3) {
        const year = parseInt(isoParts[0], 10);
        const month = parseInt(isoParts[1], 10) - 1;
        const day = parseInt(isoParts[2], 10);
        
        if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
          return new Date(year, month, day);
        }
      }
      
      // VarsayÄ±lan Date parser
      const date = new Date(str);
      
      // GeÃ§erli bir tarih mi?
      if (isNaN(date.getTime())) {
        console.warn(`âš ï¸ GeÃ§ersiz tarih formatÄ±: "${str}"`);
        return null;
      }
      
      return date;
      
    } catch (error) {
      console.error(`âŒ Tarih parse hatasÄ±: "${str}"`, error);
      return null;
    }
  },

  /**
   * Sheet'teki sÃ¼tun baÅŸlÄ±klarÄ±nÄ± getir (debug iÃ§in)
   */
  getColumnHeaders() {
    try {
      const sheet = this._getPortfolioSheet();
      if (!sheet) {
        return [];
      }
      
      // Ä°lk satÄ±rÄ± oku (baÅŸlÄ±klar)
      const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
      
      console.log('ğŸ“‹ SÃ¼tun baÅŸlÄ±klarÄ±:');
      headers.forEach((header, index) => {
        console.log(`  ${index}. ${header} -> CONFIG.COLUMNS'da: ${this._getConfigColumnName(index)}`);
      });
      
      return headers;
      
    } catch (error) {
      console.error('âŒ BaÅŸlÄ±k okuma hatasÄ±:', error);
      return [];
    }
  },

  /**
   * CONFIG.COLUMNS'tan sÃ¼tun adÄ±nÄ± bul
   */
  _getConfigColumnName(index) {
    for (const [key, value] of Object.entries(CONFIG.COLUMNS)) {
      if (value === index) {
        return key;
      }
    }
    return 'TANIMSIZ';
  },

  /**
   * Veri yapÄ±sÄ±nÄ± debug et (gÃ¼ncellenmiÅŸ versiyon)
   */
  debugDataStructure() {
    console.log('ğŸ” DATA STRUCTURE DEBUG (GÃœNCELLENMÄ°Å)');
    console.log('='.repeat(80));
    
    try {
      // 1. Cache durumu
      console.log('\nğŸ’¾ CACHE DURUMU:');
      console.log(`   Cache'de veri: ${this._cache.portfolio ? 'EVET' : 'HAYIR'}`);
      if (this._cache.lastFetchPortfolio) {
        const age = (new Date().getTime() - this._cache.lastFetchPortfolio.getTime()) / 1000;
        console.log(`   Son portfÃ¶y okuma: ${Math.floor(age)} saniye Ã¶nce`);
      }
      
      // 2. Sheet baÅŸlÄ±klarÄ±nÄ± gÃ¶ster
      console.log('\nğŸ“‹ SHEET BAÅLIKLARI:');
      const headers = this.getColumnHeaders();
      
      // 3. CONFIG.COLUMNS mapping'ini gÃ¶ster
      console.log('\nâš™ï¸ CONFIG.COLUMNS MAPPING (44 sÃ¼tun):');
      const columnEntries = Object.entries(CONFIG.COLUMNS);
      columnEntries.sort((a, b) => a[1] - b[1]);
      
      columnEntries.forEach(([key, index]) => {
        const headerName = headers[index] || 'BOÅ';
        console.log(`  ${index.toString().padStart(2)}. ${key.padEnd(25)} -> "${headerName}"`);
      });
      
      // 4. Ä°lk birkaÃ§ kaydÄ± gÃ¶ster
      console.log('\nğŸ“Š Ä°LK KAYIT (tÃ¼m alanlar):');
      const portfolio = this.readPortfolio();
      
      if (portfolio.length > 0) {
        const sample = portfolio[0];
        
        console.log('\n  TEMEL BÄ°LGÄ°LER:');
        console.log(`     ID: ${sample.id}`);
        console.log(`     Tarih: ${sample.tarih ? Utilities.formatDate(sample.tarih, 'GMT', 'dd.MM.yyyy') : 'BOÅ'}`);
        console.log(`     BaÅŸlÄ±k: ${sample.baslik}`);
        console.log(`     Kategori: ${sample.kategori}`);
        console.log(`     Ä°ÅŸlem TÃ¼rÃ¼: ${sample.islemTuru}`);
        console.log(`     Birim: ${sample.birimi}`);
        console.log(`     Adet: ${sample.adet}`);
        console.log(`     Birim Fiyat: ${sample.birimFiyat}`);
        console.log(`     Platform: ${sample.platform}`);
        
        console.log('\n  YATIRILAN DEÄERLER:');
        console.log(`     YatÄ±rÄ±lan Tutar: ${sample.yatirilanTutar}`);
        console.log(`     YatÄ±rÄ±lan TL: ${sample.yatirilanTL}`);
        console.log(`     YatÄ±rÄ±lan USD: ${sample.yatirilanUSD}`);
        
        console.log('\n  GÃœNCEL DEÄERLER:');
        console.log(`     GÃ¼ncel Tutar: ${sample.guncelTutar}`);
        console.log(`     GÃ¼ncel TL: ${sample.guncelTL}`);
        
        console.log('\n  KAR/ZARAR:');
        console.log(`     Kar/Zarar Tutar: ${sample.karZararTutar}`);
        console.log(`     Kar/Zarar %: ${sample.karZararYuzde}`);
        
        console.log(`\nğŸ“ˆ TOPLAM: ${portfolio.length} kayÄ±t okundu`);
        
        // 5. Kategori daÄŸÄ±lÄ±mÄ±
        console.log('\nğŸ“Š KATEGORÄ° DAÄILIMI:');
        const kategoriCounts = {};
        portfolio.forEach(item => {
          const kategori = item.kategori || 'BELÄ°RSÄ°Z';
          kategoriCounts[kategori] = (kategoriCounts[kategori] || 0) + 1;
        });
        
        Object.entries(kategoriCounts)
          .sort((a, b) => b[1] - a[1])
          .forEach(([kategori, count]) => {
            const percentage = ((count / portfolio.length) * 100).toFixed(1);
            console.log(`  ${kategori}: ${count} (%${percentage})`);
          });
          
      } else {
        console.log('â„¹ï¸ PortfÃ¶y boÅŸ');
      }
      
      // 6. GeÃ§miÅŸ veri durumu
      console.log('\nğŸ“Š GEÃ‡MÄ°Å VERÄ° DURUMU:');
      const stocks = this.readHistoricalStockPrices();
      const currencies = this.readHistoricalCurrencyPrices();
      const golds = this.readHistoricalGoldPrices();
      
      console.log(`   Hisse kayÄ±tlarÄ±: ${stocks.length}`);
      console.log(`   DÃ¶viz kayÄ±tlarÄ±: ${currencies.length}`);
      console.log(`   AltÄ±n kayÄ±tlarÄ±: ${golds.length}`);
      
      // 7. GÃ¼ncel fiyatlar
      console.log('\nğŸ’° GÃœNCEL FÄ°YATLAR:');
      const dolar = this.getDolarPrice();
      const gramAltin = this.getGramAltinPrice();
      
      if (dolar) {
        const dateStr = dolar.date ? Utilities.formatDate(dolar.date, 'GMT', 'dd.MM.yyyy') : '?';
        console.log(`   Dolar: ${dolar.price.toFixed(4)} TL (${dateStr})`);
      }
      
      if (gramAltin) {
        const dateStr = gramAltin.date ? Utilities.formatDate(gramAltin.date, 'GMT', 'dd.MM.yyyy') : '?';
        console.log(`   Gram AltÄ±n: ${gramAltin.price.toFixed(2)} TL (${dateStr})`);
      }
      
      console.log('\n' + '='.repeat(80));
      
    } catch (error) {
      console.error('âŒ Debug hatasÄ±:', error);
    }
  },

  /**
   * PortfÃ¶y verisini dÄ±ÅŸa aktar (baÅŸka dosyalar iÃ§in)
   */
  exportPortfolioData() {
    return this.readPortfolio();
  },

  /**
   * Belirli bir alanÄ±n deÄŸerlerini dÃ¶ndÃ¼r
   */
  getFieldValues(fieldName) {
    const portfolio = this.readPortfolio();
    return portfolio.map(item => item[fieldName]);
  },

  /**
   * Benzersiz deÄŸerleri dÃ¶ndÃ¼r
   */
  getUniqueValues(fieldName) {
    const values = this.getFieldValues(fieldName);
    return [...new Set(values.filter(val => val && val !== ''))];
  }
};
/**
 * ğŸ§ª DATA READER TAM TEST FONKSÄ°YONU (PORTFÃ–Y + GEÃ‡MÄ°Å FÄ°YATLAR)
 */
function test_DataReader_Complete() {
  console.log('ğŸ§ª DATA READER TAM TEST (PORTFÃ–Y + GEÃ‡MÄ°Å FÄ°YATLAR)');
  console.log('='.repeat(80));
  
  const startTime = new Date();
  
  try {
    // 1. CONFIG kontrolÃ¼
    console.log('\n1ï¸âƒ£ CONFIG KONTROLÃœ');
    console.log(`   Sheet ID: ${CONFIG.SHEETS.PORTFOY?.ID ? 'VAR' : 'YOK'}`);
    console.log(`   PortfÃ¶y Sheet: ${CONFIG.SHEETS.PORTFOY?.NAME || 'YOK'}`);
    console.log(`   Hisse Sheet: ${CONFIG.SHEETS.HISSE_GECMIS_GUNLUK?.NAME || 'YOK'}`);
    console.log(`   DÃ¶viz Sheet: ${CONFIG.SHEETS.DOVIZ_GECMIS_GUNLUK?.NAME || 'YOK'}`);
    console.log(`   AltÄ±n Sheet: ${CONFIG.SHEETS.ALTIN_GECMIS_GUNLUK?.NAME || 'YOK'}`);
    
    // 2. DataReader kontrolÃ¼
    console.log('\n2ï¸âƒ£ DATA READER KONTROLÃœ');
    if (typeof DataReader !== 'undefined') {
      console.log('   âœ… DataReader nesnesi mevcut');
    } else {
      console.log('   âŒ DataReader nesnesi tanÄ±mlÄ± deÄŸil');
      return;
    }
    
    // 3. PortfÃ¶y okuma testi
    console.log('\n3ï¸âƒ£ PORTFÃ–Y OKUMA TESTÄ°');
    const portfolioStart = new Date();
    const portfolio = DataReader.readPortfolio();
    const portfolioDuration = new Date() - portfolioStart;
    
    console.log(`   âœ… ${portfolio.length} kayÄ±t okundu`);
    console.log(`   â±ï¸  SÃ¼re: ${portfolioDuration}ms`);
    
    if (portfolio.length > 0) {
      const sample = portfolio[0];
      console.log(`   ğŸ“Š Ã–rnek kayÄ±t: ${sample.baslik} (${sample.kategori}) - ${sample.adet} adet`);
      
      // PortfÃ¶y kategorilerini gÃ¶ster
      const categories = {};
      portfolio.forEach(item => {
        const cat = item.kategori || 'BELÄ°RSÄ°Z';
        categories[cat] = (categories[cat] || 0) + 1;
      });
      
      console.log(`   ğŸ“ˆ Kategori daÄŸÄ±lÄ±mÄ±:`);
      Object.entries(categories).forEach(([cat, count]) => {
        console.log(`      ${cat}: ${count} kayÄ±t`);
      });
    }
    
    // 4. GeÃ§miÅŸ veri okuma testi
    console.log('\n4ï¸âƒ£ GEÃ‡MÄ°Å VERÄ° OKUMA TESTÄ°');
    
    // Hisse
    console.log('   ğŸ“ˆ Hisse geÃ§miÅŸi okunuyor...');
    const stocksStart = new Date();
    const stocks = DataReader.readHistoricalStockPrices();
    const stocksDuration = new Date() - stocksStart;
    console.log(`      âœ… ${stocks.length} kayÄ±t (${stocksDuration}ms)`);
    
    if (stocks.length > 0) {
      const uniqueStocks = [...new Set(stocks.map(s => s.symbol))];
      console.log(`      ğŸ“Š ${uniqueStocks.length} benzersiz hisse`);
      
      if (uniqueStocks.length > 0) {
        console.log(`      Ã–rnek hisseler: ${uniqueStocks.slice(0, 3).join(', ')}`);
      }
    }
    
    // DÃ¶viz
    console.log('   ğŸ’± DÃ¶viz geÃ§miÅŸi okunuyor...');
    const currenciesStart = new Date();
    const currencies = DataReader.readHistoricalCurrencyPrices();
    const currenciesDuration = new Date() - currenciesStart;
    console.log(`      âœ… ${currencies.length} kayÄ±t (${currenciesDuration}ms)`);
    
    if (currencies.length > 0) {
      const uniqueCurrencies = [...new Set(currencies.map(c => c.symbol))];
      console.log(`      ğŸ“Š ${uniqueCurrencies.length} benzersiz dÃ¶viz`);
      
      if (uniqueCurrencies.length > 0) {
        console.log(`      Ã–rnek dÃ¶vizler: ${uniqueCurrencies.slice(0, 3).join(', ')}`);
      }
    }
    
    // AltÄ±n
    console.log('   ğŸ… AltÄ±n geÃ§miÅŸi okunuyor...');
    const goldStart = new Date();
    const golds = DataReader.readHistoricalGoldPrices();
    const goldDuration = new Date() - goldStart;
    console.log(`      âœ… ${golds.length} kayÄ±t (${goldDuration}ms)`);
    
    if (golds.length > 0) {
      const uniqueGolds = [...new Set(golds.map(g => g.symbol))];
      console.log(`      ğŸ“Š ${uniqueGolds.length} benzersiz altÄ±n tÃ¼rÃ¼`);
      
      if (uniqueGolds.length > 0) {
        console.log(`      Ã–rnek altÄ±nlar: ${uniqueGolds.slice(0, 5).join(', ')}`);
      }
    }
    
    // 5. GÃ¼ncel fiyat sorgulama testi
    console.log('\n5ï¸âƒ£ GÃœNCEL FÄ°YAT SORGULAMA TESTÄ°');
    
    // Dolar
    console.log('   ğŸ’µ Dolar fiyatÄ± sorgulanÄ±yor...');
    const dolarStart = new Date();
    const dolar = DataReader.getDolarPrice();
    const dolarDuration = new Date() - dolarStart;
    
    if (dolar) {
      const dateStr = dolar.date ? Utilities.formatDate(dolar.date, 'GMT', 'dd.MM.yyyy') : 'Tarih yok';
      console.log(`      âœ… USD/TRY: ${dolar.price.toFixed(4)} TL (${dateStr}) - ${dolarDuration}ms`);
    } else {
      console.log(`      âŒ Dolar fiyatÄ± bulunamadÄ±`);
    }
    
    // Gram altÄ±n
    console.log('   ğŸ… Gram altÄ±n fiyatÄ± sorgulanÄ±yor...');
    const altinStart = new Date();
    const gramAltin = DataReader.getGramAltinPrice();
    const altinDuration = new Date() - altinStart;
    
    if (gramAltin) {
      const dateStr = gramAltin.date ? Utilities.formatDate(gramAltin.date, 'GMT', 'dd.MM.yyyy') : 'Tarih yok';
      console.log(`      âœ… Gram AltÄ±n: ${gramAltin.price.toFixed(2)} TL (${dateStr}) - ${altinDuration}ms`);
    } else {
      console.log(`      âŒ Gram altÄ±n fiyatÄ± bulunamadÄ±`);
    }
    
    // 6. PortfÃ¶y varlÄ±ÄŸÄ± fiyat testi
    console.log('\n6ï¸âƒ£ PORTFÃ–Y VARLIÄI FÄ°YAT TESTÄ°');
    
    if (portfolio.length > 0) {
      // Hisse Ã¶rneÄŸi
      const hisseItem = portfolio.find(item => item.kategori && item.kategori.includes('Borsa'));
      if (hisseItem) {
        console.log(`   ğŸ“ˆ Hisse testi: ${hisseItem.baslik}`);
        const hissePrice = DataReader.getPortfolioItemPrice(hisseItem);
        if (hissePrice) {
          console.log(`      âœ… Fiyat: ${hissePrice.price.toFixed(2)} TL`);
        } else {
          console.log(`      âŒ Fiyat bulunamadÄ±`);
        }
      }
      
      // DÃ¶viz Ã¶rneÄŸi
      const dovizItem = portfolio.find(item => item.kategori === 'DÃ¶viz' || item.birimi === 'USD' || item.birimi === 'EUR');
      if (dovizItem) {
        console.log(`   ğŸ’± DÃ¶viz testi: ${dovizItem.birim || dovizItem.baslik}`);
        const dovizPrice = DataReader.getPortfolioItemPrice(dovizItem);
        if (dovizPrice) {
          console.log(`      âœ… Fiyat: ${dovizPrice.price.toFixed(4)} TL`);
        } else {
          console.log(`      âŒ Fiyat bulunamadÄ±`);
        }
      }
      
      // AltÄ±n Ã¶rneÄŸi
      const altinItem = portfolio.find(item => item.kategori && item.kategori.includes('AltÄ±n'));
      if (altinItem) {
        console.log(`   ğŸ… AltÄ±n testi: ${altinItem.baslik}`);
        const altinPrice = DataReader.getPortfolioItemPrice(altinItem);
        if (altinPrice) {
          console.log(`      âœ… Fiyat: ${altinPrice.price.toFixed(2)} TL`);
        } else {
          console.log(`      âŒ Fiyat bulunamadÄ±`);
        }
      }
    }
    
    // 7. Cache testi
    console.log('\n7ï¸âƒ£ CACHE TESTÄ°');
    console.log('   Ä°kinci portfÃ¶y okumasÄ± (cache kullanmalÄ±):');
    const cacheStart = new Date();
    DataReader.readPortfolio();
    const cacheDuration = new Date() - cacheStart;
    console.log(`   âš¡ Cache okuma sÃ¼resi: ${cacheDuration}ms`);
    
    console.log('   Force refresh ile portfÃ¶y okumasÄ±:');
    const forceStart = new Date();
    DataReader.readPortfolio(true);
    const forceDuration = new Date() - forceStart;
    console.log(`   ğŸ”„ Force refresh sÃ¼resi: ${forceDuration}ms`);
    
    // 8. Debug Ã§Ä±ktÄ±larÄ±
    console.log('\n8ï¸âƒ£ DEBUG Ã‡IKTILARI');
    console.log('   DataReader.debugDataStructure() Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...');
    DataReader.debugDataStructure();
    
    // 9. TÃ¼m Ã¶nemli fiyatlar
    console.log('\n9ï¸âƒ£ TÃœM Ã–NEMLÄ° FÄ°YATLAR');
    const allPrices = DataReader.getAllImportantPrices();
    console.log(`   Dolar: ${allPrices.dolar?.price?.toFixed(4) || 'BulunamadÄ±'} TL`);
    console.log(`   Euro: ${allPrices.euro?.price?.toFixed(4) || 'BulunamadÄ±'} TL`);
    console.log(`   Gram AltÄ±n: ${allPrices.gramAltin?.price?.toFixed(2) || 'BulunamadÄ±'} TL`);
    console.log(`   Ons AltÄ±n: ${allPrices.onsAltin?.price?.toFixed(2) || 'BulunamadÄ±'} $`);
    
    // 10. Cache temizleme
    console.log('\nğŸ”Ÿ CACHE TEMÄ°ZLEME');
    DataReader.clearCache();
    console.log('   âœ… TÃ¼m cache\'ler temizlendi');
    
  } catch (error) {
    console.error('âŒ Test hatasÄ±:', error);
    console.error(error.stack);
  }
  
  const totalDuration = (new Date().getTime() - startTime.getTime()) / 1000;
  console.log('\n' + '='.repeat(80));
  console.log(`â±ï¸  Toplam sÃ¼re: ${totalDuration.toFixed(2)} saniye`);
  console.log('ğŸ‰ DATA READER TAM TEST TAMAMLANDI');
}

/**
 * ğŸš€ HIZLI TEST (BASÄ°T KONTROL)
 */
function test_DataReader_Quick() {
  console.log('âš¡ DATA READER HIZLI TEST');
  console.log('='.repeat(60));
  
  try {
    // 1. PortfÃ¶y
    console.log('\nğŸ“Š PORTFÃ–Y:');
    const portfolio = DataReader.readPortfolio();
    console.log(`   ${portfolio.length} kayÄ±t`);
    
    if (portfolio.length > 0) {
      console.log('   Ä°lk 3 kayÄ±t:');
      portfolio.slice(0, 3).forEach((item, i) => {
        console.log(`   ${i+1}. ${item.baslik} (${item.kategori}): ${item.adet} adet`);
      });
    }
    
    // 2. GeÃ§miÅŸ veriler
    console.log('\nğŸ“ˆ GEÃ‡MÄ°Å VERÄ°LER:');
    const stocks = DataReader.readHistoricalStockPrices();
    const currencies = DataReader.readHistoricalCurrencyPrices();
    const golds = DataReader.readHistoricalGoldPrices();
    
    console.log(`   Hisse: ${stocks.length} kayÄ±t`);
    console.log(`   DÃ¶viz: ${currencies.length} kayÄ±t`);
    console.log(`   AltÄ±n: ${golds.length} kayÄ±t`);
    
    // 3. GÃ¼ncel fiyatlar
    console.log('\nğŸ’° GÃœNCEL FÄ°YATLAR:');
    
    const dolar = DataReader.getDolarPrice();
    if (dolar) {
      const dateStr = dolar.date ? Utilities.formatDate(dolar.date, 'GMT', 'dd.MM.yyyy') : '?';
      console.log(`   ğŸ’µ Dolar: ${dolar.price.toFixed(4)} TL (${dateStr})`);
    }
    
    const gramAltin = DataReader.getGramAltinPrice();
    if (gramAltin) {
      const dateStr = gramAltin.date ? Utilities.formatDate(gramAltin.date, 'GMT', 'dd.MM.yyyy') : '?';
      console.log(`   ğŸ… Gram AltÄ±n: ${gramAltin.price.toFixed(2)} TL (${dateStr})`);
    }
    
    // 4. PortfÃ¶y varlÄ±ÄŸÄ± fiyatÄ±
    console.log('\nğŸ“Š PORTFÃ–Y VARLIÄI FÄ°YATI:');
    if (portfolio.length > 0) {
      const sampleItem = portfolio[0];
      const price = DataReader.getPortfolioItemPrice(sampleItem);
      if (price) {
        console.log(`   ${sampleItem.baslik}: ${price.price.toFixed(2)} TL`);
      }
    }
    
    // 5. Performans
    console.log('\nâš¡ PERFORMANS:');
    console.log('   Cache temizleniyor...');
    DataReader.clearCache();
    
    console.log('   Ä°lk okuma:');
    const start1 = new Date();
    DataReader.readPortfolio();
    const time1 = new Date() - start1;
    console.log(`      PortfÃ¶y: ${time1}ms`);
    
    console.log('   Ä°kinci okuma (cache):');
    const start2 = new Date();
    DataReader.readPortfolio();
    const time2 = new Date() - start2;
    console.log(`      PortfÃ¶y: ${time2}ms`);
    
  } catch (error) {
    console.error('âŒ HÄ±zlÄ± test hatasÄ±:', error);
  }
  
  console.log('\n' + '='.repeat(60));
  console.log('ğŸ‰ HIZLI TEST TAMAMLANDI');
}

/**
 * ğŸ“Š GEÃ‡MÄ°Å VERÄ° Ã–ZEL TESTÄ°
 */
function test_DataReader_Historical_Data() {
  console.log('ğŸ“Š DATA READER GEÃ‡MÄ°Å VERÄ° TESTÄ°');
  console.log('='.repeat(80));
  
  try {
    // 1. TÃ¼m geÃ§miÅŸ verileri oku
    console.log('\n1ï¸âƒ£ TÃœM GEÃ‡MÄ°Å VERÄ°LERÄ° OKUMA');
    
    const stocks = DataReader.readHistoricalStockPrices();
    const currencies = DataReader.readHistoricalCurrencyPrices();
    const golds = DataReader.readHistoricalGoldPrices();
    
    console.log(`   ğŸ“ˆ Hisse: ${stocks.length} kayÄ±t`);
    console.log(`   ğŸ’± DÃ¶viz: ${currencies.length} kayÄ±t`);
    console.log(`   ğŸ… AltÄ±n: ${golds.length} kayÄ±t`);
    
    // 2. Ã–rnek kayÄ±tlar gÃ¶ster
    console.log('\n2ï¸âƒ£ Ã–RNEK KAYITLAR');
    
    if (stocks.length > 0) {
      console.log('   ğŸ“ˆ Hisse Ã¶rneÄŸi:');
      const sampleStock = stocks[0];
      console.log(`      Sembol: ${sampleStock.symbol}`);
      console.log(`      Tarih: ${sampleStock.date ? Utilities.formatDate(sampleStock.date, 'GMT', 'dd.MM.yyyy') : '?'}`);
      console.log(`      KapanÄ±ÅŸ: ${sampleStock.close}`);
      console.log(`      Kaynak: ${sampleStock.source}`);
    }
    
    if (currencies.length > 0) {
      console.log('   ğŸ’± DÃ¶viz Ã¶rneÄŸi:');
      const sampleCurrency = currencies[0];
      console.log(`      Sembol: ${sampleCurrency.symbol}`);
      console.log(`      Tarih: ${sampleCurrency.date ? Utilities.formatDate(sampleCurrency.date, 'GMT', 'dd.MM.yyyy') : '?'}`);
      console.log(`      KapanÄ±ÅŸ: ${sampleCurrency.close}`);
      console.log(`      Kaynak: ${sampleCurrency.source}`);
    }
    
    if (golds.length > 0) {
      console.log('   ğŸ… AltÄ±n Ã¶rneÄŸi:');
      const sampleGold = golds[0];
      console.log(`      TÃ¼r: ${sampleGold.symbol}`);
      console.log(`      Tarih: ${sampleGold.date ? Utilities.formatDate(sampleGold.date, 'GMT', 'dd.MM.yyyy') : '?'}`);
      console.log(`      KapanÄ±ÅŸ: ${sampleGold.close}`);
      console.log(`      Kaynak: ${sampleGold.source}`);
    }
    
    // 3. Sembol listesi
    console.log('\n3ï¸âƒ£ SEMBOL LÄ°STESÄ°');
    
    if (stocks.length > 0) {
      const uniqueStocks = [...new Set(stocks.map(s => s.symbol))];
      console.log(`   ğŸ“ˆ ${uniqueStocks.length} benzersiz hisse`);
      if (uniqueStocks.length > 0) {
        console.log(`   Ä°lk 5: ${uniqueStocks.slice(0, 5).join(', ')}`);
      }
    }
    
    if (currencies.length > 0) {
      const uniqueCurrencies = [...new Set(currencies.map(c => c.symbol))];
      console.log(`   ğŸ’± ${uniqueCurrencies.length} benzersiz dÃ¶viz`);
      console.log(`   TÃ¼mÃ¼: ${uniqueCurrencies.join(', ')}`);
    }
    
    if (golds.length > 0) {
      const uniqueGolds = [...new Set(golds.map(g => g.symbol))];
      console.log(`   ğŸ… ${uniqueGolds.length} benzersiz altÄ±n tÃ¼rÃ¼`);
      console.log(`   TÃ¼mÃ¼: ${uniqueGolds.join(', ')}`);
    }
    
    // 4. GÃ¼ncel fiyat testi
    console.log('\n4ï¸âƒ£ GÃœNCEL FÄ°YAT TESTÄ°');
    
    // USDTRY=X fiyatÄ±
    const usdPrice = DataReader.getCurrentPrice('USDTRY=X', 'CURRENCY');
    if (usdPrice) {
      console.log(`   ğŸ’µ USDTRY=X: ${usdPrice.price.toFixed(4)} TL`);
    } else {
      console.log('   âŒ USDTRY=X fiyatÄ± bulunamadÄ±');
    }
    
    // Gram altÄ±n fiyatÄ±
    const gramAltinPrice = DataReader.getCurrentPrice('gram-altin', 'GOLD');
    if (gramAltinPrice) {
      console.log(`   ğŸ… Gram AltÄ±n: ${gramAltinPrice.price.toFixed(2)} TL`);
    } else {
      console.log('   âŒ Gram AltÄ±n fiyatÄ± bulunamadÄ±');
    }
    
    // 5. En gÃ¼ncel tarihler
    console.log('\n5ï¸âƒ£ EN GÃœNCEL TARÄ°HLER');
    
    if (stocks.length > 0) {
      const latestStock = stocks.reduce((latest, current) => {
        if (!latest) return current;
        return (current.date > latest.date) ? current : latest;
      }, null);
      
      if (latestStock) {
        console.log(`   ğŸ“ˆ En gÃ¼ncel hisse: ${latestStock.symbol} - ${Utilities.formatDate(latestStock.date, 'GMT', 'dd.MM.yyyy')}`);
      }
    }
    
    if (currencies.length > 0) {
      const latestCurrency = currencies.reduce((latest, current) => {
        if (!latest) return current;
        return (current.date > latest.date) ? current : latest;
      }, null);
      
      if (latestCurrency) {
        console.log(`   ğŸ’± En gÃ¼ncel dÃ¶viz: ${latestCurrency.symbol} - ${Utilities.formatDate(latestCurrency.date, 'GMT', 'dd.MM.yyyy')}`);
      }
    }
    
  } catch (error) {
    console.error('âŒ GeÃ§miÅŸ veri test hatasÄ±:', error);
  }
  
  console.log('\n' + '='.repeat(80));
  console.log('ğŸ‰ GEÃ‡MÄ°Å VERÄ° TESTÄ° TAMAMLANDI');
}

/**
 * ğŸš€ TÃœM TESTLERÄ° Ã‡ALIÅTIR
 */
function run_All_DataReader_Tests() {
  console.log('ğŸš€ DATA READER TÃœM TESTLER BAÅLATILIYOR...\n');
  
  // 1. HÄ±zlÄ± test
  test_DataReader_Quick();
  
  console.log('\n' + '='.repeat(100) + '\n');
  
  // 2. GeÃ§miÅŸ veri testi
  test_DataReader_Historical_Data();
  
  console.log('\n' + '='.repeat(100) + '\n');
  
  // 3. Tam test
  test_DataReader_Complete();
  
  console.log('\n' + '='.repeat(100));
  console.log('ğŸŠ TÃœM DATA READER TESTLERÄ° BAÅARIYLA TAMAMLANDI!');
}

/**
 * ğŸ“± WEB UYGULAMASI Ä°Ã‡Ä°N TEST (basit)
 */
function test_DataReader_For_Web() {
  console.log('ğŸŒ WEB UYGULAMASI TESTÄ°');
  console.log('='.repeat(60));
  
  try {
    const result = {
      success: true,
      timestamp: new Date().toISOString(),
      data: {}
    };
    
    // PortfÃ¶y
    const portfolio = DataReader.readPortfolio();
    result.data.portfolio = {
      count: portfolio.length,
      sample: portfolio.length > 0 ? portfolio[0].baslik : null,
      categories: {}
    };
    
    // Kategoriler
    portfolio.forEach(item => {
      const cat = item.kategori || 'BELÄ°RSÄ°Z';
      result.data.portfolio.categories[cat] = (result.data.portfolio.categories[cat] || 0) + 1;
    });
    
    // GÃ¼ncel fiyatlar
    result.data.prices = {
      dolar: DataReader.getDolarPrice(),
      gramAltin: DataReader.getGramAltinPrice(),
      euro: DataReader.getEuroPrice(),
      onsAltin: DataReader.getOnsAltinPrice()
    };
    
    // GeÃ§miÅŸ veri durumu
    result.data.historical = {
      stocks: DataReader.readHistoricalStockPrices().length,
      currencies: DataReader.readHistoricalCurrencyPrices().length,
      gold: DataReader.readHistoricalGoldPrices().length
    };
    
    // Console'a yaz
    console.log(`ğŸ“Š PortfÃ¶y: ${result.data.portfolio.count} kayÄ±t`);
    console.log(`ğŸ’° Dolar: ${result.data.prices.dolar?.price?.toFixed(4) || 'N/A'} TL`);
    console.log(`ğŸ… Gram AltÄ±n: ${result.data.prices.gramAltin?.price?.toFixed(2) || 'N/A'} TL`);
    console.log(`ğŸ“ˆ Hisse geÃ§miÅŸi: ${result.data.historical.stocks} kayÄ±t`);
    console.log(`ğŸ’± DÃ¶viz geÃ§miÅŸi: ${result.data.historical.currencies} kayÄ±t`);
    console.log(`ğŸ… AltÄ±n geÃ§miÅŸi: ${result.data.historical.gold} kayÄ±t`);
    
    console.log('\n' + '='.repeat(60));
    console.log('âœ… Web testi baÅŸarÄ±lÄ±');
    
    return result;
    
  } catch (error) {
    console.error('âŒ Web testi hatasÄ±:', error);
    return {
      success: false,
      error: error.message,
      timestamp: new Date().toISOString()
    };
  }
}

/**
 * âš¡ EN HIZLI TEST (sadece kontrol)
 */
function quickCheck() {
  console.log('âš¡ HIZLI KONTROL');
  console.log('='.repeat(50));
  
  const start = new Date();
  
  try {
    // PortfÃ¶y
    const portfolio = DataReader.readPortfolio();
    console.log(`ğŸ“Š PortfÃ¶y: ${portfolio.length} kayÄ±t`);
    
    // Dolar
    const dolar = DataReader.getDolarPrice();
    console.log(`ğŸ’µ Dolar: ${dolar ? dolar.price.toFixed(4) + ' TL' : 'BulunamadÄ±'}`);
    
    // Gram altÄ±n
    const gramAltin = DataReader.getGramAltinPrice();
    console.log(`ğŸ… Gram AltÄ±n: ${gramAltin ? gramAltin.price.toFixed(2) + ' TL' : 'BulunamadÄ±'}`);
    
    // Hisse geÃ§miÅŸi
    const stocks = DataReader.readHistoricalStockPrices();
    console.log(`ğŸ“ˆ Hisse geÃ§miÅŸi: ${stocks.length} kayÄ±t`);
    
  } catch (error) {
    console.error('âŒ Hata:', error.message);
  }
  
  const duration = new Date() - start;
  console.log(`\nâ±ï¸  SÃ¼re: ${duration}ms`);
  console.log('='.repeat(50));
}
