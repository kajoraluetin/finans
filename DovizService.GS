/**
 * ğŸ’± DÃ–VÄ°Z SERVÄ°SÄ° - PortfÃ¶y BazlÄ± & AkÄ±llÄ± Sorgulama (TAM KOD)
 */
const DovizService = {

  /**
   * TÃ¼m dÃ¶viz Ã§iftleri iÃ§in geÃ§miÅŸ veriyi Ã§ek ve sheet'e yaz
   */
  syncAllCurrencyHistory: function() {
    console.log('ğŸ’± DÃ–VÄ°Z KURU SENKRONÄ°ZASYONU BAÅLATILIYOR');
    console.log('ğŸ“… Tarih:', new Date().toISOString());

    const startTime = new Date();
    
    try {
      // 1. PortfÃ¶yÃ¼ oku ve para birimlerini Ã§Ä±kar
      console.log('ğŸ“Š PortfÃ¶y okunuyor...');
      const portfolio = DataReader.readPortfolio();
      console.log(`ğŸ“¦ PortfÃ¶y kayÄ±t sayÄ±sÄ±: ${portfolio.length}`);
      
      if (portfolio.length === 0) {
        console.log('â„¹ï¸ PortfÃ¶y boÅŸ, dÃ¶viz senkronizasyonu atlanÄ±yor');
        return { success: true, message: 'PortfÃ¶y boÅŸ' };
      }
      
      // 2. PortfÃ¶ydeki benzersiz para birimlerini bul (TRY hariÃ§)
      const currencies = this._extractCurrenciesFromPortfolio(portfolio);
      console.log(`ğŸ“Œ PortfÃ¶yde bulunan para birimleri: ${currencies.length} adet`);
      
      if (currencies.length === 0) {
        console.log('â„¹ï¸ TRY dÄ±ÅŸÄ±nda para birimi bulunamadÄ±');
        return { success: true, message: 'TRY dÄ±ÅŸÄ±nda para birimi yok' };
      }
      
      // 3. Sheet'i hazÄ±rla
      const sheetName = this._getSheetName();
      const sheet = this._getOrCreateSheet(sheetName);
      
      // 4. Her para birimi iÃ§in iÅŸlem yap
      let totalProcessed = 0;
      let totalWritten = 0;
      let totalSkipped = 0;
      let totalFailed = 0;
      
      currencies.forEach((currency, index) => {
        console.log(`\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
        console.log(`ğŸ’± ${index + 1}/${currencies.length}: ${currency.currency}`);
        console.log(`   ğŸ“Š PortfÃ¶yde ${currency.count} kayÄ±t var`);
        
        try {
          // DÃ¶viz sembolÃ¼nÃ¼ oluÅŸtur
          const symbol = this._createCurrencySymbol(currency.currency);
          if (!symbol) {
            console.log(`   â­ï¸ ${currency.currency} iÃ§in sembol oluÅŸturulamadÄ±`);
            totalSkipped++;
            return;
          }
          
          // 4a. Bu dÃ¶viz iÃ§in sheet'teki en son tarihi kontrol et
          const lastRecordDate = this._getLastRecordDateForSymbol(sheet, symbol);
          
          // 4b. GÃ¼ncellik kontrolÃ¼
          if (this._isUpToDate(lastRecordDate)) {
            console.log(`   â­ï¸ ${symbol} zaten gÃ¼ncel (son tarih: ${lastRecordDate ? lastRecordDate.toISOString().split('T')[0] : 'yok'})`);
            totalSkipped++;
            return;
          }
          
          console.log(`   ğŸ“… En son kayÄ±t: ${lastRecordDate ? lastRecordDate.toISOString().split('T')[0] : 'Yok'}`);
          console.log(`   ğŸ” Veri Ã§ekiliyor...`);
          
          // 4c. CONFIG'teki aralÄ±kla veriyi Ã§ek
          const range = this._getDateRange();
          const dailyData = YahooFinanceStockService.fetchDailyHistory(symbol, range);
          
          if (!dailyData || dailyData.length === 0) {
            console.log(`   âš ï¸ ${symbol} iÃ§in veri alÄ±namadÄ±`);
            totalFailed++;
            return;
          }
          
          console.log(`   âœ… ${dailyData.length} gÃ¼n veri alÄ±ndÄ±`);
          console.log(`   ğŸ’° Son fiyat: ${dailyData[dailyData.length - 1].close}`);
          
          // 4d. Sheet'e yaz (duplicate kontrolÃ¼ ile)
          const written = this._writeToCurrencySheet(sheet, symbol, dailyData);
          
          if (written > 0) {
            console.log(`   ğŸ“ ${written} yeni kayÄ±t eklendi`);
            totalWritten += written;
            totalProcessed++;
          } else {
            console.log(`   â­ï¸ Yeni kayÄ±t yok`);
            totalSkipped++;
          }
          
        } catch (error) {
          console.error(`   ğŸ’¥ ${currency.currency} iÅŸlenirken hata:`, error.message);
          totalFailed++;
        }
        
        // Rate limit iÃ§in bekle (sonraki dÃ¶viz varsa)
        if (index < currencies.length - 1) {
          console.log('   â³ 2 saniye bekleniyor...');
          Utilities.sleep(2000);
        }
      });
      
      // 5. Ã–zet gÃ¶ster
      const duration = (new Date().getTime() - startTime.getTime()) / 1000;
      
      console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('ğŸ“Š DÃ–VÄ°Z SENKRONÄ°ZASYON Ã–ZETÄ°');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log(`ğŸ“… Tarih: ${new Date().toISOString().split('T')[0]}`);
      console.log(`â±ï¸  SÃ¼re: ${duration.toFixed(1)} saniye`);
      console.log(`ğŸ’± Toplam Para Birimi: ${currencies.length}`);
      console.log(`âœ… Ä°ÅŸlenen: ${totalProcessed}`);
      console.log(`â­ï¸ Atlanan: ${totalSkipped}`);
      console.log(`âŒ BaÅŸarÄ±sÄ±z: ${totalFailed}`);
      console.log(`ğŸ“ Yeni KayÄ±t: ${totalWritten}`);
      console.log('ğŸ‰ DÃ–VÄ°Z SENKRONÄ°ZASYONU TAMAMLANDI');
      
      return {
        success: totalFailed === 0,
        processed: totalProcessed,
        skipped: totalSkipped,
        failed: totalFailed,
        newRecords: totalWritten,
        duration: duration
      };
      
    } catch (error) {
      console.error('ğŸ’¥ Genel senkronizasyon hatasÄ±:', error);
      return {
        success: false,
        error: error.message
      };
    }
  },
  
  /**
   * PortfÃ¶ydeki benzersiz para birimlerini Ã§Ä±kar (TRY hariÃ§)
   */
  _extractCurrenciesFromPortfolio: function(portfolio) {
    const currencyMap = new Map();
    
    portfolio.forEach(item => {
      const currency = item.birimi ? item.birimi.trim() : null;
      
      if (currency) {
        if (!currencyMap.has(currency)) {
          currencyMap.set(currency, {
            currency: currency,
            count: 0
          });
        }
        currencyMap.get(currency).count++;
      }
    });
    
    // Map'i array'e Ã§evir ve sayÄ±ya gÃ¶re sÄ±rala (en Ã§ok kaydÄ± olan Ã¶nce)
    const currencies = Array.from(currencyMap.values())
      .sort((a, b) => b.count - a.count);
    
    console.log(`ğŸ“‹ PortfÃ¶ydeki para birimleri:`);
    currencies.forEach((c, i) => {
      console.log(`   ${i+1}. ${c.currency}: ${c.count} kayÄ±t`);
    });
    
    return currencies;
  },
  
  /**
   * Sheet adÄ±nÄ± gÃ¼venli ÅŸekilde al
   */
  _getSheetName: function() {
    // CONFIG'ten al, yoksa varsayÄ±lan
    try {
      if (CONFIG && CONFIG.SHEETS && CONFIG.SHEETS.DOVIZ_GECMIS && CONFIG.SHEETS.DOVIZ_GECMIS.NAME) {
        return CONFIG.SHEETS.DOVIZ_GECMIS.NAME;
      }
    } catch (e) {
      // CONFIG eriÅŸim hatasÄ±
    }
    return 'DOVIZ_GECMIS_GUNLUK'; // VarsayÄ±lan
  },
  
  /**
   * Tarih aralÄ±ÄŸÄ±nÄ± gÃ¼venli ÅŸekilde al
   */
  _getDateRange: function() {
    // CONFIG'ten al, yoksa varsayÄ±lan
    try {
      if (CONFIG && CONFIG.DOVIZ && CONFIG.DOVIZ.DEFAULT_RANGE) {
        return CONFIG.DOVIZ.DEFAULT_RANGE;
      }
    } catch (e) {
      // CONFIG eriÅŸim hatasÄ±
    }
    return '3mo'; // VarsayÄ±lan (3 ay)
  },
  
  /**
   * Para birimini Yahoo Finance sembolÃ¼ne Ã§evir
   */
  _createCurrencySymbol: function(currency) {
    const currencyUpper = currency.toUpperCase();
    
    // Para birimi eÅŸleÅŸtirmeleri
    const currencyMap = {
      'TL': 'TRY',    // TL -> TRY
      'EURO': 'EUR',  // EURO -> EUR
      'USD': 'USD',
      'EUR': 'EUR',
      'GBP': 'GBP',
      'JPY': 'JPY',
      'CHF': 'CHF',
      'CAD': 'CAD',
      'AUD': 'AUD'
    };
    
    const normalizedCurrency = currencyMap[currencyUpper] || currencyUpper;
    
    // TRY ise dÃ¶viz kuru Ã§ekmeye gerek yok
    if (normalizedCurrency === 'TRY') {
      console.log(`   â„¹ï¸ ${currency} (TRY) iÃ§in dÃ¶viz kuru Ã§ekmeye gerek yok`);
      return null;
    }
    
    const symbol = `${normalizedCurrency}TRY=X`;
    console.log(`   ğŸ”„ ${currency} -> ${symbol}`);
    return symbol;
  },
  
  /**
   * Sheet'i getir veya oluÅŸtur
   */
  _getOrCreateSheet: function(sheetName) {
    const ss = SpreadsheetApp.getActive();
    let sheet = ss.getSheetByName(sheetName);
    
    if (!sheet) {
      console.log(`ğŸ“„ "${sheetName}" sheet'i oluÅŸturuluyor...`);
      sheet = ss.insertSheet(sheetName);
      
      // BaÅŸlÄ±klarÄ± yaz
      const headers = [
        'Sembol',
        'Tarih',
        'AÃ§Ä±lÄ±ÅŸ',
        'YÃ¼ksek',
        'DÃ¼ÅŸÃ¼k',
        'KapanÄ±ÅŸ',
        'Kaynak',
        'Eklenme Tarihi'
      ];
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold');
      
      // Kolon geniÅŸliklerini ayarla
      sheet.setColumnWidth(1, 120); // Sembol
      sheet.setColumnWidth(2, 120); // Tarih
      sheet.setColumnWidth(3, 100); // AÃ§Ä±lÄ±ÅŸ
      sheet.setColumnWidth(4, 100); // YÃ¼ksek
      sheet.setColumnWidth(5, 100); // DÃ¼ÅŸÃ¼k
      sheet.setColumnWidth(6, 100); // KapanÄ±ÅŸ
      sheet.setColumnWidth(7, 120); // Kaynak
      sheet.setColumnWidth(8, 150); // Eklenme Tarihi
    }
    
    return sheet;
  },
  
  /**
   * Bir sembol iÃ§in sheet'teki en son tarihi bul
   */
  _getLastRecordDateForSymbol: function(sheet, symbol) {
    // Sheet boÅŸsa null dÃ¶ndÃ¼r
    if (sheet.getLastRow() <= 1) {
      return null;
    }
    
    try {
      // TÃ¼m verileri oku (Sembol ve Tarih sÃ¼tunlarÄ±)
      const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 2).getValues();
      let lastDate = null;
      
      // Bu sembol iÃ§in en son tarihi bul
      for (const row of data) {
        const existingSymbol = row[0];
        const date = row[1];
        
        if (existingSymbol === symbol && date instanceof Date) {
          const recordDate = new Date(date);
          if (!lastDate || recordDate > lastDate) {
            lastDate = recordDate;
          }
        }
      }
      
      return lastDate;
      
    } catch (error) {
      console.log(`   â„¹ï¸ ${symbol}: KayÄ±t tarihi okunamadÄ±, yeni sheet olabilir`);
      return null;
    }
  },
  
  /**
   * Bir tarihin gÃ¼ncel olup olmadÄ±ÄŸÄ±nÄ± kontrol et
   */
  _isUpToDate: function(lastDate) {
    if (!lastDate) {
      return false; // HiÃ§ kayÄ±t yok, gÃ¼ncel deÄŸil
    }
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const recordDate = new Date(lastDate);
    recordDate.setHours(0, 0, 0, 0);
    
    // BugÃ¼n ile kayÄ±t tarihi arasÄ±ndaki gÃ¼n farkÄ±
    const timeDiff = today.getTime() - recordDate.getTime();
    const dayDiff = timeDiff / (1000 * 3600 * 24);
    
    // Son kayÄ±t bugÃ¼n veya dÃ¼n ise gÃ¼ncel kabul et
    const isUpToDate = dayDiff <= 1;
    
    console.log(`   ğŸ“Š GÃ¼ncellik kontrolÃ¼:`);
    console.log(`      Son kayÄ±t: ${recordDate.toISOString().split('T')[0]}`);
    console.log(`      BugÃ¼n: ${today.toISOString().split('T')[0]}`);
    console.log(`      GÃ¼n farkÄ±: ${dayDiff.toFixed(1)}`);
    console.log(`      GÃ¼ncel mi? ${isUpToDate ? 'âœ… Evet' : 'âŒ HayÄ±r'}`);
    
    return isUpToDate;
  },
  
  /**
   * DÃ¶viz verilerini sheet'e yaz (duplicate kontrolÃ¼ ile)
   */
  _writeToCurrencySheet: function(sheet, symbol, dailyData) {
    console.log(`   ğŸ“ ${symbol} verileri sheet'e yazÄ±lÄ±yor...`);
    
    // 1. Mevcut kayÄ±tlarÄ± al (duplicate kontrolÃ¼ iÃ§in)
    const existingRecords = this._getExistingRecords(sheet, symbol);
    
    // 2. Yeni kayÄ±tlarÄ± hazÄ±rla
    const rowsToWrite = [];
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    dailyData.forEach(d => {
      const tarih = new Date(d.tarih);
      tarih.setHours(0, 0, 0, 0);
      
      // Gelecek tarihleri atla
      if (tarih > today) return;
      
      const tarihStr = Utilities.formatDate(tarih, 'GMT', 'yyyy-MM-dd');
      const key = `${symbol}_${tarihStr}`;
      
      // Duplicate kontrolÃ¼
      if (existingRecords.has(key)) {
        return;
      }
      
      rowsToWrite.push([
        symbol,
        tarih, // Tarih
        d.open || 0,
        d.high || 0,
        d.low || 0,
        d.close || 0,
        'YahooFinance',
        new Date() // Eklenme tarihi
      ]);
    });
    
    if (rowsToWrite.length === 0) {
      console.log(`   â­ï¸ ${symbol}: TÃ¼m veriler zaten mevcut`);
      return 0;
    }
    
    // 3. Sheet'e yaz
    const startRow = sheet.getLastRow() + 1;
    const range = sheet.getRange(startRow, 1, rowsToWrite.length, 8);
    range.setValues(rowsToWrite);
    
    // 4. FormatlarÄ± ayarla
    const dateRange = sheet.getRange(startRow, 2, rowsToWrite.length, 1);
    dateRange.setNumberFormat('YYYY-MM-DD');
    
    const priceRange = sheet.getRange(startRow, 3, rowsToWrite.length, 4);
    priceRange.setNumberFormat('#,##0.00');
    
    const addedRange = sheet.getRange(startRow, 8, rowsToWrite.length, 1);
    addedRange.setNumberFormat('YYYY-MM-DD HH:mm:ss');
    
    console.log(`   âœ… ${symbol}: ${rowsToWrite.length} kayÄ±t eklendi (satÄ±r ${startRow}-${startRow + rowsToWrite.length - 1})`);
    
    return rowsToWrite.length;
  },
  
  /**
   * Sheet'teki mevcut kayÄ±tlarÄ± getir (duplicate kontrolÃ¼ iÃ§in)
   */
  _getExistingRecords: function(sheet, symbol) {
    const existingMap = new Set();
    
    // Sheet boÅŸsa boÅŸ set dÃ¶ndÃ¼r
    if (sheet.getLastRow() <= 1) {
      return existingMap;
    }
    
    try {
      // Sembol ve tarih sÃ¼tunlarÄ±nÄ± oku
      const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 2).getValues();
      
      data.forEach(row => {
        const existingSymbol = row[0];
        const date = row[1];
        
        if (existingSymbol === symbol && date instanceof Date) {
          const dateStr = Utilities.formatDate(date, 'GMT', 'yyyy-MM-dd');
          const key = `${symbol}_${dateStr}`;
          existingMap.add(key);
        }
      });
      
      console.log(`   ğŸ“Š ${symbol}: Sheet'te ${existingMap.size} mevcut kayÄ±t bulundu`);
      
    } catch (error) {
      console.log(`   â„¹ï¸ ${symbol}: Mevcut kayÄ±tlar okunamadÄ±, yeni sheet olabilir`);
    }
    
    return existingMap;
  },
  
  /**
   * Sheet istatistiklerini gÃ¶ster
   */
  showSheetStats: function() {
    const sheetName = this._getSheetName();
    const sheet = SpreadsheetApp.getActive().getSheetByName(sheetName);
    
    if (!sheet) {
      console.log(`âŒ "${sheetName}" sheet'i bulunamadÄ±`);
      return;
    }
    
    console.log('\nğŸ“Š DÃ–VÄ°Z SHEET Ä°STATÄ°STÄ°KLERÄ°:');
    console.log(`   Sheet: ${sheet.getName()}`);
    console.log(`   Toplam SatÄ±r: ${sheet.getLastRow()}`);
    
    if (sheet.getLastRow() > 1) {
      // DÃ¶viz sembollerine gÃ¶re grupla
      const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 2).getValues();
      const symbolCounts = {};
      const symbolDates = {};
      
      data.forEach(row => {
        const symbol = row[0];
        const date = row[1];
        
        if (symbol) {
          symbolCounts[symbol] = (symbolCounts[symbol] || 0) + 1;
          
          if (date instanceof Date) {
            if (!symbolDates[symbol] || date > symbolDates[symbol]) {
              symbolDates[symbol] = date;
            }
          }
        }
      });
      
      console.log(`   KayÄ±tlÄ± DÃ¶viz Ã‡ifti SayÄ±sÄ±: ${Object.keys(symbolCounts).length}`);
      
      if (Object.keys(symbolCounts).length > 0) {
        console.log('   ğŸ“ˆ KAYIT DETAYLARI:');
        Object.entries(symbolCounts).forEach(([symbol, count], index) => {
          const lastDate = symbolDates[symbol];
          const lastDateStr = lastDate ? lastDate.toISOString().split('T')[0] : 'Bilinmiyor';
          console.log(`      ${index + 1}. ${symbol}: ${count} kayÄ±t (Son: ${lastDateStr})`);
        });
      }
    }
  },
  
  /**
   * GÃœNCEL 2 YILLIK VERÄ° Ã‡EK - Manuel fonksiyon
   */
  fetchFullTwoYearHistory: function() {
    console.log('ğŸ“… 2 YILLIK TAM GEÃ‡MÄ°Å VERÄ° Ã‡EKÄ°LÄ°YOR');
    console.log('â³ Bu iÅŸlem biraz zaman alabilir...');
    
    // GeÃ§ici olarak DEFAULT_RANGE'i 2y yap
    const originalDefaultRange = this._getDateRange();
    
    try {
      // CONFIG'i geÃ§ici olarak deÄŸiÅŸtir (mÃ¼mkÃ¼nse)
      try {
        if (CONFIG && CONFIG.DOVIZ) {
          CONFIG.DOVIZ.DEFAULT_RANGE = '2y';
        }
      } catch (e) {
        // CONFIG eriÅŸim hatasÄ±
        console.log('â„¹ï¸ CONFIG deÄŸiÅŸtirilemedi, 2y ile devam edilecek');
      }
      
      const result = this.syncAllCurrencyHistory();
      
      console.log('\nğŸ¯ 2 YILLIK VERÄ° Ã‡EKME SONUCU:');
      console.log(JSON.stringify(result, null, 2));
      
      return result;
      
    } catch (error) {
      console.error('ğŸ’¥ 2 yÄ±llÄ±k veri Ã§ekme hatasÄ±:', error);
      return {
        success: false,
        error: error.message
      };
    } finally {
      // Orijinal ayarÄ± geri yÃ¼kle (mÃ¼mkÃ¼nse)
      try {
        if (CONFIG && CONFIG.DOVIZ && originalDefaultRange) {
          CONFIG.DOVIZ.DEFAULT_RANGE = originalDefaultRange;
        }
      } catch (e) {
        // Geri yÃ¼kleme hatasÄ±
      }
    }
  },
  
  /**
   * BELÄ°RLÄ° BÄ°R DÃ–VÄ°Z Ä°Ã‡Ä°N 2 YILLIK VERÄ° Ã‡EK
   */
  fetchTwoYearHistoryForCurrency: function(currencyCode) {
    console.log(`ğŸ“… ${currencyCode} iÃ§in 2 yÄ±llÄ±k veri Ã§ekiliyor...`);
    
    try {
      // Symbol oluÅŸtur
      const symbol = this._createCurrencySymbol(currencyCode);
      if (!symbol) {
        console.log(`âŒ ${currencyCode} iÃ§in sembol oluÅŸturulamadÄ±`);
        return { success: false, message: 'GeÃ§ersiz para birimi' };
      }
      
      // Sheet'i hazÄ±rla
      const sheetName = this._getSheetName();
      const sheet = this._getOrCreateSheet(sheetName);
      
      // 2 yÄ±llÄ±k veriyi Ã§ek
      console.log(`ğŸ“¡ ${symbol} (2y) verisi Ã§ekiliyor...`);
      const data = YahooFinanceStockService.fetchDailyHistory(symbol, '2y');
      
      if (!data || data.length === 0) {
        console.log(`âŒ ${currencyCode} verisi alÄ±namadÄ±`);
        return { success: false, message: 'Veri alÄ±namadÄ±' };
      }
      
      console.log(`âœ… ${data.length} gÃ¼n veri alÄ±ndÄ±`);
      
      // Tarih aralÄ±ÄŸÄ±nÄ± gÃ¶ster
      if (data.length > 0) {
        const firstDate = data[0].tarih.toISOString().split('T')[0];
        const lastDate = data[data.length - 1].tarih.toISOString().split('T')[0];
        console.log(`ğŸ“… Tarih aralÄ±ÄŸÄ±: ${firstDate} - ${lastDate}`);
      }
      
      // Mevcut kayÄ±tlarÄ± sil (bu sembol iÃ§in)
      this._deleteExistingRecordsForSymbol(sheet, symbol);
      
      // Yeni kayÄ±tlarÄ± hazÄ±rla
      const rowsToWrite = [];
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      data.forEach(d => {
        const tarih = new Date(d.tarih);
        tarih.setHours(0, 0, 0, 0);
        
        // Gelecek tarihleri atla
        if (tarih > today) return;
        
        rowsToWrite.push([
          symbol,
          tarih,
          d.open || 0,
          d.high || 0,
          d.low || 0,
          d.close || 0,
          'YahooFinance',
          new Date()
        ]);
      });
      
      if (rowsToWrite.length === 0) {
        console.log(`â„¹ï¸ YazÄ±lacak veri yok`);
        return { success: true, newRecords: 0 };
      }
      
      // Yeni kayÄ±tlarÄ± yaz
      const startRow = sheet.getLastRow() + 1;
      const range = sheet.getRange(startRow, 1, rowsToWrite.length, 8);
      range.setValues(rowsToWrite);
      
      // FormatlarÄ± ayarla
      const dateRange = sheet.getRange(startRow, 2, rowsToWrite.length, 1);
      dateRange.setNumberFormat('YYYY-MM-DD');
      
      const priceRange = sheet.getRange(startRow, 3, rowsToWrite.length, 4);
      priceRange.setNumberFormat('#,##0.00');
      
      const addedRange = sheet.getRange(startRow, 8, rowsToWrite.length, 1);
      addedRange.setNumberFormat('YYYY-MM-DD HH:mm:ss');
      
      console.log(`âœ… ${symbol}: ${rowsToWrite.length} kayÄ±t eklendi`);
      
      return {
        success: true,
        currency: currencyCode,
        symbol: symbol,
        newRecords: rowsToWrite.length,
        dateRange: {
          first: data[0].tarih.toISOString().split('T')[0],
          last: data[data.length - 1].tarih.toISOString().split('T')[0]
        }
      };
      
    } catch (error) {
      console.error(`ğŸ’¥ ${currencyCode} 2 yÄ±llÄ±k veri hatasÄ±:`, error.message);
      return {
        success: false,
        currency: currencyCode,
        error: error.message
      };
    }
  },
  
  /**
   * Bir sembol iÃ§in mevcut kayÄ±tlarÄ± sil
   */
  _deleteExistingRecordsForSymbol: function(sheet, symbol) {
    if (sheet.getLastRow() <= 1) return 0;
    
    let deletedCount = 0;
    const rowsToDelete = [];
    
    try {
      // TÃ¼m verileri oku
      const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 1).getValues();
      
      // Silinecek satÄ±rlarÄ± bul
      data.forEach((row, index) => {
        if (row[0] === symbol) {
          rowsToDelete.push(index + 2); // +2 Ã§Ã¼nkÃ¼ 1. satÄ±r baÅŸlÄ±k, 2. satÄ±rdan baÅŸlÄ±yor
        }
      });
      
      // Tersten sil (satÄ±r numaralarÄ± deÄŸiÅŸmesin diye)
      rowsToDelete.reverse().forEach(rowNum => {
        sheet.deleteRow(rowNum);
        deletedCount++;
      });
      
      if (deletedCount > 0) {
        console.log(`   ğŸ—‘ï¸  ${symbol}: ${deletedCount} eski kayÄ±t silindi`);
      }
      
    } catch (error) {
      console.log(`   â„¹ï¸ ${symbol}: Eski kayÄ±tlar silinemedi:`, error.message);
    }
    
    return deletedCount;
  }
};

/**
 *  FONKSÄ°YON Ã–ZETÄ°:
  Fonksiyon	AmaÃ§	SÄ±klÄ±k
  test_DovizService_Main()	PortfÃ¶y bazlÄ± dÃ¶viz senkronizasyonu	GÃ¼nlÃ¼k
  check_Currency_Updates()	GÃ¼ncellik kontrolÃ¼	GÃ¼nlÃ¼k
  analyze_Portfolio_Currencies()	PortfÃ¶y analizi	HaftalÄ±k
  fetch_TwoYear_History()	2 yÄ±llÄ±k geÃ§miÅŸ veri Ã§ekme	Ä°lk kurulumda
  reset_Currency_Sheet()	Sheet temizleme	Nadiren
 */
/**
 * ğŸ§ª DÃ–VÄ°Z SERVÄ°SÄ° TEMEL TESTÄ°
 * Ana fonksiyon: PortfÃ¶y bazlÄ± dÃ¶viz senkronizasyonu
 */
function test_DovizService_Main() {
  console.log('ğŸ§ª DÃ–VÄ°Z SERVÄ°SÄ° ANA TESTÄ°');
  console.log('âš¡ PortfÃ¶ydeki para birimlerine gÃ¶re dÃ¶viz verisi Ã§ekilecek');
  
  // 1. PortfÃ¶y analizi
  console.log('\nğŸ” PortfÃ¶y analizi yapÄ±lÄ±yor...');
  const portfolio = DataReader.readPortfolio();
  const currencies = DovizService._extractCurrenciesFromPortfolio(portfolio);
  
  console.log(`ğŸ“Œ PortfÃ¶yde ${currencies.length} farklÄ± para birimi bulundu`);
  currencies.forEach((c, i) => {
    console.log(`   ${i+1}. ${c.currency}: ${c.count} kayÄ±t`);
  });
  
  // 2. DÃ¶viz senkronizasyonu
  console.log('\nğŸš€ DÃ¶viz senkronizasyonu baÅŸlatÄ±lÄ±yor...');
  const result = DovizService.syncAllCurrencyHistory();
  
  // 3. SonuÃ§larÄ± gÃ¶ster
  console.log('\nğŸ¯ TEST SONUCU:');
  console.log(JSON.stringify(result, null, 2));
  
  // 4. Sheet istatistikleri
  console.log('\nğŸ“Š SHEET DURUMU:');
  try {
    DovizService.showSheetStats();
  } catch (e) {
    console.log('â„¹ï¸ Sheet istatistikleri gÃ¶sterilemedi');
  }
  
  return result;
}

/**
 * ğŸ“… 2 YILLIK TAM GEÃ‡MÄ°Å VERÄ° Ã‡EK
 * Eksik olan tÃ¼m 2 yÄ±llÄ±k verileri tamamlar
 */
function fetch_TwoYear_History() {
  console.log('ğŸ“… 2 YILLIK TAM GEÃ‡MÄ°Å VERÄ° Ã‡EKÄ°LÄ°YOR');
  console.log('â³ Bu iÅŸlem biraz zaman alabilir...');
  
  const result = DovizService.fetchFullTwoYearHistory();
  
  console.log('\nğŸ¯ SONUÃ‡:');
  console.log(JSON.stringify(result, null, 2));
  
  return result;
}

/**
 * ğŸ” GÃœNCELLÄ°K KONTROLÃœ
 * Mevcut dÃ¶viz verilerinin gÃ¼ncel olup olmadÄ±ÄŸÄ±nÄ± kontrol eder
 */
function check_Currency_Updates() {
  console.log('ğŸ” DÃ–VÄ°Z GÃœNCELLÄ°K KONTROLÃœ');
  
  try {
    // Sheet'i kontrol et
    const sheetName = DovizService._getSheetName();
    const sheet = SpreadsheetApp.getActive().getSheetByName(sheetName);
    
    if (!sheet) {
      console.log('â„¹ï¸ DÃ¶viz sheet\'i bulunamadÄ±');
      return;
    }
    
    console.log(`ğŸ“„ Sheet: ${sheet.getName()}, SatÄ±r: ${sheet.getLastRow()}`);
    
    if (sheet.getLastRow() <= 1) {
      console.log('â„¹ï¸ Sheet boÅŸ');
      return;
    }
    
    // PortfÃ¶ydeki para birimlerini al
    const portfolio = DataReader.readPortfolio();
    const currencies = DovizService._extractCurrenciesFromPortfolio(portfolio);
    
    console.log(`ğŸ“Š PortfÃ¶ydeki yabancÄ± para birimleri: ${currencies.filter(c => c.currency !== 'TL').length} adet`);
    
    currencies.forEach((currency, index) => {
      const symbol = DovizService._createCurrencySymbol(currency.currency);
      if (!symbol) return;
      
      console.log(`\n${index + 1}. ${currency.currency} -> ${symbol}:`);
      
      try {
        const lastDate = DovizService._getLastRecordDateForSymbol(sheet, symbol);
        const isUpToDate = DovizService._isUpToDate(lastDate);
        
        console.log(`   Son kayÄ±t: ${lastDate ? lastDate.toISOString().split('T')[0] : 'Yok'}`);
        console.log(`   GÃ¼ncel mi? ${isUpToDate ? 'âœ… Evet' : 'âŒ HayÄ±r'}`);
        
      } catch (error) {
        console.log(`   âŒ Hata: ${error.message}`);
      }
    });
    
  } catch (error) {
    console.error('ğŸ’¥ Kontrol hatasÄ±:', error.message);
  }
}

/**
 * ğŸ—‘ï¸ DÃ–VÄ°Z SHEET'Ä°NÄ° TEMÄ°ZLE (TEST Ä°Ã‡Ä°N)
 * Sadece ihtiyaÃ§ olduÄŸunda kullanÄ±n
 */
function reset_Currency_Sheet() {
  console.log('ğŸ—‘ï¸ DÃ–VÄ°Z SHEET TEMÄ°ZLEME');
  
  const sheetName = DovizService._getSheetName();
  const sheet = SpreadsheetApp.getActive().getSheetByName(sheetName);
  
  if (sheet) {
    // Sheet'i tamamen sil
    const ss = SpreadsheetApp.getActive();
    ss.deleteSheet(sheet);
    console.log(`âœ… "${sheetName}" sheet'i silindi`);
  } else {
    console.log(`â„¹ï¸ "${sheetName}" sheet'i bulunamadÄ±`);
  }
  
  return {
    success: true,
    message: 'Sheet temizlendi'
  };
}

/**
 * ğŸ“Š PORTFÃ–Y PARA BÄ°RÄ°MÄ° ANALÄ°ZÄ°
 * PortfÃ¶yde hangi para birimlerinin olduÄŸunu gÃ¶sterir
 */
function analyze_Portfolio_Currencies() {
  console.log('ğŸ“Š PORTFÃ–Y PARA BÄ°RÄ°MÄ° ANALÄ°ZÄ°');
  
  try {
    const portfolio = DataReader.readPortfolio();
    
    console.log(`ğŸ“¦ Toplam kayÄ±t: ${portfolio.length}`);
    
    // TÃ¼m para birimlerini say
    const currencyCounts = {};
    
    portfolio.forEach(item => {
      const currency = item.birimi ? item.birimi.toUpperCase() : 'BELÄ°RSÄ°Z';
      currencyCounts[currency] = (currencyCounts[currency] || 0) + 1;
    });
    
    console.log('\nğŸ“‹ PARA BÄ°RÄ°MÄ° DAÄILIMI:');
    Object.entries(currencyCounts)
      .sort((a, b) => b[1] - a[1])
      .forEach(([currency, count], index) => {
        const percentage = ((count / portfolio.length) * 100).toFixed(1);
        console.log(`   ${index + 1}. ${currency}: ${count} kayÄ±t (%${percentage})`);
      });
    
    // YabancÄ± para birimleri
    const foreignCurrencies = Object.entries(currencyCounts)
      .filter(([currency]) => currency !== 'TL' && currency !== 'TRY')
      .map(([currency, count]) => ({ currency, count }));
    
    console.log(`\nğŸ¯ YABANCI PARA BÄ°RÄ°MLERÄ° (${foreignCurrencies.length} adet):`);
    
    if (foreignCurrencies.length > 0) {
      foreignCurrencies.forEach(({ currency, count }, index) => {
        const yahooSymbol = DovizService._createCurrencySymbol(currency);
        console.log(`   ${index + 1}. ${currency}: ${count} kayÄ±t â†’ ${yahooSymbol || 'GeÃ§ersiz'}`);
      });
    } else {
      console.log('   â„¹ï¸ PortfÃ¶yde sadece TL kullanÄ±lmÄ±ÅŸ');
    }
    
  } catch (error) {
    console.error('ğŸ’¥ Analiz hatasÄ±:', error);
  }
}
