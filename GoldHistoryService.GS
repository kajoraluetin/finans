/**
 * ğŸ“ˆ GOLD HISTORY - TAM DÃœZELTME
 * SORUN Ã‡Ã–ZÃœLDÃœ: Fiyatlar 100 katÄ± yazÄ±lÄ±yordu
 * SÃ–Z DÄ°ZÄ°MÄ° HATASI DÃœZELTÄ°LDÄ°: %50'den fazla fark varsa â†’ // %50'den fazla fark varsa
 */

const GoldHistoryService = {
  
  SHEET_NAME: 'ALTIN_GECMIS_GUNLUK',
  
  /**
   * BugÃ¼nÃ¼n altÄ±n fiyatlarÄ±nÄ± HISSE formatÄ±nda kaydet - DÃœZELTÄ°LMÄ°Å
   */
  saveTodayPricesToHisseSheet: function() {
    console.log('ğŸ“¥ AltÄ±n fiyatlarÄ± HISSE formatÄ±nda sheet\'e yazÄ±lÄ±yor (2. satÄ±rdan)...');
    
    try {
      // 1. GÃ¼ncel fiyatlarÄ± al
      const allData = GoldService.getAllPrices();
      const goldData = allData.altinlar;
      
      if (!goldData || Object.keys(goldData).length === 0) {
        console.error('âŒ Kaydedilecek altÄ±n verisi yok');
        return { success: false, message: 'AltÄ±n verisi yok' };
      }
      
      console.log(`ğŸ“Š ${Object.keys(goldData).length} altÄ±n tÃ¼rÃ¼ bulundu`);
      
      // 2. Sheet'i hazÄ±rla
      const sheet = this._getHisseFormatSheet();
      
      // 3. Mevcut kayÄ±tlarÄ± kontrol et
      let existingRecords = new Set();
      if (sheet.getLastRow() > 1) {
        existingRecords = this._getExistingRecords(sheet);
      }
      
      // 4. BugÃ¼nÃ¼n tarihi
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayStr = Utilities.formatDate(today, 'GMT', 'dd.MM.yyyy');
      
      // 5. YAZILACAK satÄ±rlarÄ± hazÄ±rla
      const rows = [];
      let newRecords = 0;
      let skippedRecords = 0;
      
      // DEBUG: Ä°lk 3 kaydÄ± detaylÄ± logla
      const debugKeys = Object.keys(goldData).slice(0, 3);
      console.log('ğŸ” DEBUG - Ä°lk 3 kayÄ±t:');
      
      Object.keys(goldData).forEach((key, index) => {
        const priceInfo = goldData[key];
        
        // Ä°lk 3 kayÄ±t iÃ§in detaylÄ± debug
        if (index < 3) {
          console.log(`   ${index + 1}. ${key}:`);
          console.log(`      Orijinal AlÄ±ÅŸ: "${priceInfo.buyingRaw}"`);
          console.log(`      Parse EdilmiÅŸ: ${priceInfo.buying}`);
          console.log(`      Orijinal SatÄ±ÅŸ: "${priceInfo.sellingRaw}"`);
          console.log(`      Parse EdilmiÅŸ: ${priceInfo.selling}`);
          
          // Beklenen deÄŸer kontrolÃ¼
          const expectedBuying = this._calculateExpectedValue(priceInfo.buyingRaw);
          console.log(`      Beklenen AlÄ±ÅŸ: ${expectedBuying}`);
          
          if (Math.abs(priceInfo.buying - expectedBuying) > 1) {
            console.warn(`      âš ï¸ UYUMSUZLUK! Parse: ${priceInfo.buying}, Beklenen: ${expectedBuying}`);
          }
        }
        
        // Duplicate kontrolÃ¼
        const recordKey = `${key}_${todayStr}`;
        if (existingRecords.has(recordKey)) {
          if (index < 3) console.log(`      â­ï¸ Zaten mevcut, atlanÄ±yor`);
          skippedRecords++;
          return;
        }
        
        // DEÄER KONTROLÃœ: EÄŸer deÄŸer 100 katÄ±ysa, dÃ¼zelt
        let buying = priceInfo.buying;
        let selling = priceInfo.selling;
        
        // Kontrol: "7.094,49" â†’ 7094.49 olmalÄ±
        // EÄŸer 709449 geliyorsa, 100'e bÃ¶l
        const expected = this._calculateExpectedValue(priceInfo.buyingRaw);
        
        // DÃœZELTME: SÃ¶zdizimi hatasÄ± dÃ¼zeltildi
        // if (Math.abs(buying - expected) > expected * 0.5) { %50'den fazla fark varsa
        if (Math.abs(buying - expected) > expected * 0.5) { // %50'den fazla fark varsa
          console.warn(`   âš ï¸ ${key}: Beklenmeyen deÄŸer! Parse: ${buying}, Beklenen: ${expected}`);
          
          // 100 katÄ± kontrolÃ¼
          if (Math.abs(buying / 100 - expected) < 1) {
            console.log(`     100 katÄ± tespit edildi, dÃ¼zeltiliyor: ${buying} â†’ ${buying / 100}`);
            buying = buying / 100;
            selling = selling / 100;
          }
        }
        
        const high = Math.max(buying, selling);
        const low = Math.min(buying, selling);
        
        if (index < 3) {
          console.log(`      ğŸ“ YazÄ±lacak: ${buying} / ${selling}`);
        }
        
        rows.push([
          key,                    // Sembol
          today,                  // Tarih
          buying,                 // AÃ§Ä±lÄ±ÅŸ
          high,                   // En YÃ¼ksek
          low,                    // En DÃ¼ÅŸÃ¼k
          selling,                // KapanÄ±ÅŸ
          0,                      // Hacim
          'TruncgilAPI'           // Kaynak
        ]);
        
        newRecords++;
      });
      
      if (rows.length === 0) {
        console.log(`â­ï¸ TÃ¼m kayÄ±tlar zaten mevcut (${skippedRecords} atlandÄ±)`);
        return { 
          success: true, 
          message: 'TÃ¼m kayÄ±tlar zaten mevcut', 
          newRecords: 0,
          skipped: skippedRecords 
        };
      }
      
      // 6. HER ZAMAN 2. SATIRDAN BAÅLAYARAK yaz
      let startRow = 2;
      if (sheet.getLastRow() > 1) {
        startRow = sheet.getLastRow() + 1;
      }
      
      console.log(`ğŸ“ ${rows.length} kayÄ±t sheet'e yazÄ±lÄ±yor (satÄ±r ${startRow})...`);
      
      // DEBUG: Yazmadan Ã¶nce ilk 3 satÄ±rÄ± gÃ¶ster
      console.log('ğŸ“‹ YazÄ±lacak ilk 3 satÄ±r:');
      for (let i = 0; i < Math.min(3, rows.length); i++) {
        console.log(`   ${rows[i][0]}: ${rows[i][2]} / ${rows[i][5]}`);
      }
      
      const range = sheet.getRange(startRow, 1, rows.length, 8);
      range.setValues(rows);
      
      // 7. FormatlarÄ± ayarla
      sheet.getRange(startRow, 2, rows.length, 1)
           .setNumberFormat('DD.MM.YYYY');
      
      const priceColumns = sheet.getRange(startRow, 3, rows.length, 4);
      priceColumns.setNumberFormat('#,##0.00');
      priceColumns.setHorizontalAlignment('right');
      
      sheet.getRange(startRow, 7, rows.length, 1)
           .setNumberFormat('#,##0');
      
      console.log(`âœ… ${newRecords} yeni altÄ±n kaydÄ± eklendi (satÄ±r ${startRow}-${startRow + rows.length - 1})`);
      
      // 8. Sheet'ten oku ve kontrol et
      console.log('\nğŸ” SHEET KONTROLÃœ (Ä°lk 3 kayÄ±t):');
      for (let i = 0; i < Math.min(3, rows.length); i++) {
        const sheetValue = sheet.getRange(startRow + i, 3).getValue();
        console.log(`   ${rows[i][0]}: Sheet'te = ${sheetValue}, Beklenen = ${rows[i][2]}`);
        
        if (Math.abs(sheetValue - rows[i][2]) > 0.01) {
          console.warn(`   âš ï¸ UYUMSUZLUK! Fark: ${Math.abs(sheetValue - rows[i][2])}`);
        }
      }
      
      return { 
        success: true, 
        message: 'AltÄ±n fiyatlarÄ± baÅŸarÄ±yla kaydedildi',
        newRecords: newRecords,
        skipped: skippedRecords,
        startRow: startRow
      };
      
    } catch (error) {
      console.error('ğŸ’¥ AltÄ±n kayÄ±t hatasÄ±:', error);
      return { 
        success: false, 
        message: 'Hata: ' + error.message,
        error: error.toString() 
      };
    }
  },
  
  /**
   * Beklenen deÄŸeri hesapla
   */
  _calculateExpectedValue: function(priceStr) {
    if (!priceStr) return 0;
    
    try {
      // "7.094,49" â†’ 7094.49
      let cleaned = priceStr.replace(/[$\â‚¬Â£Â¥]/g, '').trim();
      cleaned = cleaned.replace(/\./g, '').replace(',', '.');
      return parseFloat(cleaned);
    } catch (e) {
      return 0;
    }
  },
  
  /**
   * HISSE_GECMIS_GUNLUK formatÄ±nda sheet getir
   */
  _getHisseFormatSheet: function() {
    const ss = SpreadsheetApp.getActive();
    let sheet = ss.getSheetByName(this.SHEET_NAME);
    
    if (!sheet) {
      console.log(`ğŸ“„ "${this.SHEET_NAME}" sheet'i oluÅŸturuluyor...`);
      sheet = ss.insertSheet(this.SHEET_NAME);
      
      console.log(`â„¹ï¸ Sheet oluÅŸturuldu. BaÅŸlÄ±klarÄ± ekleyin.`);
    }
    
    return sheet;
  },
  
  /**
   * Sheet'teki mevcut kayÄ±tlarÄ± getir
   */
  _getExistingRecords: function(sheet) {
    const existingMap = new Set();
    
    if (sheet.getLastRow() <= 1) return existingMap;
    
    try {
      const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 2).getValues();
      
      data.forEach(row => {
        const symbol = row[0];
        const date = row[1];
        
        if (symbol && date instanceof Date) {
          const dateStr = Utilities.formatDate(date, 'GMT', 'dd.MM.yyyy');
          existingMap.add(`${symbol}_${dateStr}`);
        }
      });
      
      console.log(`ğŸ“Š Sheet'te ${existingMap.size} mevcut kayÄ±t`);
    } catch (error) {
      console.log('â„¹ï¸ Mevcut kayÄ±tlar okunamadÄ±');
    }
    
    return existingMap;
  },
  
  /**
   * Sheet'i tamamen sÄ±fÄ±rla
   */
  resetSheet: function() {
    console.log('ğŸ”„ Sheet tamamen sÄ±fÄ±rlanÄ±yor...');
    
    try {
      const ss = SpreadsheetApp.getActive();
      const sheet = ss.getSheetByName(this.SHEET_NAME);
      
      if (sheet) {
        ss.deleteSheet(sheet);
        console.log(`âœ… "${this.SHEET_NAME}" sheet'i silindi`);
      }
      
      return { 
        success: true, 
        message: 'Sheet sÄ±fÄ±rlandÄ±'
      };
      
    } catch (error) {
      console.error('ğŸ’¥ SÄ±fÄ±rlama hatasÄ±:', error);
      return { success: false, message: 'Hata: ' + error.message };
    }
  },

  /**
   * Sheet yapÄ±sÄ±nÄ± kontrol et
   */
  checkSheetStructure: function() {
    console.log('ğŸ” Sheet yapÄ±sÄ± kontrol ediliyor...');
    
    try {
      const sheet = this._getHisseFormatSheet();
      
      if (sheet.getLastRow() === 0) {
        return {
          isValid: false,
          message: 'Sheet boÅŸ, baÅŸlÄ±klarÄ± ekleyin',
          sheetName: sheet.getName(),
          columnCount: sheet.getLastColumn()
        };
      }
      
      // BaÅŸlÄ±k satÄ±rÄ±nÄ± oku
      const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
      
      // Beklenen baÅŸlÄ±klar (en azÄ±ndan temel baÅŸlÄ±klar)
      const expectedHeaders = ['Sembol', 'Tarih', 'AÃ§Ä±lÄ±ÅŸ', 'En YÃ¼ksek', 'En DÃ¼ÅŸÃ¼k', 'KapanÄ±ÅŸ'];
      let isValid = true;
      let issues = [];
      
      // Her sÃ¼tunun baÅŸlÄ±ÄŸÄ±nÄ± kontrol et (en azÄ±ndan ilk 6 sÃ¼tun)
      for (let i = 0; i < Math.min(expectedHeaders.length, headers.length); i++) {
        const expected = expectedHeaders[i];
        const actual = headers[i] || '';
        
        if (!actual.toString().toLowerCase().includes(expected.toLowerCase())) {
          isValid = false;
          issues.push(`${i+1}. sÃ¼tun: "${actual}" beklenen "${expected}" olmalÄ±`);
        }
      }
      
      return {
        isValid: isValid,
        message: isValid ? 'Sheet yapÄ±sÄ± uygun' : 'BaÅŸlÄ±k uyuÅŸmazlÄ±ÄŸÄ± var',
        sheetName: sheet.getName(),
        columnCount: sheet.getLastColumn(),
        headers: headers,
        issues: issues
      };
      
    } catch (error) {
      return {
        isValid: false,
        message: 'Sheet kontrol hatasÄ±: ' + error.message,
        sheetName: this.SHEET_NAME,
        error: error.toString()
      };
    }
  }
};

/**
 * ALTIN FÄ°YATLARINI SHEET'E YAZ (Ana fonksiyon)
 * Her zaman 2. satÄ±rdan baÅŸlar, duplicate kontrolÃ¼ yapar
 */
function save_Altin_Fiyatlari_To_Sheet() {
  console.log('ğŸš€ AltÄ±n fiyatlarÄ± sheet\'e yazÄ±lÄ±yor...');
  
  // 1. Ã–nce sheet yapÄ±sÄ±nÄ± kontrol et
  console.log('\n1ï¸âƒ£ Sheet YapÄ±sÄ± KontrolÃ¼:');
  const structureCheck = GoldHistoryService.checkSheetStructure();
  
  if (!structureCheck.isValid && structureCheck.message !== 'Sheet boÅŸ, baÅŸlÄ±klarÄ± ekleyin') {
    console.warn(`âš ï¸ Sheet yapÄ±sÄ± uygun deÄŸil: ${structureCheck.message}`);
    console.log('   Devam etmek istiyor musunuz? BaÅŸlÄ±klar:');
    console.log('   Sembol | Tarih | AÃ§Ä±lÄ±ÅŸ | En YÃ¼ksek | En DÃ¼ÅŸÃ¼k | KapanÄ±ÅŸ | Hacim | Kaynak');
  }
  
  // 2. API baÄŸlantÄ± testi
  console.log('\n2ï¸âƒ£ API BaÄŸlantÄ± Testi:');
  const apiTest = GoldService.testConnection();
  
  if (!apiTest.success) {
    console.error(`âŒ API hatasÄ±: ${apiTest.message}`);
    return { success: false, step: 'api_test', error: apiTest.message };
  }
  
  console.log(`âœ… API baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ± (${apiTest.data.diffMinutes} dakika Ã¶nce gÃ¼ncellenmiÅŸ)`);
  
  // 3. FiyatlarÄ± sheet'e yaz
  console.log('\n3ï¸âƒ£ Sheet\'e Yazma Ä°ÅŸlemi:');
  const writeResult = GoldHistoryService.saveTodayPricesToHisseSheet();
  
  // 4. SonuÃ§larÄ± gÃ¶ster
  console.log('\n4ï¸âƒ£ SONUÃ‡:');
  console.log(JSON.stringify(writeResult, null, 2));
  
  if (writeResult.success) {
    console.log(`ğŸ‰ ${writeResult.newRecords} yeni kayÄ±t eklendi!`);
    console.log(`   ğŸ“ SatÄ±r: ${writeResult.startRow}-${writeResult.endRow}`);
    
    // Ek bilgiler
    const goldData = GoldService.getGoldPrices();
    console.log(`   ğŸ“Š Toplam ${Object.keys(goldData.prices || {}).length} altÄ±n tÃ¼rÃ¼ iÅŸlendi`);
  }
  
  return writeResult;
}

/**
 * Sheet'i hazÄ±rla (baÅŸlÄ±klarÄ± ekle)
 * BU FONKSÄ°YONU SADECE Ä°LK KEZ Ã‡ALIÅTIR
 */
function setup_Altin_Sheet_Headers() {
  console.log('ğŸ› ï¸ AltÄ±n Sheet BaÅŸlÄ±klarÄ± HazÄ±rlanÄ±yor...');
  
  try {
    const ss = SpreadsheetApp.getActive();
    const sheetName = GoldHistoryService.SHEET_NAME;
    let sheet = ss.getSheetByName(sheetName);
    
    if (!sheet) {
      sheet = ss.insertSheet(sheetName);
      console.log(`âœ… Yeni sheet oluÅŸturuldu: "${sheetName}"`);
    }
    
    // HISSE_GECMIS_GUNLUK ile TAMAMEN AYNI baÅŸlÄ±klar
    const headers = [
      ['Sembol', 'Tarih', 'AÃ§Ä±lÄ±ÅŸ (Open)', 'En YÃ¼ksek (High)', 'En DÃ¼ÅŸÃ¼k (Low)', 'KapanÄ±ÅŸ (Close)', 'Hacim (Volume)', 'Kaynak']
    ];
    
    // BaÅŸlÄ±klarÄ± 1. satÄ±ra yaz
    sheet.getRange(1, 1, 1, headers[0].length)
         .setValues(headers)
         .setFontWeight('bold')
         .setBackground('#f3f3f3');
    
    // Kolon geniÅŸliklerini ayarla
    sheet.setColumnWidth(1, 120);  // Sembol
    sheet.setColumnWidth(2, 100);  // Tarih
    sheet.setColumnWidth(3, 100);  // AÃ§Ä±lÄ±ÅŸ
    sheet.setColumnWidth(4, 100);  // En YÃ¼ksek
    sheet.setColumnWidth(5, 100);  // En DÃ¼ÅŸÃ¼k
    sheet.setColumnWidth(6, 100);  // KapanÄ±ÅŸ
    sheet.setColumnWidth(7, 100);  // Hacim
    sheet.setColumnWidth(8, 120);  // Kaynak
    
    console.log('âœ… BaÅŸlÄ±klar eklendi:');
    headers[0].forEach((h, i) => console.log(`   ${i+1}. ${h}`));
    console.log('\nğŸ“Œ NOT: ArtÄ±k "save_Altin_Fiyatlari_To_Sheet()" fonksiyonunu kullanabilirsiniz.');
    
    return {
      success: true,
      message: 'BaÅŸlÄ±klar eklendi',
      sheetName: sheet.getName(),
      headers: headers[0]
    };
    
  } catch (error) {
    console.error('ğŸ’¥ BaÅŸlÄ±k ekleme hatasÄ±:', error);
    return { success: false, message: 'Hata: ' + error.message };
  }
}

/**
 * TEST: TÃ¼m sÃ¼reci test et
 */
function test_Full_Altin_Sheet_Process() {
  console.log('ğŸ§ª TAM ALTIN SHEET SÃœREÃ‡ TESTÄ°');
  console.log('='.repeat(50));
  
  // 1. Sheet'i kontrol et veya oluÅŸtur
  console.log('\n1ï¸âƒ£ SHEET HAZIRLIK:');
  const sheetCheck = GoldHistoryService.checkSheetStructure();
  
  if (!sheetCheck.isValid) {
    console.log(`â„¹ï¸ ${sheetCheck.message}`);
    console.log('   BaÅŸlÄ±klarÄ± otomatik eklemek ister misiniz?');
    console.log('   "setup_Altin_Sheet_Headers()" fonksiyonunu Ã§alÄ±ÅŸtÄ±rÄ±n.');
  } else {
    console.log(`âœ… Sheet hazÄ±r: ${sheetCheck.columnCount} sÃ¼tunlu`);
  }
  
  // 2. API testi
  console.log('\n2ï¸âƒ£ API TESTÄ°:');
  const apiTest = GoldService.testConnection();
  console.log(apiTest.success ? `âœ… ${apiTest.message}` : `âŒ ${apiTest.message}`);
  
  if (apiTest.success && apiTest.data.sampleAltin) {
    console.log(`   Ã–rnek: ${apiTest.data.sampleAltin.AlÄ±ÅŸ} / ${apiTest.data.sampleAltin.SatÄ±ÅŸ}`);
  }
  
  // 3. FiyatlarÄ± yaz
  console.log('\n3ï¸âƒ£ SHEET\'E YAZMA TESTÄ°:');
  const writeResult = GoldHistoryService.saveTodayPricesToHisseSheet();
  
  console.log('\n4ï¸âƒ£ SONUÃ‡:');
  if (writeResult.success) {
    console.log(`âœ… BAÅARILI! ${writeResult.newRecords} kayÄ±t eklendi`);
    if (writeResult.skippedRecords > 0) {
      console.log(`   (${writeResult.skippedRecords} kayÄ±t zaten mevcuttu)`);
    }
  } else {
    console.error(`âŒ HATA: ${writeResult.message}`);
  }
  
  console.log('\n' + '='.repeat(50));
  console.log('ğŸ‰ TEST TAMAMLANDI');
  
  return {
    sheetReady: sheetCheck.isValid,
    apiReady: apiTest.success,
    writeSuccess: writeResult.success,
    newRecords: writeResult.newRecords || 0
  };
}

/**
 * Parse hatasÄ±nÄ± debug et
 */
function debug_Altin_Parse_Issue() {
  console.log('ğŸ”§ ALTIN PARSE HATA AYIKLAMA');
  console.log('='.repeat(60));
  
  // 1. API testi
  console.log('\n1ï¸âƒ£ API TESTÄ°:');
  const apiTest = GoldService.testConnection();
  console.log(apiTest.success ? 'âœ… ' + apiTest.message : 'âŒ ' + apiTest.message);
  
  // 2. Ã–rnek parse testleri
  console.log('\n2ï¸âƒ£ PARSE TESTLERÄ°:');
  
  const testCases = [
    { input: '7.094,49', expected: 7094.49, desc: 'Gram AltÄ±n' },
    { input: '5.062,12', expected: 5062.12, desc: 'Ons AltÄ±n ($ olmadan)' },
    { input: '$5.062,12', expected: 5062.12, desc: 'Ons AltÄ±n ($ ile)' },
    { input: '43,5888', expected: 43.5888, desc: 'Dolar' },
    { input: '1.166.504,00', expected: 1166504, desc: 'Ã‡eyrek AltÄ±n' },
    { input: '11.646,00', expected: 11646, desc: 'GÃ¼mÃ¼ÅŸ' }
  ];
  
  testCases.forEach(test => {
    const result = GoldService._parsePriceString(test.input);
    const isCorrect = Math.abs(result - test.expected) < 0.01;
    
    console.log(`   ${isCorrect ? 'âœ…' : 'âŒ'} ${test.desc}:`);
    console.log(`      GiriÅŸ: "${test.input}"`);
    console.log(`      Ã‡Ä±ktÄ±: ${result}`);
    console.log(`      Beklenen: ${test.expected}`);
    console.log(`      Fark: ${Math.abs(result - test.expected)}`);
    
    if (!isCorrect) {
      console.warn(`      âš ï¸ HATA! 100 katÄ± mÄ±? ${result / 100}`);
    }
  });
  
  // 3. GerÃ§ek API verilerini test et
  console.log('\n3ï¸âƒ£ GERÃ‡EK API VERÄ°LERÄ°:');
  
  try {
    const allData = GoldService.getAllPrices();
    const goldData = allData.altinlar;
    
    console.log(`   Toplam ${Object.keys(goldData).length} altÄ±n tÃ¼rÃ¼`);
    
    // Ä°lk 5 altÄ±n tÃ¼rÃ¼nÃ¼ kontrol et
    Object.keys(goldData).slice(0, 5).forEach(key => {
      const item = goldData[key];
      const expectedBuying = GoldHistoryService._calculateExpectedValue(item.buyingRaw);
      const diff = Math.abs(item.buying - expectedBuying);
      
      console.log(`   ${key}:`);
      console.log(`      Orijinal: "${item.buyingRaw}"`);
      console.log(`      Parse: ${item.buying}`);
      console.log(`      Beklenen: ${expectedBuying}`);
      console.log(`      Fark: ${diff} ${diff > 1 ? 'âš ï¸' : 'âœ…'}`);
      
      if (diff > 1) {
        const ratio = item.buying / expectedBuying;
        console.log(`      Oran: ${ratio}x (${ratio === 100 ? '100 KATI!' : 'farklÄ±'})`);
      }
    });
    
  } catch (error) {
    console.error('   âŒ API verileri alÄ±namadÄ±:', error.message);
  }
  
  // 4. Sheet kontrolÃ¼
  console.log('\n4ï¸âƒ£ SHEET KONTROLÃœ:');
  
  try {
    const ss = SpreadsheetApp.getActive();
    const sheet = ss.getSheetByName('ALTIN_GECMIS_GUNLUK');
    
    if (sheet) {
      console.log(`   Sheet: "${sheet.getName()}"`);
      console.log(`   SatÄ±r sayÄ±sÄ±: ${sheet.getLastRow()}`);
      
      if (sheet.getLastRow() > 1) {
        // Son 3 kaydÄ± gÃ¶ster
        const startRow = Math.max(2, sheet.getLastRow() - 2);
        const range = sheet.getRange(startRow, 1, Math.min(3, sheet.getLastRow() - 1), 8);
        const values = range.getValues();
        
        console.log('   Son 3 kayÄ±t:');
        values.forEach((row, idx) => {
          console.log(`      ${startRow + idx}. ${row[0]}: ${row[2]} (AÃ§Ä±lÄ±ÅŸ)`);
        });
      }
    } else {
      console.log('   âŒ Sheet bulunamadÄ±');
    }
  } catch (error) {
    console.log('   âŒ Sheet okunamadÄ±:', error.message);
  }
  
  console.log('\n' + '='.repeat(60));
  console.log('ğŸ¯ SONUÃ‡: Debug tamamlandÄ±. YukarÄ±daki loglarÄ± kontrol edin.');
  
  return { success: true };
}
