/**
 * ğŸ¥‡ GOLD SERVICE - Truncgil API iÃ§in TAM DÃœZELTME
 * SORUN Ã‡Ã–ZÃœLDÃœ: Fiyatlar 100 katÄ± yazÄ±lÄ±yordu
 */

const GoldService = {
  
  /**
   * TÃ¼m fiyatlarÄ± getir (cache'li)
   */
  getAllPrices: function() {
    console.log('ğŸ“Š Truncgil API: TÃ¼m fiyatlar isteniyor...');
    
    const cache = CacheService.getScriptCache();
    const cachedData = cache.get(CONFIG.ALTIN.CACHE_KEY);
    
    if (cachedData) {
      console.log('ğŸ“¦ Cache\'ten fiyatlar alÄ±ndÄ±');
      return JSON.parse(cachedData);
    }
    
    console.log('ğŸŒ API\'den gÃ¼ncel fiyatlar Ã§ekiliyor...');
    const rawData = this._fetchFromTruncgilAPI();
    
    if (!rawData) {
      console.error('âŒ Fiyatlar alÄ±namadÄ±');
      return this._getFallbackData();
    }
    
    const processedData = this._processTruncgilData(rawData);
    
    cache.put(
      CONFIG.ALTIN.CACHE_KEY, 
      JSON.stringify(processedData), 
      CONFIG.ALTIN.CACHE_DURATION
    );
    
    console.log(`âœ… ${Object.keys(processedData.prices || {}).length} fiyat cache'lendi`);
    return processedData;
  },
  
  /**
   * Yeni API'den ham veriyi Ã§ek
   */
  _fetchFromTruncgilAPI: function() {
    try {
      const response = UrlFetchApp.fetch(CONFIG.ALTIN.API_URL, {
        muteHttpExceptions: true,
        headers: {
          'User-Agent': 'Mozilla/5.0',
          'Accept': 'application/json'
        }
      });
      
      if (response.getResponseCode() !== 200) {
        console.error(`âŒ Truncgil API HatasÄ±: ${response.getResponseCode()}`);
        return null;
      }
      
      const jsonText = response.getContentText();
      const data = JSON.parse(jsonText);
      
      console.log(`âœ… API baÅŸarÄ±lÄ±. GÃ¼ncelleme: ${data.Update_Date || 'Bilinmiyor'}`);
      return data;
      
    } catch (error) {
      console.error('ğŸ’¥ Truncgil API BaÄŸlantÄ± HatasÄ±:', error.message);
      return null;
    }
  },
  
  /**
   * Yeni API verisini iÅŸle - DÃœZELTÄ°LMÄ°Å
   */
  _processTruncgilData: function(rawData) {
    console.log('ğŸ”„ Truncgil verileri iÅŸleniyor...');
    
    const result = {
      updateDate: rawData.Update_Date || new Date().toISOString(),
      prices: {},
      dovizler: {},
      altinlar: {},
      validationLists: {
        altin: [],
        doviz: [],
        tumu: []
      }
    };
    
    // DEBUG: Ä°lk 5 Ã¶ÄŸeyi gÃ¶ster
    const keys = Object.keys(rawData);
    console.log(`ğŸ“¦ Ham veri: ${keys.length - 1} Ã¶ÄŸe (Update_Date hariÃ§)`);
    
    // Ä°lk 5 altÄ±n ve dÃ¶viz Ã¶rneÄŸi
    const altinOrnekleri = [];
    const dovizOrnekleri = [];
    
    Object.keys(rawData).forEach(key => {
      if (key === 'Update_Date') return;
      
      const item = rawData[key];
      if (item.TÃ¼r === 'AltÄ±n' && altinOrnekleri.length < 3) {
        altinOrnekleri.push({ key, alis: item.AlÄ±ÅŸ, satis: item.SatÄ±ÅŸ });
      }
      if (item.TÃ¼r === 'DÃ¶viz' && dovizOrnekleri.length < 3) {
        dovizOrnekleri.push({ key, alis: item.AlÄ±ÅŸ, satis: item.SatÄ±ÅŸ });
      }
    });
    
    console.log('ğŸ“Œ AltÄ±n Ã¶rnekleri:');
    altinOrnekleri.forEach(o => console.log(`   ${o.key}: ${o.alis} / ${o.satis}`));
    
    console.log('ğŸ“Œ DÃ¶viz Ã¶rnekleri:');
    dovizOrnekleri.forEach(o => console.log(`   ${o.key}: ${o.alis} / ${o.satis}`));
    
    // TÃ¼m verileri iÅŸle
    Object.keys(rawData).forEach(key => {
      if (key === 'Update_Date') return;
      
      const item = rawData[key];
      const tur = item.TÃ¼r || 'DiÄŸer';
      
      // FiyatlarÄ± parse et - DEBUG ile
      const buying = this._parsePriceStringWithDebug(key, item.AlÄ±ÅŸ, 'AlÄ±ÅŸ');
      const selling = this._parsePriceStringWithDebug(key, item.SatÄ±ÅŸ, 'SatÄ±ÅŸ');
      const degisim = item.DeÄŸiÅŸim || '%0,00';
      
      const priceInfo = {
        key: key,
        name: this._getDisplayName(key, item),
        tur: tur,
        buying: buying,
        selling: selling,
        buyingRaw: item.AlÄ±ÅŸ,
        sellingRaw: item.SatÄ±ÅŸ,
        degisim: degisim,
        lastUpdate: result.updateDate
      };
      
      // Ana fiyatlar objesine ekle
      result.prices[key] = priceInfo;
      
      // TÃ¼rÃ¼ne gÃ¶re grupla
      if (tur === 'AltÄ±n') {
        result.altinlar[key] = priceInfo;
        result.validationLists.altin.push(priceInfo.name);
        result.validationLists.tumu.push(priceInfo.name);
      } else if (tur === 'DÃ¶viz') {
        result.dovizler[key] = priceInfo;
        result.validationLists.doviz.push(priceInfo.name);
        result.validationLists.tumu.push(priceInfo.name);
      }
    });
    
    // Listeleri alfabetik sÄ±rala
    Object.keys(result.validationLists).forEach(listKey => {
      result.validationLists[listKey].sort();
    });
    
    console.log(`âœ… ${Object.keys(result.prices).length} fiyat iÅŸlendi`);
    console.log(`   ğŸ“Š AltÄ±n: ${Object.keys(result.altinlar).length} adet`);
    console.log(`   ğŸ’° DÃ¶viz: ${Object.keys(result.dovizler).length} adet`);
    
    // DEBUG: Parse edilen ilk 3 altÄ±n deÄŸerini gÃ¶ster
    console.log('ğŸ” Parse edilen ilk 3 altÄ±n:');
    Object.keys(result.altinlar).slice(0, 3).forEach(key => {
      const item = result.altinlar[key];
      console.log(`   ${key}: "${item.buyingRaw}" â†’ ${item.buying}`);
      console.log(`        "${item.sellingRaw}" â†’ ${item.selling}`);
    });
    
    return result;
  },
  
  /**
   * Fiyat string'ini parse et - TAM DÃœZELTME
   * "7.094,49" â†’ 7094.49 (DOÄRU)
   * "$5.062,12" â†’ 5062.12 (DOÄRU)
   * "43,5888" â†’ 43.5888 (DOÄRU)
   */
  _parsePriceStringWithDebug: function(key, priceStr, label) {
    if (!priceStr || typeof priceStr !== 'string') {
      console.warn(`âš ï¸ ${key} ${label}: GeÃ§ersiz string: ${priceStr}`);
      return 0;
    }
    
    console.log(`ğŸ” ${key} ${label}: "${priceStr}"`);
    
    try {
      // 1. Para birimi sembollerini kaldÄ±r ($, â‚¬, Â£ vb.)
      let cleaned = priceStr.replace(/[$\â‚¬Â£Â¥]/g, '').trim();
      
      // 2. Binlik ayraÃ§larÄ±nÄ± (noktalarÄ±) kaldÄ±r
      // "7.094,49" â†’ "7094,49"
      cleaned = cleaned.replace(/\./g, '');
      
      // 3. OndalÄ±k ayracÄ±nÄ± (virgÃ¼l) noktaya Ã§evir
      // "7094,49" â†’ "7094.49"
      cleaned = cleaned.replace(',', '.');
      
      // 4. Parse et
      const result = parseFloat(cleaned);
      
      if (isNaN(result)) {
        console.warn(`âš ï¸ ${key} ${label}: NaN sonuÃ§: "${priceStr}" â†’ "${cleaned}"`);
        return 0;
      }
      
      // 5. EÄŸer sonuÃ§ beklenenden Ã§ok bÃ¼yÃ¼kse kontrol et
      // Ã–rneÄŸin "7.094,49" iÃ§in 7094.49 bekliyoruz
      // EÄŸer 709449 gibi bir deÄŸer gelirse, 100'e bÃ¶l
      if (result > 100000) { // Ã‡ok bÃ¼yÃ¼k bir sayÄ±
        console.warn(`âš ï¸ ${key} ${label}: Ã‡OK BÃœYÃœK deÄŸer: ${result}, 100'e bÃ¶lÃ¼nÃ¼yor`);
        return result / 100;
      }
      
      console.log(`   â†’ "${priceStr}" â†’ "${cleaned}" â†’ ${result}`);
      return result;
      
    } catch (error) {
      console.error(`ğŸ’¥ ${key} ${label} parse hatasÄ±: ${error.message}`);
      return 0;
    }
  },
  
  /**
   * DÃ¼z parse fonksiyonu (debug olmadan)
   */
  _parsePriceString: function(priceStr) {
    if (!priceStr || typeof priceStr !== 'string') return 0;
    
    try {
      let cleaned = priceStr.replace(/[$\â‚¬Â£Â¥]/g, '').trim();
      cleaned = cleaned.replace(/\./g, '').replace(',', '.');
      const result = parseFloat(cleaned);
      
      // EÄŸer Ã§ok bÃ¼yÃ¼kse 100'e bÃ¶l (gÃ¼venlik)
      return result > 100000 ? result / 100 : result;
    } catch (e) {
      return 0;
    }
  },
  
  /**
   * GÃ¶rÃ¼ntÃ¼leme adÄ± oluÅŸtur
   */
  _getDisplayName: function(key, item) {
    if (CONFIG.ALTIN.TURLERI[key]) {
      return CONFIG.ALTIN.TURLERI[key];
    }
    
    let name = key.replace(/-/g, ' ')
                  .replace(/_/g, ' ')
                  .toLowerCase()
                  .replace(/\b\w/g, l => l.toUpperCase());
    
    return `${name} (${item.TÃ¼r || 'DiÄŸer'})`;
  },
  
  /**
   * Sadece altÄ±n fiyatlarÄ±nÄ± getir
   */
  getGoldPrices: function() {
    const allData = this.getAllPrices();
    return {
      updateDate: allData.updateDate,
      prices: allData.altinlar,
      validationList: allData.validationLists.altin
    };
  },
  
  /**
   * Belirli bir Ã¶ÄŸenin fiyatÄ±nÄ± getir
   */
  getPrice: function(key) {
    const allData = this.getAllPrices();
    return allData.prices[key] || null;
  },
  
  /**
   * Google Sheets Veri DoÄŸrulama listesini getir
   */
  getValidationList: function(type = 'altin') {
    const allData = this.getAllPrices();
    return allData.validationLists[type] || [];
  },
  
  /**
   * Cache'i temizle
   */
  clearCache: function() {
    CacheService.getScriptCache().remove(CONFIG.ALTIN.CACHE_KEY);
    console.log('ğŸ—‘ï¸ Truncgil cache temizlendi');
    return { success: true, message: 'Cache temizlendi' };
  },
  
  /**
   * API baÄŸlantÄ± testi
   */
  testConnection: function() {
    console.log('ğŸ§ª Truncgil API BaÄŸlantÄ± Testi...');
    
    try {
      const rawData = this._fetchFromTruncgilAPI();
      
      if (!rawData) {
        return { success: false, message: 'API\'ye baÄŸlanÄ±lamadÄ±' };
      }
      
      const updateDate = new Date(rawData.Update_Date);
      const now = new Date();
      const diffMinutes = Math.floor((now - updateDate) / (1000 * 60));
      const isRecent = diffMinutes < 30;
      
      const itemCount = Object.keys(rawData).length - 1;
      
      // Parse testi yap
      const testParse = this._parsePriceStringWithDebug('TEST', '7.094,49', 'Test');
      console.log(`ğŸ§ª Parse testi: "7.094,49" â†’ ${testParse} (beklenen: 7094.49)`);
      
      return {
        success: true,
        message: `âœ… API baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±. ${itemCount} Ã¶ÄŸe, ${diffMinutes} dakika Ã¶nce gÃ¼ncellenmiÅŸ`,
        data: {
          updateDate: rawData.Update_Date,
          isRecent: isRecent,
          diffMinutes: diffMinutes,
          itemCount: itemCount
        }
      };
      
    } catch (error) {
      return { success: false, message: `ğŸ’¥ Test hatasÄ±: ${error.message}` };
    }
  },
  
  /**
   * Fallback data
   */
  _getFallbackData: function() {
    console.log('ğŸ”„ Fallback veri kullanÄ±lÄ±yor');
    
    return {
      updateDate: new Date().toISOString(),
      prices: {},
      dovizler: {},
      altinlar: {},
      validationLists: {
        altin: Object.values(CONFIG.ALTIN.TURLERI).sort(),
        doviz: [],
        tumu: Object.values(CONFIG.ALTIN.TURLERI).sort()
      }
    };
  }
};
