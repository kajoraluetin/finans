
/**
 * ğŸ¦ HISSE GEÃ‡MÄ°Å KAYIT SERVÄ°SÄ° (ABD + BIST)
 * ModÃ¼l 2: VeritabanÄ± Ä°ÅŸlemleri ve Senkronizasyon
 * BAÄIMLILIKLAR: YahooFinanceStockService.gs, DataReader.gs, CONFIG
 */

const HisseGecmisKayitService = {

  /**
   * ANA TETÄ°KLEYÄ°CÄ° - TÃ¼m hisseler (ABD + BIST)
   */
  syncAllStockHistory: function() {
    console.log('ğŸ“¥ HÄ°SSE GEÃ‡MÄ°Å SENKRONÄ°ZASYONU BAÅLADI (TÃ¼m Hisseler)');
    console.log('ğŸ“… Tarih:', new Date().toISOString());
    console.log('âš¡ Mod: TÃ¼m hisseler iÃ§in 3 aylÄ±k veri');

    const startTime = new Date();
    try {
      // 1. PortfÃ¶yÃ¼ oku
      console.log('ğŸ“– PortfÃ¶y okunuyor...');
      const portfolio = DataReader.readPortfolio();
      console.log(`ğŸ“¦ PortfÃ¶y kayÄ±t sayÄ±sÄ±: ${portfolio.length}`);

      // 2. TÃ¼m hisseleri ayÄ±kla (ABD + BIST)
      console.log('ğŸ” Hisseler ayÄ±klanÄ±yor...');
      const stocks = this._extractAllStocks(portfolio);
      console.log(`ğŸ“Œ Toplam hisse: ${stocks.length}`);
      
      if (stocks.length === 0) {
        console.log('âš ï¸ PortfÃ¶yde iÅŸlenecek hisse bulunamadÄ±!');
        return;
      }

      // 3. Sheet'i hazÄ±rla
      const ss = SpreadsheetApp.getActive();
      const sheetName = CONFIG.SHEETS.HISSE_GECMIS_GUNLUK?.NAME || 'HISSE_GECMIS_GUNLUK';
      const sheet = ss.getSheetByName(sheetName);
      
      if (!sheet) {
        console.error(`âŒ Sheet bulunamadÄ±: ${sheetName}`);
        return;
      }

      console.log(`ğŸ“ Hedef Sheet: ${sheetName} (${sheet.getLastRow()} satÄ±r mevcut)`);

      let totalWritten = 0;
      let totalFailed = 0;
      let successfulSymbols = [];
      let failedSymbols = [];

      // 4. Her hisseyi iÅŸle
      stocks.forEach((stock, index) => {
        console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log(`ğŸ“Š Ä°ÅLENÄ°YOR (${index + 1}/${stocks.length}) â†’ ${stock.symbol} (${stock.type})`);

        try {
          // a) Yahoo Finance'ten veri al
          const dailyData = YahooFinanceStockService.fetchDailyHistory(stock.yahooSymbol, '3mo');

          if (!dailyData || dailyData.length === 0) {
            console.warn(`âš ï¸ Veri yok â†’ ${stock.symbol}`);
            totalFailed++;
            failedSymbols.push(stock.symbol);
            return;
          }

          console.log(`ğŸ“¦ ${dailyData.length} gÃ¼nlÃ¼k veri alÄ±ndÄ±`);

          // b) Sheet'e yaz (duplicate kontrolÃ¼ ile)
          // Not: Sheet'e yazarken orijinal sembolÃ¼ kullan (yahooSymbol deÄŸil)
          const written = this._writeToSheet(sheet, stock.symbol, dailyData);
          
          if (written > 0) {
            totalWritten += written;
            successfulSymbols.push({
              symbol: stock.symbol,
              yahooSymbol: stock.yahooSymbol,
              type: stock.type,
              newRecords: written,
              firstDate: dailyData[0].tarih.toISOString().split('T')[0],
              lastDate: dailyData[dailyData.length-1].tarih.toISOString().split('T')[0]
            });
            console.log(`âœ… ${written} yeni kayÄ±t yazÄ±ldÄ±`);
          } else {
            console.log(`â­ï¸ Yeni kayÄ±t yok (tÃ¼m veriler zaten mevcut)`);
          }

        } catch (error) {
          console.error(`ğŸ’¥ ${stock.symbol} iÅŸlenirken hata:`, error.message);
          totalFailed++;
          failedSymbols.push(stock.symbol);
        }

        // c) Rate limit iÃ§in bekle (sadece sonraki hisse varsa)
        if (index < stocks.length - 1) {
          console.log('â³ 2 saniye bekleniyor...');
          Utilities.sleep(2000);
        }
      });

      // 5. Ã–zet gÃ¶ster
      const duration = (new Date().getTime() - startTime.getTime()) / 1000;
      
      console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('ğŸ“Š SENKRONÄ°ZASYON Ã–ZETÄ°');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log(`ğŸ“… Tarih: ${new Date().toISOString().split('T')[0]}`);
      console.log(`â±ï¸  SÃ¼re: ${duration.toFixed(1)} saniye`);
      console.log(`ğŸ“ˆ Toplam Hisse: ${stocks.length}`);
      console.log(`âœ… BaÅŸarÄ±lÄ±: ${successfulSymbols.length}`);
      console.log(`âŒ BaÅŸarÄ±sÄ±z: ${totalFailed}`);
      console.log(`ğŸ“ Yeni KayÄ±t: ${totalWritten}`);

      if (successfulSymbols.length > 0) {
        console.log('\nâœ… BAÅARILI HÄ°SSELER:');
        successfulSymbols.forEach(item => {
          console.log(`   ${item.symbol} (${item.type}) -> ${item.yahooSymbol}: ${item.newRecords} kayÄ±t (${item.firstDate} - ${item.lastDate})`);
        });
      }

      if (failedSymbols.length > 0) {
        console.log('\nâš ï¸ BAÅARISIZ HÄ°SSELER:');
        console.log(failedSymbols.join(', '));
        console.log('ğŸ’¡ Ä°pucu: Bu hisseler iÃ§in sembol kontrolÃ¼ yapÄ±n.');
      }

      // 6. Sheet istatistiklerini gÃ¶ster
      this._showSheetStats(sheet);

      console.log('\nğŸ‰ HÄ°SSE GEÃ‡MÄ°Å SENKRONÄ°ZASYONU TAMAMLANDI');

    } catch (error) {
      console.error('ğŸ’¥ GENEL SENKRONÄ°ZASYON HATASI', error);
    }
  },

  /**
   * PortfÃ¶yden tÃ¼m hisseleri ayÄ±kla (ABD + BIST)
   */
  _extractAllStocks: function(portfolio) {
    console.log('ğŸ” PortfÃ¶yden tÃ¼m hisseler ayÄ±klanÄ±yor...');

    const stockMap = new Map();
    
    portfolio.forEach(item => {
      if (!item.baslik || !item.kategori) return;

      const kategori = (item.kategori || '').toString().toUpperCase();
      const symbol = item.baslik.trim().toUpperCase();
      
      // ABD hisseleri (NASDAQ, NYSE, AMEX)
      if (kategori.includes('NASDAQ') || kategori.includes('NYSE') || kategori.includes('AMEX')) {
        const key = `USD-${symbol}`;
        if (!stockMap.has(key)) {
          stockMap.set(key, {
            symbol: symbol,
            yahooSymbol: symbol, // ABD hisseleri iÃ§in sembol aynÄ±
            type: 'ABD',
            kategori: item.kategori,
            birimi: item.birimi || 'USD'
          });
        }
      }
      // BIST hisseleri
      else if (kategori.includes('BIST')) {
        const key = `BIST-${symbol}`;
        if (!stockMap.has(key)) {
          stockMap.set(key, {
            symbol: symbol,
            yahooSymbol: symbol + '.IS', // BIST hisseleri iÃ§in .IS ekle
            type: 'BIST',
            kategori: item.kategori,
            birimi: item.birimi || 'TRY'
          });
        }
      }
    });

    const stocks = Array.from(stockMap.values());
    
    // Hisseleri grupla
    const usStocks = stocks.filter(s => s.type === 'ABD');
    const bistStocks = stocks.filter(s => s.type === 'BIST');
    
    console.log(`ğŸ“Œ Bulunan hisseler (${stocks.length} adet):`);
    console.log(`   ğŸ‡ºğŸ‡¸ ABD Hisseleri (${usStocks.length}): ${usStocks.map(s => s.symbol).join(', ')}`);
    console.log(`   ğŸ‡¹ğŸ‡· BIST Hisseleri (${bistStocks.length}): ${bistStocks.map(s => s.symbol).join(', ')}`);
    
    return stocks;
  },

  /**
   * Sadece ABD hisselerini ayÄ±kla (eski fonksiyon, geriye uyumluluk iÃ§in)
   */
  _extractUSDStocks: function(portfolio) {
    return this._extractAllStocks(portfolio).filter(stock => stock.type === 'ABD');
  },

  /**
   * Sheet'e yaz (duplicate kontrolÃ¼ ile)
   */
  _writeToSheet: function(sheet, symbol, dailyData) {
    console.log(`   ğŸ“ ${symbol} verileri sheet'e yazÄ±lÄ±yor...`);

    // Mevcut kayÄ±tlarÄ± al (Sembol + Tarih)
    const existing = this._getExistingRecords(sheet);
    
    const rowsToWrite = [];
    const today = new Date();
    
    dailyData.forEach(d => {
      const tarih = new Date(d.tarih);
      
      // Gelecek tarihleri atla
      if (tarih > today) return;
      
      const tarihStr = Utilities.formatDate(tarih, 'GMT', 'yyyy-MM-dd');
      const key = `${symbol}_${tarihStr}`;
      
      // Duplicate kontrolÃ¼
      if (existing.has(key)) {
        return;
      }

      rowsToWrite.push([
        symbol,
        tarih, // Tarih
        d.open || 0,
        d.high || 0,
        d.low || 0,
        d.close || 0,
        d.volume || 0,
        'YahooFinance', // Kaynak
        new Date() // Eklenme tarihi
      ]);
    });

    if (rowsToWrite.length === 0) {
      console.log(`   â­ï¸ ${symbol}: TÃ¼m veriler zaten mevcut`);
      return 0;
    }

    // Sheet'e yaz
    const startRow = sheet.getLastRow() + 1;
    const range = sheet.getRange(startRow, 1, rowsToWrite.length, 9); // 9 sÃ¼tun
    range.setValues(rowsToWrite);
    
    // Tarih sÃ¼tununu formatla
    const dateRange = sheet.getRange(startRow, 2, rowsToWrite.length, 1);
    dateRange.setNumberFormat('YYYY-MM-DD');
    
    console.log(`   âœ… ${symbol}: ${rowsToWrite.length} kayÄ±t eklendi (satÄ±r ${startRow}-${startRow + rowsToWrite.length - 1})`);
    
    return rowsToWrite.length;
  },

  /**
   * Sheet'teki mevcut kayÄ±tlarÄ± getir
   */
  _getExistingRecords: function(sheet) {
    const existingMap = new Map();
    
    if (sheet.getLastRow() <= 1) {
      return existingMap;
    }
    
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 2).getValues();
    
    data.forEach(row => {
      const symbol = row[0];
      const date = row[1];
      
      if (symbol && date instanceof Date) {
        const key = `${symbol}_${Utilities.formatDate(date, 'GMT', 'yyyy-MM-dd')}`;
        existingMap.set(key, true);
      }
    });
    
    return existingMap;
  },

  /**
   * Sheet istatistiklerini gÃ¶ster
   */
  _showSheetStats: function(sheet) {
    console.log('\nğŸ“Š SHEET Ä°STATÄ°STÄ°KLERÄ°:');
    console.log(`   Sheet: ${sheet.getName()}`);
    console.log(`   Toplam SatÄ±r: ${sheet.getLastRow()}`);
    
    if (sheet.getLastRow() > 1) {
      // Hisselere gÃ¶re grupla
      const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 2).getValues();
      const symbolCounts = {};
      
      data.forEach(row => {
        const symbol = row[0];
        if (symbol) {
          symbolCounts[symbol] = (symbolCounts[symbol] || 0) + 1;
        }
      });
      
      console.log(`   KayÄ±tlÄ± Hisse SayÄ±sÄ±: ${Object.keys(symbolCounts).length}`);
      
      // En Ã§ok kaydÄ± olan 5 hisse
      const sortedSymbols = Object.entries(symbolCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      
      console.log('   ğŸ“ˆ En Ã‡ok KayÄ±tlÄ± 5 Hisse:');
      sortedSymbols.forEach(([symbol, count], index) => {
        console.log(`      ${index + 1}. ${symbol}: ${count} kayÄ±t`);
      });
    }
  },

  /**
   * GÃœNLÃœK GÃœNCELLEME - TÃ¼m hisseler (ABD + BIST)
   */
  updateAllStocks: function() {
    console.log('ğŸ”„ TÃœM HÄ°SSE GÃœNCELLEMESÄ° BAÅLADI');
    console.log('ğŸ“… Tarih:', new Date().toISOString());

    const startTime = new Date();
    try {
      // 1. PortfÃ¶y ve hisseler
      const portfolio = DataReader.readPortfolio();
      const stocks = this._extractAllStocks(portfolio);
      
      console.log(`ğŸ“¦ Ä°ÅŸlenecek hisse: ${stocks.length}`);

      if (stocks.length === 0) {
        console.log('â„¹ï¸ GÃ¼ncellenecek hisse yok');
        return;
      }

      // 2. Sheet
      const ss = SpreadsheetApp.getActive();
      const sheetName = CONFIG.SHEETS.HISSE_GECMIS_GUNLUK?.NAME || 'HISSE_GECMIS_GUNLUK';
      const sheet = ss.getSheetByName(sheetName);
      
      if (!sheet) {
        console.error(`âŒ Sheet bulunamadÄ±: ${sheetName}`);
        return;
      }

      let updatedCount = 0;
      let skippedCount = 0;
      let failedCount = 0;
      let totalNewRecords = 0;

      // 3. Her hisse iÃ§in
      stocks.forEach((stock, index) => {
        console.log(`\nğŸ“Š ${index + 1}/${stocks.length}: ${stock.symbol} (${stock.type})`);
        
        try {
          // a) Son tarihi kontrol et
          const lastDate = this._getLastDateForSymbol(sheet, stock.symbol);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          
          // b) GÃ¼ncel mi kontrol et
          if (lastDate) {
            const daysDiff = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
            
            if (daysDiff <= 1) {
              console.log(`   â­ï¸ Zaten gÃ¼ncel (son tarih: ${lastDate.toISOString().split('T')[0]})`);
              skippedCount++;
              return;
            }
            
            console.log(`   ğŸ“… Son kayÄ±t: ${lastDate.toISOString().split('T')[0]} (${daysDiff} gÃ¼n Ã¶nce)`);
          }
          
          // c) KaÃ§ gÃ¼nlÃ¼k veri Ã§ekeceÄŸini belirle
          const range = this._calculateDateRange(lastDate);
          console.log(`   ğŸ” ${range} veri aranÄ±yor...`);
          
          // d) Veriyi al (Yahoo sembolÃ¼ ile)
          const allData = YahooFinanceStockService.fetchDailyHistory(stock.yahooSymbol, range);
          
          if (!allData || allData.length === 0) {
            console.log(`   âš ï¸ Veri alÄ±namadÄ±`);
            failedCount++;
            return;
          }
          
          // e) Yeni verileri filtrele
          const newData = lastDate 
            ? allData.filter(item => new Date(item.tarih) > lastDate)
            : allData;
          
          console.log(`   ğŸ“¦ ${allData.length} gÃ¼n veriden ${newData.length} yeni`);
          
          if (newData.length === 0) {
            console.log(`   â­ï¸ Yeni veri yok`);
            skippedCount++;
            return;
          }
          
          // f) Sheet'e yaz (orijinal sembol ile)
          const written = this._writeToSheet(sheet, stock.symbol, newData);
          
          if (written > 0) {
            console.log(`   âœ… ${written} yeni kayÄ±t eklendi`);
            updatedCount++;
            totalNewRecords += written;
          }
          
        } catch (error) {
          console.error(`   ğŸ’¥ Hata: ${error.message}`);
          failedCount++;
        }
        
        // g) Bekleme
        if (index < stocks.length - 1) {
          Utilities.sleep(2000);
        }
      });

      // 4. Ã–zet
      const duration = (new Date().getTime() - startTime.getTime()) / 1000;
      
      console.log('\nğŸ“Š GÃœNCELLEME Ã–ZETÄ°');
      console.log({
        toplamHisse: stocks.length,
        guncellenen: updatedCount,
        atlanan: skippedCount,
        hatali: failedCount,
        yeniKayit: totalNewRecords,
        toplamSureSn: duration.toFixed(1)
      });

      console.log('âœ… TÃœM HÄ°SSE GÃœNCELLEMESÄ° TAMAMLANDI');

    } catch (error) {
      console.error('ğŸ’¥ GÃ¼ncelleme hatasÄ±:', error);
    }
  },

  /**
   * Bir hissenin sheet'teki en son tarihini bul
   */
  _getLastDateForSymbol: function(sheet, symbol) {
    if (sheet.getLastRow() <= 1) return null;
    
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 2).getValues();
    
    let lastDate = null;
    for (const row of data) {
      if (row[0] === symbol && row[1] instanceof Date) {
        const date = new Date(row[1]);
        if (!lastDate || date > lastDate) {
          lastDate = date;
        }
      }
    }
    
    return lastDate;
  },

  /**
   * Ne kadar veri Ã§ekileceÄŸini hesapla
   */
  _calculateDateRange: function(lastDate) {
    if (!lastDate) return '3mo'; // HiÃ§ veri yoksa 3 ay
    
    const today = new Date();
    const daysSinceLast = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
    
    if (daysSinceLast > 90) return '3mo';
    if (daysSinceLast > 30) return '1mo';
    if (daysSinceLast > 7) return '5d';
    return '5d'; // VarsayÄ±lan
  }
};

/**
 * ğŸ§ª HÄ°SSE GEÃ‡MÄ°Å KAYIT SERVÄ°SÄ° TESTÄ° - GERÃ‡EK VERÄ°LER
 * 
 * AMAÃ‡:
 * - Hisse geÃ§miÅŸ servisinin tÃ¼m fonksiyonlarÄ±nÄ± gerÃ§ek verilerle test et
 * - Sheet'teki mevcut verileri analiz et
 * - BugÃ¼nÃ¼n verisi eksikse kontrol et
 * - PortfÃ¶ydeki hisseleri doÄŸru Ã§Ä±karÄ±p Ã§Ä±karmadÄ±ÄŸÄ±nÄ± test et
 */
function test_HisseGecmisKayitService_RealData() {
  console.log('='.repeat(70));
  console.log('ğŸ§ª HÄ°SSE GEÃ‡MÄ°Å KAYIT SERVÄ°SÄ° TESTÄ° - GERÃ‡EK VERÄ°LER');
  console.log('='.repeat(70));
  
  const startTime = new Date();
  const testResults = {
    totalTests: 0,
    passed: 0,
    failed: 0,
    warnings: 0,
    errors: []
  };
  
  try {
    // 1. SERVÄ°S KONTROLÃœ
    console.log('\n1ï¸âƒ£ SERVÄ°S KONTROLÃœ');
    testResults.totalTests++;
    
    if (typeof HisseGecmisKayitService === 'undefined') {
      console.log('âŒ HisseGecmisKayitService tanÄ±mlÄ± deÄŸil!');
      testResults.failed++;
      testResults.errors.push('HisseGecmisKayitService nesnesi bulunamadÄ±');
      return testResults;
    }
    
    console.log('âœ… HisseGecmisKayitService mevcut');
    testResults.passed++;
    
    // 2. PORTFÃ–Y OKUMA VE HÄ°SSE AYIKLAMA TESTÄ°
    console.log('\n2ï¸âƒ£ PORTFÃ–Y OKUMA VE HÄ°SSE AYIKLAMA TESTÄ°');
    testResults.totalTests++;
    
    try {
      console.log('ğŸ“– PortfÃ¶y okunuyor...');
      const portfolio = DataReader.readPortfolio();
      
      if (!portfolio || portfolio.length === 0) {
        console.log('âš ï¸ PortfÃ¶y boÅŸ, bazÄ± testler atlanacak');
        testResults.warnings++;
      } else {
        console.log(`âœ… ${portfolio.length} portfÃ¶y kaydÄ± okundu`);
        
        // Hisseleri ayÄ±kla
        console.log('ğŸ” Hisseler ayÄ±klanÄ±yor...');
        const stocks = HisseGecmisKayitService._extractAllStocks(portfolio);
        
        console.log(`ğŸ“Œ ${stocks.length} hisse bulundu:`);
        
        // ABD ve BIST hisselerini ayÄ±r
        const usStocks = stocks.filter(s => s.type === 'ABD');
        const bistStocks = stocks.filter(s => s.type === 'BIST');
        
        console.log(`   ğŸ‡ºğŸ‡¸ ABD Hisseleri: ${usStocks.length}`);
        usStocks.slice(0, 5).forEach((stock, i) => {
          console.log(`      ${i + 1}. ${stock.symbol} -> ${stock.yahooSymbol}`);
        });
        if (usStocks.length > 5) console.log(`      ... ve ${usStocks.length - 5} tane daha`);
        
        console.log(`\n   ğŸ‡¹ğŸ‡· BIST Hisseleri: ${bistStocks.length}`);
        bistStocks.slice(0, 5).forEach((stock, i) => {
          console.log(`      ${i + 1}. ${stock.symbol} -> ${stock.yahooSymbol}`);
        });
        if (bistStocks.length > 5) console.log(`      ... ve ${bistStocks.length - 5} tane daha`);
        
        testResults.passed++;
      }
    } catch (error) {
      console.log(`âŒ PortfÃ¶y okuma/hisse ayÄ±klama hatasÄ±: ${error.message}`);
      testResults.failed++;
      testResults.errors.push(`PortfÃ¶y hatasÄ±: ${error.message}`);
    }
    
    // 3. SHEET KONTROLÃœ
    console.log('\n3ï¸âƒ£ SHEET KONTROLÃœ');
    testResults.totalTests++;
    
    try {
      // Sheet adÄ±nÄ± CONFIG'ten al
      const sheetName = CONFIG?.SHEETS?.HISSE_GECMIS_GUNLUK?.NAME || 'HISSE_GECMIS_GUNLUK';
      console.log(`ğŸ“„ Sheet adÄ±: ${sheetName}`);
      
      const ss = SpreadsheetApp.getActive();
      const sheet = ss.getSheetByName(sheetName);
      
      if (!sheet) {
        console.log(`âŒ "${sheetName}" sheet'i bulunamadÄ±!`);
        console.log('â„¹ï¸ Sheet oluÅŸturmak iÃ§in: setup_Hisse_Sheet_Headers() fonksiyonunu Ã§alÄ±ÅŸtÄ±rÄ±n');
        testResults.failed++;
        testResults.errors.push(`Sheet bulunamadÄ±: ${sheetName}`);
      } else {
        const rowCount = sheet.getLastRow();
        const colCount = sheet.getLastColumn();
        
        console.log(`âœ… Sheet bulundu: ${rowCount} satÄ±r, ${colCount} sÃ¼tun`);
        
        // BaÅŸlÄ±klarÄ± kontrol et
        if (rowCount > 0) {
          const headers = sheet.getRange(1, 1, 1, colCount).getValues()[0];
          console.log(`ğŸ“‹ BaÅŸlÄ±klar: ${headers.join(' | ')}`);
          
          // Veri varsa analiz et
          if (rowCount > 1) {
            const dataCount = rowCount - 1;
            console.log(`ğŸ“Š Sheet'te ${dataCount} kayÄ±t var`);
            
            // Benzersiz hisseleri say
            if (dataCount > 0) {
              const symbolRange = sheet.getRange(2, 1, dataCount, 1);
              const symbols = symbolRange.getValues().flat();
              const uniqueSymbols = [...new Set(symbols.filter(s => s))];
              
              console.log(`ğŸ”¢ ${uniqueSymbols.length} benzersiz hisse`);
              
              // Her hisse iÃ§in kayÄ±t sayÄ±sÄ±
              const symbolCounts = {};
              symbols.forEach(symbol => {
                if (symbol) {
                  symbolCounts[symbol] = (symbolCounts[symbol] || 0) + 1;
                }
              });
              
              console.log('\nğŸ“ˆ HÄ°SSE BAZLI KAYIT DAÄILIMI (ilk 10):');
              Object.entries(symbolCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .forEach(([symbol, count], i) => {
                  console.log(`   ${i + 1}. ${symbol}: ${count} kayÄ±t`);
                });
              
              // Tarih aralÄ±ÄŸÄ±nÄ± kontrol et
              try {
                const dateRange = sheet.getRange(2, 2, dataCount, 1);
                const dates = dateRange.getValues().flat().filter(d => d instanceof Date);
                
                if (dates.length > 0) {
                  const minDate = new Date(Math.min(...dates.map(d => d.getTime())));
                  const maxDate = new Date(Math.max(...dates.map(d => d.getTime())));
                  const dayDiff = Math.floor((maxDate - minDate) / (1000 * 60 * 60 * 24));
                  
                  console.log(`\nğŸ“… TARÄ°H ARALIÄI:`);
                  console.log(`   En erken: ${Utilities.formatDate(minDate, 'GMT', 'dd.MM.yyyy')}`);
                  console.log(`   En geÃ§: ${Utilities.formatDate(maxDate, 'GMT', 'dd.MM.yyyy')}`);
                  console.log(`   GÃ¼n sayÄ±sÄ±: ${dayDiff}`);
                  
                  // BugÃ¼nÃ¼n tarihini kontrol et
                  const today = new Date();
                  today.setHours(0, 0, 0, 0);
                  const hasToday = dates.some(d => {
                    const date = new Date(d);
                    date.setHours(0, 0, 0, 0);
                    return date.getTime() === today.getTime();
                  });
                  
                  console.log(`   BugÃ¼nÃ¼n verisi: ${hasToday ? 'âœ… VAR' : 'âŒ YOK'}`);
                  
                  if (!hasToday) {
                    testResults.warnings++;
                    console.log('   âš ï¸ BugÃ¼nÃ¼n verisi eksik! GÃ¼ncelleme gerekli.');
                  }
                }
              } catch (dateError) {
                console.log(`â„¹ï¸ Tarih analizi hatasÄ±: ${dateError.message}`);
              }
            }
          } else {
            console.log('â„¹ï¸ Sheet boÅŸ (sadece baÅŸlÄ±k satÄ±rÄ± var)');
          }
        }
        
        testResults.passed++;
      }
    } catch (error) {
      console.log(`âŒ Sheet kontrol hatasÄ±: ${error.message}`);
      testResults.failed++;
      testResults.errors.push(`Sheet hatasÄ±: ${error.message}`);
    }
    
    // 4. HÄ°SSE BAÅINA SON TARÄ°H KONTROLÃœ
    console.log('\n4ï¸âƒ£ HÄ°SSE BAÅINA SON TARÄ°H KONTROLÃœ');
    testResults.totalTests++;
    
    try {
      const sheetName = CONFIG?.SHEETS?.HISSE_GECMIS_GUNLUK?.NAME || 'HISSE_GECMIS_GUNLUK';
      const ss = SpreadsheetApp.getActive();
      const sheet = ss.getSheetByName(sheetName);
      
      if (sheet && sheet.getLastRow() > 1) {
        const portfolio = DataReader.readPortfolio();
        const stocks = HisseGecmisKayitService._extractAllStocks(portfolio);
        
        if (stocks.length > 0) {
          console.log(`ğŸ” ${stocks.length} hisse iÃ§in son tarihler kontrol ediliyor...`);
          
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          
          let upToDateCount = 0;
          let outdatedCount = 0;
          let missingCount = 0;
          
          stocks.slice(0, 10).forEach((stock, index) => { // Sadece ilk 10 hisse
            try {
              const lastDate = HisseGecmisKayitService._getLastDateForSymbol(sheet, stock.symbol);
              
              if (lastDate) {
                const lastDateNormalized = new Date(lastDate);
                lastDateNormalized.setHours(0, 0, 0, 0);
                
                const daysDiff = Math.floor((today - lastDateNormalized) / (1000 * 60 * 60 * 24));
                
                if (daysDiff <= 1) {
                  upToDateCount++;
                  console.log(`   ${index + 1}. ${stock.symbol}: âœ… GÃ¼ncel (${daysDiff} gÃ¼n Ã¶nce)`);
                } else {
                  outdatedCount++;
                  console.log(`   ${index + 1}. ${stock.symbol}: âš ï¸ Eski (${daysDiff} gÃ¼n Ã¶nce)`);
                }
              } else {
                missingCount++;
                console.log(`   ${index + 1}. ${stock.symbol}: âŒ KayÄ±t yok`);
              }
            } catch (error) {
              console.log(`   ${index + 1}. ${stock.symbol}: ğŸ’¥ Hata: ${error.message}`);
            }
          });
          
          console.log(`\nğŸ“Š SONUÃ‡:`);
          console.log(`   GÃ¼ncel: ${upToDateCount} hisse`);
          console.log(`   Eski: ${outdatedCount} hisse`);
          console.log(`   KayÄ±t yok: ${missingCount} hisse`);
          
          if (outdatedCount > 0 || missingCount > 0) {
            testResults.warnings++;
            console.log('   âš ï¸ GÃ¼ncelleme gereken hisseler var!');
          }
        } else {
          console.log('â„¹ï¸ PortfÃ¶yde hisse bulunamadÄ±');
        }
        
        testResults.passed++;
      } else {
        console.log('â„¹ï¸ Sheet boÅŸ veya yok, kontrol atlanÄ±yor');
        testResults.passed++;
      }
    } catch (error) {
      console.log(`âŒ Son tarih kontrol hatasÄ±: ${error.message}`);
      testResults.failed++;
      testResults.errors.push(`Son tarih hatasÄ±: ${error.message}`);
    }
    
    // 5. YAHOO FINANCE BAÄLANTI TESTÄ° (SADECE 1 HÄ°SSE Ä°LE)
    console.log('\n5ï¸âƒ£ YAHOO FINANCE BAÄLANTI TESTÄ°');
    testResults.totalTests++;
    
    try {
      console.log('ğŸŒ Yahoo Finance baÄŸlantÄ±sÄ± test ediliyor...');
      
      // Test iÃ§in bir hisse seÃ§ (AAPL her zaman gÃ¼venilir)
      const testSymbol = 'AAPL';
      const testData = YahooFinanceStockService.fetchDailyHistory(testSymbol, '5d');
      
      if (testData && testData.length > 0) {
        console.log(`âœ… Yahoo Finance baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±`);
        console.log(`   ğŸ“ˆ ${testSymbol}: ${testData.length} gÃ¼n veri alÄ±ndÄ±`);
        console.log(`   ğŸ’° Son fiyat: ${testData[testData.length - 1].close}`);
        console.log(`   ğŸ“… Son tarih: ${testData[testData.length - 1].tarih.toISOString().split('T')[0]}`);
        
        testResults.passed++;
      } else {
        console.log(`âŒ Yahoo Finance baÄŸlantÄ±sÄ± baÅŸarÄ±sÄ±z`);
        testResults.failed++;
        testResults.errors.push('Yahoo Finance baÄŸlantÄ±sÄ± baÅŸarÄ±sÄ±z');
      }
    } catch (error) {
      console.log(`âŒ Yahoo Finance test hatasÄ±: ${error.message}`);
      testResults.failed++;
      testResults.errors.push(`Yahoo Finance hatasÄ±: ${error.message}`);
    }
    
    // 6. GÃœNCELLEME MANTIÄI TESTÄ° (SÄ°MÃœLASYON)
    console.log('\n6ï¸âƒ£ GÃœNCELLEME MANTIÄI TESTÄ° (SÄ°MÃœLASYON)');
    testResults.totalTests++;
    
    try {
      console.log('ğŸ”§ GÃ¼ncelleme mantÄ±ÄŸÄ± simÃ¼le ediliyor...');
      
      // Sheet'teki bir hisseyi al
      const sheetName = CONFIG?.SHEETS?.HISSE_GECMIS_GUNLUK?.NAME || 'HISSE_GECMIS_GUNLUK';
      const ss = SpreadsheetApp.getActive();
      const sheet = ss.getSheetByName(sheetName);
      
      if (sheet && sheet.getLastRow() > 1) {
        // Sheet'teki ilk hisseyi al
        const firstSymbolCell = sheet.getRange(2, 1);
        const sampleSymbol = firstSymbolCell.getValue();
        
        if (sampleSymbol) {
          console.log(`   Ã–rnek hisse: ${sampleSymbol}`);
          
          // Bu hisse iÃ§in son tarihi bul
          const lastDate = HisseGecmisKayitService._getLastDateForSymbol(sheet, sampleSymbol);
          
          if (lastDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const lastDateNormalized = new Date(lastDate);
            lastDateNormalized.setHours(0, 0, 0, 0);
            
            const daysDiff = Math.floor((today - lastDateNormalized) / (1000 * 60 * 60 * 24));
            
            console.log(`   Son kayÄ±t tarihi: ${Utilities.formatDate(lastDate, 'GMT', 'dd.MM.yyyy')}`);
            console.log(`   BugÃ¼n: ${Utilities.formatDate(today, 'GMT', 'dd.MM.yyyy')}`);
            console.log(`   GÃ¼n farkÄ±: ${daysDiff} gÃ¼n`);
            
            // GÃ¼ncelleme gerekli mi?
            const needsUpdate = daysDiff > 1;
            console.log(`   GÃ¼ncelleme gerekli mi? ${needsUpdate ? 'âœ… EVET' : 'âŒ HAYIR'}`);
            
            if (needsUpdate) {
              console.log(`   âš ï¸ ${sampleSymbol} hissesi ${daysDiff} gÃ¼ndÃ¼r gÃ¼ncellenmemiÅŸ!`);
              testResults.warnings++;
            }
            
            // KaÃ§ gÃ¼nlÃ¼k veri gerekli?
            const requiredRange = HisseGecmisKayitService._calculateDateRange(lastDate);
            console.log(`   Gerekli veri aralÄ±ÄŸÄ±: ${requiredRange}`);
            
          } else {
            console.log(`   â„¹ï¸ ${sampleSymbol} iÃ§in tarih bulunamadÄ±`);
          }
        } else {
          console.log('   â„¹ï¸ Sheet boÅŸ, Ã¶rnek hisse bulunamadÄ±');
        }
      } else {
        console.log('   â„¹ï¸ Sheet boÅŸ veya yok');
      }
      
      console.log('âœ… GÃ¼ncelleme mantÄ±ÄŸÄ± testi tamamlandÄ±');
      testResults.passed++;
    } catch (error) {
      console.log(`âŒ GÃ¼ncelleme mantÄ±ÄŸÄ± test hatasÄ±: ${error.message}`);
      testResults.failed++;
      testResults.errors.push(`GÃ¼ncelleme mantÄ±ÄŸÄ± hatasÄ±: ${error.message}`);
    }
    
    // 7. SENKRONÄ°ZASYON FONKSÄ°YONU KONTROLÃœ
    console.log('\n7ï¸âƒ£ SENKRONÄ°ZASYON FONKSÄ°YONU KONTROLÃœ');
    testResults.totalTests++;
    
    try {
      console.log('ğŸ” Senkronizasyon fonksiyonlarÄ± kontrol ediliyor...');
      
      // Ana senkronizasyon fonksiyonu
      if (typeof HisseGecmisKayitService.syncAllStockHistory === 'function') {
        console.log('âœ… syncAllStockHistory() fonksiyonu mevcut');
      } else {
        console.log('âŒ syncAllStockHistory() fonksiyonu eksik');
        testResults.warnings++;
      }
      
      // GÃ¼ncelleme fonksiyonu
      if (typeof HisseGecmisKayitService.updateAllStocks === 'function') {
        console.log('âœ… updateAllStocks() fonksiyonu mevcut');
      } else {
        console.log('âŒ updateAllStocks() fonksiyonu eksik');
        testResults.warnings++;
      }
      
      // YardÄ±mcÄ± fonksiyonlar
      const helperFunctions = [
        '_extractAllStocks',
        '_getLastDateForSymbol',
        '_calculateDateRange',
        '_writeToSheet'
      ];
      
      helperFunctions.forEach(funcName => {
        if (typeof HisseGecmisKayitService[funcName] === 'function') {
          console.log(`âœ… ${funcName}() fonksiyonu mevcut`);
        } else {
          console.log(`âŒ ${funcName}() fonksiyonu eksik`);
          testResults.warnings++;
        }
      });
      
      console.log('âœ… TÃ¼m fonksiyonlar kontrol edildi');
      testResults.passed++;
    } catch (error) {
      console.log(`âŒ Fonksiyon kontrol hatasÄ±: ${error.message}`);
      testResults.failed++;
      testResults.errors.push(`Fonksiyon kontrol hatasÄ±: ${error.message}`);
    }
    
  } catch (error) {
    console.error(`ğŸ’¥ GENEL TEST HATASI: ${error.message}`);
    testResults.errors.push(`Genel hata: ${error.message}`);
  }
  
  // TEST SONUÃ‡LARI
  const duration = (new Date().getTime() - startTime.getTime()) / 1000;
  
  console.log('\n' + '='.repeat(70));
  console.log('ğŸ“Š HÄ°SSE GEÃ‡MÄ°Å SERVÄ°SÄ° TEST SONUÃ‡LARI');
  console.log('='.repeat(70));
  
  console.log(`Toplam Test: ${testResults.totalTests}`);
  console.log(`BaÅŸarÄ±lÄ±: ${testResults.passed}`);
  console.log(`BaÅŸarÄ±sÄ±z: ${testResults.failed}`);
  console.log(`UyarÄ±lar: ${testResults.warnings}`);
  console.log(`BaÅŸarÄ± OranÄ±: ${testResults.totalTests > 0 ? ((testResults.passed / testResults.totalTests) * 100).toFixed(1) : 0}%`);
  console.log(`Toplam SÃ¼re: ${duration.toFixed(2)} saniye`);
  
  // Ã–NERÄ°LER
  console.log('\nğŸ’¡ Ã–NERÄ°LER VE SONRAKÄ° ADIMLAR:');
  
  if (testResults.warnings > 0) {
    console.log('1. Eksik/bugÃ¼nÃ¼n verisi olmayan hisseler iÃ§in gÃ¼ncelleme yapÄ±n:');
    console.log('   ğŸ“Œ Fonksiyon: run_Daily_Update_All()');
  }
  
  if (testResults.failed === 0 && testResults.warnings === 0) {
    console.log('âœ… TÃ¼m sistem sorunsuz Ã§alÄ±ÅŸÄ±yor!');
    console.log('   ğŸ“Œ GÃ¼nlÃ¼k gÃ¼ncelleme iÃ§in: run_Daily_Update_All()');
  } else if (testResults.failed > 0) {
    console.log('\nâš ï¸ DÃœZELTÄ°LMESÄ° GEREKEN HATALAR:');
    testResults.errors.forEach((error, index) => {
      console.log(`   ${index + 1}. ${error}`);
    });
  }
  
  console.log('\n' + '='.repeat(70));
  return testResults;
}


/**
 * ğŸ” SHEET Ä°Ã‡ERÄ°ÄÄ°NÄ° ANALÄ°Z ET
 * 
 * Sheet'teki tÃ¼m verileri detaylÄ± analiz eder
 * 10:33:40	Hata	ğŸ’¥ Analiz hatasÄ±: hasToday is not defined hata veriyor sonra iyileÅŸtirme yapÄ±lacak
 */
function analyze_Hisse_Sheet_Content() {
  console.log('ğŸ” HÄ°SSE SHEET Ä°Ã‡ERÄ°ÄÄ° ANALÄ°ZÄ°');
  console.log('='.repeat(60));
  
  try {
    const sheetName = CONFIG?.SHEETS?.HISSE_GECMIS_GUNLUK?.NAME || 'HISSE_GECMIS_GUNLUK';
    const ss = SpreadsheetApp.getActive();
    const sheet = ss.getSheetByName(sheetName);
    
    if (!sheet) {
      console.log(`âŒ "${sheetName}" sheet'i bulunamadÄ±`);
      return;
    }
    
    const rowCount = sheet.getLastRow();
    const colCount = sheet.getLastColumn();
    
    console.log(`ğŸ“„ Sheet: ${sheetName}`);
    console.log(`ğŸ“Š Boyut: ${rowCount} satÄ±r, ${colCount} sÃ¼tun`);
    
    if (rowCount <= 1) {
      console.log('â„¹ï¸ Sheet boÅŸ (sadece baÅŸlÄ±klar)');
      return;
    }
    
    const dataCount = rowCount - 1;
    console.log(`ğŸ“¦ Veri kaydÄ±: ${dataCount}`);
    
    // TÃ¼m veriyi oku
    const dataRange = sheet.getRange(2, 1, dataCount, colCount);
    const data = dataRange.getValues();
    
    // 1. Hisse daÄŸÄ±lÄ±mÄ±
    const symbolCounts = {};
    const symbolDates = {};
    
    data.forEach(row => {
      const symbol = row[0];
      const date = row[1];
      
      if (symbol) {
        symbolCounts[symbol] = (symbolCounts[symbol] || 0) + 1;
        
        if (date instanceof Date) {
          if (!symbolDates[symbol] || date > symbolDates[symbol]) {
            symbolDates[symbol] = date;
          }
        }
      }
    });
    
    const uniqueSymbols = Object.keys(symbolCounts);
    console.log(`\nğŸ“ˆ ${uniqueSymbols.length} BENZERSÄ°Z HÄ°SSE:`);
    
    // Hisse baÅŸÄ±na kayÄ±t sayÄ±sÄ±na gÃ¶re sÄ±rala
    const sortedSymbols = Object.entries(symbolCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 20); // Ä°lk 20 hisseyi gÃ¶ster
    
    sortedSymbols.forEach(([symbol, count], index) => {
      const lastDate = symbolDates[symbol];
      const lastDateStr = lastDate ? Utilities.formatDate(lastDate, 'GMT', 'dd.MM.yyyy') : 'Belirsiz';
      console.log(`   ${index + 1}. ${symbol}: ${count} kayÄ±t (Son: ${lastDateStr})`);
    });
    
    if (uniqueSymbols.length > 20) {
      console.log(`   ... ve ${uniqueSymbols.length - 20} tane daha`);
    }
    
    // 2. Tarih analizi
    console.log('\nğŸ“… TARÄ°H ANALÄ°ZÄ°:');
    
    const dates = data
      .map(row => row[1])
      .filter(date => date instanceof Date)
      .map(date => {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        return d.getTime();
      });
    
    if (dates.length > 0) {
      const minDate = new Date(Math.min(...dates));
      const maxDate = new Date(Math.max(...dates));
      const dayDiff = Math.floor((maxDate - minDate) / (1000 * 60 * 60 * 24));
      
      console.log(`   En erken tarih: ${Utilities.formatDate(minDate, 'GMT', 'dd.MM.yyyy')}`);
      console.log(`   En geÃ§ tarih: ${Utilities.formatDate(maxDate, 'GMT', 'dd.MM.yyyy')}`);
      console.log(`   Toplam gÃ¼n: ${dayDiff}`);
      
      // BugÃ¼nÃ¼n tarihi
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayTime = today.getTime();
      
      const hasToday = dates.some(date => date === todayTime);
      console.log(`   BugÃ¼nÃ¼n verisi: ${hasToday ? 'âœ… VAR' : 'âŒ YOK'}`);
      
      // Eksik gÃ¼nleri kontrol et
      if (!hasToday) {
        console.log(`   âš ï¸ BugÃ¼nÃ¼n verisi eksik! (${Utilities.formatDate(today, 'GMT', 'dd.MM.yyyy')})`);
      }
      
      // Son 7 gÃ¼n kontrolÃ¼
      const sevenDaysAgo = new Date(today);
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      const sevenDaysAgoTime = sevenDaysAgo.getTime();
      
      const recentDates = dates.filter(date => date >= sevenDaysAgoTime);
      console.log(`   Son 7 gÃ¼nde: ${recentDates.length} kayÄ±t`);
      
      if (recentDates.length < uniqueSymbols.length) {
        const missingCount = uniqueSymbols.length - recentDates.length;
        console.log(`   âš ï¸ ${missingCount} hissenin son 7 gÃ¼n verisi eksik!`);
      }
    }
    
    // 3. Veri kalitesi kontrolÃ¼
    console.log('\nğŸ”§ VERÄ° KALÄ°TESÄ° KONTROLÃœ:');
    
    let missingSymbols = 0;
    let missingDates = 0;
    let zeroPrices = 0;
    
    data.forEach(row => {
      if (!row[0] || row[0].toString().trim() === '') missingSymbols++;
      if (!(row[1] instanceof Date)) missingDates++;
      if (row[5] === 0 || row[5] === '0') zeroPrices++; // KapanÄ±ÅŸ fiyatÄ±
    });
    
    console.log(`   Eksik sembol: ${missingSymbols} kayÄ±t`);
    console.log(`   Eksik tarih: ${missingDates} kayÄ±t`);
    console.log(`   SÄ±fÄ±r fiyat: ${zeroPrices} kayÄ±t`);
    
    if (missingSymbols === 0 && missingDates === 0) {
      console.log('   âœ… Veri kalitesi: Ä°YÄ°');
    } else {
      console.log('   âš ï¸ Veri kalitesi: DÃœZELTME GEREKÄ°YOR');
    }
    
    console.log('\nğŸ’¡ Ã–NERÄ°LER:');
    
    if (!hasToday) {
      console.log('1. BugÃ¼nÃ¼n verisini eklemek iÃ§in: run_Daily_Update_All()');
    }
    
    if (recentDates.length < uniqueSymbols.length) {
      console.log('2. Eksik gÃ¼ncel verileri tamamlamak iÃ§in: run_Initial_Sync_All()');
    }
    
    console.log('\n' + '='.repeat(60));
    
  } catch (error) {
    console.error(`ğŸ’¥ Analiz hatasÄ±: ${error.message}`);
  }
}
/**
 * ğŸš€ GÃœNLÃœK HÄ°SSE GÃœNCELLEMESÄ° - BASÄ°T VERSÄ°YON
 * 
 * TÃ¼m hisseler iÃ§in gÃ¼nlÃ¼k gÃ¼ncellemeyi baÅŸlatÄ±r.
 * HisseGecmisKayitService.updateAllStocks() fonksiyonunu Ã§aÄŸÄ±rÄ±r.
 */
function run_Daily_Update_All() {
  console.log('ğŸ”„ TÃœM HÄ°SSE GÃœNCELLEMESÄ° BAÅLATILIYOR');
  console.log('ğŸ“… Tarih:', new Date().toISOString());
  console.log('='.repeat(60));
  
  const startTime = new Date();
  
  try {
    // Ana gÃ¼ncelleme fonksiyonunu Ã§aÄŸÄ±r
    HisseGecmisKayitService.updateAllStocks();
    
    const duration = (new Date().getTime() - startTime.getTime()) / 1000;
    console.log('\n' + '='.repeat(60));
    console.log(`âœ… GÃœNCELLEME TAMAMLANDI (${duration.toFixed(1)} saniye)`);
    console.log('='.repeat(60));
    
  } catch (error) {
    console.error('\nâŒ GÃœNCELLEME HATASI:', error.message);
    console.error(error.stack);
  }
}


