/**
 * ğŸš€ YAHOO FINANCE STOCK SERVICE
 * Sadece Yahoo Finance API iÅŸlemleri
 * ModÃ¼l 1: Veri Ã‡ekme
 */

const YahooFinanceStockService = {
  
  // Son istek zamanÄ± (rate limit iÃ§in)
  _lastRequestTime: null,
  
  /**
   * Yahoo Finance'ten gÃ¼nlÃ¼k hisse verisi Ã§ek
   * @param {string} symbol - Hisse sembolÃ¼
   * @param {string} range - Veri aralÄ±ÄŸÄ±: '1d', '5d', '1mo', '3mo', '6mo', '1y', '2y', '5y', '10y', 'ytd', 'max'
   * @returns {Array} Ä°ÅŸlenmiÅŸ gÃ¼nlÃ¼k veri dizisi
   */
  fetchDailyHistory: function(symbol, range = '3mo') {
    console.log(`ğŸ“¡ Yahoo Finance API â†’ ${symbol} (${range})`);
    
    // Rate limit kontrolÃ¼ (saniyede 1 istek)
    this._checkRateLimit();
    
    try {
      // URL oluÅŸtur
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=${range}`;
      
      console.log(`   ğŸ”— URL: ${url}`);
      
      // HTTP isteÄŸi yap
      const response = UrlFetchApp.fetch(url, {
        muteHttpExceptions: true,
        headers: {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
          'Accept': 'application/json'
        }
      });
      
      const statusCode = response.getResponseCode();
      const responseText = response.getContentText();
      
      console.log(`   ğŸ“Š Status: ${statusCode}, Length: ${responseText.length}`);
      
      if (statusCode !== 200) {
        console.error(`âŒ HTTP HatasÄ± (${symbol}): ${statusCode}`);
        
        // 404 hatasÄ± - hisse bulunamadÄ±
        if (statusCode === 404) {
          console.log(`   â„¹ï¸ Hisse ${symbol} Yahoo Finance'te bulunamadÄ±. FarklÄ± sembol deneyin.`);
        }
        
        return null;
      }
      
      // JSON parse
      const data = JSON.parse(responseText);
      
      // Hata kontrolÃ¼
      if (data.chart && data.chart.error) {
        console.error(`âŒ Yahoo Finance HATA (${symbol}): ${data.chart.error.description}`);
        return null;
      }
      
      // Veriyi iÅŸle
      return this._processYahooData(data, symbol);
      
    } catch (error) {
      console.error(`ğŸ’¥ Yahoo Finance HATA (${symbol}):`, error.message);
      return null;
    }
  },
  
  /**
   * Yahoo Finance verisini iÅŸle
   */
  _processYahooData: function(data, symbol) {
    if (!data.chart || !data.chart.result || data.chart.result.length === 0) {
      console.error(`âŒ ${symbol}: GeÃ§erli veri yok`);
      return null;
    }
    
    const result = data.chart.result[0];
    const timestamps = result.timestamp || [];
    const quotes = result.indicators?.quote?.[0] || {};
    
    if (timestamps.length === 0) {
      console.error(`âŒ ${symbol}: Zaman damgasÄ± yok`);
      return null;
    }
    
    const processed = [];
    const today = new Date();
    
    for (let i = 0; i < timestamps.length; i++) {
      const timestamp = timestamps[i];
      
      // Zaman damgasÄ± yoksa atla
      if (!timestamp) continue;
      
      const date = new Date(timestamp * 1000); // Saniyeden milisaniyeye
      
      // BugÃ¼n ve gelecek tarihleri atla
      if (date > today) continue;
      
      // Verileri al
      const open = quotes.open?.[i] || 0;
      const high = quotes.high?.[i] || 0;
      const low = quotes.low?.[i] || 0;
      const close = quotes.close?.[i] || 0;
      const volume = quotes.volume?.[i] || 0;
      
      // SÄ±fÄ±r verileri atla
      if (open === 0 && high === 0 && low === 0 && close === 0) {
        continue;
      }
      
      processed.push({
        tarih: date,
        open: open,
        high: high,
        low: low,
        close: close,
        volume: Math.round(volume)
      });
    }
    
    // Tarihe gÃ¶re sÄ±rala (eskiden yeniye)
    processed.sort((a, b) => a.tarih - b.tarih);
    
    console.log(`âœ… ${symbol}: ${processed.length} gÃ¼nlÃ¼k veri iÅŸlendi`);
    
    if (processed.length > 0) {
      const firstDate = processed[0].tarih.toISOString().split('T')[0];
      const lastDate = processed[processed.length - 1].tarih.toISOString().split('T')[0];
      console.log(`   ğŸ“… Ä°lk tarih: ${firstDate}`);
      console.log(`   ğŸ“… Son tarih: ${lastDate}`);
      console.log(`   ğŸ’° Son kapanÄ±ÅŸ: ${processed[processed.length - 1].close}`);
    }
    
    return processed;
  },
  
  /**
   * Rate limit kontrolÃ¼ (Yahoo Finance iÃ§in Ã§ok daha az sÄ±kÄ±)
   */
  _checkRateLimit: function() {
    const now = new Date();
    
    if (this._lastRequestTime) {
      const timeDiff = (now - this._lastRequestTime) / 1000; // saniye
      
      // Yahoo iÃ§in saniyede 1 istek yeterli
      if (timeDiff < 1) {
        const waitTime = Math.ceil(1 - timeDiff);
        console.log(`â³ Yahoo rate limit iÃ§in ${waitTime} saniye bekleniyor...`);
        Utilities.sleep(waitTime * 1000);
      }
    }
    
    this._lastRequestTime = new Date();
  },
  
  /**
   * BugÃ¼nÃ¼n verisini al (gÃ¼nlÃ¼k gÃ¼ncelleme iÃ§in)
   */
  fetchTodayData: function(symbol) {
    console.log(`ğŸ“¡ Yahoo Finance BugÃ¼nkÃ¼ Veri â†’ ${symbol}`);
    
    // Son 5 gÃ¼nÃ¼ al, en son tarihi dÃ¶ndÃ¼r
    const data = this.fetchDailyHistory(symbol, '5d');
    
    if (!data || data.length === 0) {
      return null;
    }
    
    // En son tarihli veriyi al
    const latestData = data[data.length - 1];
    console.log(`âœ… ${symbol}: BugÃ¼nkÃ¼ veri alÄ±ndÄ± (${latestData.tarih.toISOString().split('T')[0]})`);
    
    return latestData;
  },
  
  /**
   * Ã‡oklu hisse testi
   */
  testMultipleSymbols: function() {
    console.log('ğŸ§ª Yahoo Finance Ã‡oklu Sembol Testi');
    
    const testSymbols = [
      'AAPL',   // Apple - NASDAQ
      'MSFT',   // Microsoft - NASDAQ
      'GOOGL',  // Google - NASDAQ
      'CVX',    // Chevron - NYSE
      'SLB',    // Schlumberger - NYSE
      'PATH',   // UiPath - NYSE
      'AMZN',   // Amazon - NASDAQ
      'TSLA',   // Tesla - NASDAQ
      'JPM',    // JPMorgan Chase - NYSE
      'V'       // Visa - NYSE
    ];
    
    let success = 0;
    let failed = 0;
    
    testSymbols.forEach((symbol, index) => {
      console.log(`\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
      console.log(`ğŸ” ${index + 1}/${testSymbols.length}: ${symbol}`);
      
      const data = this.fetchDailyHistory(symbol, '7d'); // Son 7 gÃ¼n
      
      if (data && data.length > 0) {
        console.log(`âœ… ${symbol}: ${data.length} gÃ¼n veri`);
        success++;
      } else {
        console.log(`âŒ ${symbol}: Veri yok`);
        failed++;
      }
      
      // Rate limit iÃ§in bekle
      if (index < testSymbols.length - 1) {
        console.log('â³ 1 saniye bekleniyor...');
        Utilities.sleep(1000);
      }
    });
    
    console.log('\nğŸ“Š TEST Ã–ZETÄ°');
    console.log({
      toplam: testSymbols.length,
      basarili: success,
      basarisiz: failed,
      basariOrani: ((success / testSymbols.length) * 100).toFixed(1) + '%'
    });
    
    return success === testSymbols.length;
  },
  
  /**
   * Hisse sembolÃ¼nÃ¼ doÄŸrula (Yahoo Finance'te var mÄ±?)
   */
  validateSymbol: function(symbol) {
    console.log(`ğŸ” Sembol DoÄŸrulama: ${symbol}`);
    
    try {
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`;
      
      const response = UrlFetchApp.fetch(url, {
        muteHttpExceptions: true,
        headers: {
          'User-Agent': 'Mozilla/5.0'
        }
      });
      
      const data = JSON.parse(response.getContentText());
      
      if (data.chart && data.chart.result && data.chart.result.length > 0) {
        console.log(`âœ… ${symbol}: Yahoo Finance'te geÃ§erli`);
        return true;
      } else {
        console.log(`âŒ ${symbol}: Yahoo Finance'te bulunamadÄ±`);
        return false;
      }
      
    } catch (error) {
      console.error(`ğŸ’¥ DoÄŸrulama hatasÄ± (${symbol}):`, error.message);
      return false;
    }
  }
};

/**
 * ğŸ§ª YAHOO FINANCE SERVÄ°SÄ° TESTÄ° - GERÃ‡EK PORTFÃ–Y VERÄ°LERÄ°
 * 
 * AMAÃ‡:
 * - PortfÃ¶ydeki gerÃ§ek hisselerle Yahoo Finance API testi
 * - DataReader ile portfÃ¶yÃ¼ okuyup hisseleri Ã§Ä±kar
 * - Sadece portfÃ¶ydeki hisseleri test et
 */
function test_YahooFinanceService_WithPortfolio() {
  console.log('='.repeat(70));
  console.log('ğŸ§ª YAHOO FINANCE TESTÄ° - GERÃ‡EK PORTFÃ–Y VERÄ°LERÄ°');
  console.log('='.repeat(70));
  
  const startTime = new Date();
  const testResults = {
    totalTests: 0,
    passed: 0,
    failed: 0,
    warnings: 0,
    errors: [],
    symbolsTested: []
  };
  
  try {
    // 1. PORTFÃ–YÃœ OKU VE HÄ°SSELERÄ° Ã‡IKAR
    console.log('\n1ï¸âƒ£ PORTFÃ–Y ANALÄ°ZÄ°');
    
    const portfolio = DataReader.readPortfolio();
    console.log(`ğŸ“¦ PortfÃ¶y kayÄ±t sayÄ±sÄ±: ${portfolio.length}`);
    
    if (portfolio.length === 0) {
      console.log('âŒ Test edilecek portfÃ¶y verisi yok!');
      return testResults;
    }
    
    // HisseGecmisKayitService kullanarak hisseleri Ã§Ä±kar
    const allStocks = HisseGecmisKayitService._extractAllStocks(portfolio);
    console.log(`ğŸ“ˆ PortfÃ¶ydeki hisse sayÄ±sÄ±: ${allStocks.length}`);
    
    if (allStocks.length === 0) {
      console.log('âŒ PortfÃ¶yde test edilecek hisse bulunamadÄ±!');
      return testResults;
    }
    
    // ABD ve BIST hisselerini ayÄ±r
    const usStocks = allStocks.filter(s => s.type === 'ABD');
    const bistStocks = allStocks.filter(s => s.type === 'BIST');
    
    console.log(`   ğŸ‡ºğŸ‡¸ ABD Hisseleri: ${usStocks.length}`);
    console.log(`   ğŸ‡¹ğŸ‡· BIST Hisseleri: ${bistStocks.length}`);
    
    // Ä°lk 5 hisseyi gÃ¶ster
    console.log('\nğŸ” PORTFÃ–YDEKÄ° HÄ°SSELER (ilk 10):');
    allStocks.slice(0, 10).forEach((stock, i) => {
      console.log(`   ${i + 1}. ${stock.symbol} -> ${stock.yahooSymbol} (${stock.type})`);
    });
    
    if (allStocks.length > 10) {
      console.log(`   ... ve ${allStocks.length - 10} tane daha`);
    }
    
    // 2. YAHOO FINANCE SERVÄ°SÄ° KONTROLÃœ
    console.log('\n2ï¸âƒ£ YAHOO FINANCE SERVÄ°SÄ° KONTROLÃœ');
    testResults.totalTests++;
    
    if (typeof YahooFinanceStockService === 'undefined') {
      console.log('âŒ YahooFinanceStockService tanÄ±mlÄ± deÄŸil!');
      testResults.failed++;
      return testResults;
    }
    
    console.log('âœ… YahooFinanceStockService mevcut');
    testResults.passed++;
    
    // 3. PORTFÃ–Y HÄ°SSELERÄ° Ä°LE TEST
    console.log('\n3ï¸âƒ£ PORTFÃ–Y HÄ°SSELERÄ° Ä°LE TEST');
    console.log('='.repeat(50));
    
    // Test edilecek maksimum hisse sayÄ±sÄ± (performans iÃ§in)
    const maxStocksToTest = Math.min(allStocks.length, 8);
    const stocksToTest = allStocks.slice(0, maxStocksToTest);
    
    console.log(`ğŸ”¬ ${maxStocksToTest} hisse test edilecek:`);
    
    stocksToTest.forEach((stock, index) => {
      console.log(`\n${index + 1}/${maxStocksToTest}: ${stock.symbol} -> ${stock.yahooSymbol} (${stock.type})`);
      
      const symbolResult = {
        symbol: stock.symbol,
        yahooSymbol: stock.yahooSymbol,
        type: stock.type,
        status: 'pending',
        dataCount: 0,
        lastPrice: 0,
        error: null
      };
      
      try {
        // 3.1. Sembol doÄŸrulama testi
        testResults.totalTests++;
        console.log(`   ğŸ” Sembol doÄŸrulama...`);
        const isValid = YahooFinanceStockService.validateSymbol(stock.yahooSymbol);
        
        if (isValid) {
          console.log(`   âœ… Yahoo Finance'te geÃ§erli`);
          testResults.passed++;
        } else {
          console.log(`   âŒ Yahoo Finance'te bulunamadÄ±`);
          testResults.failed++;
          symbolResult.status = 'invalid_symbol';
          symbolResult.error = 'Yahoo Finance sembolÃ¼ geÃ§ersiz';
          testResults.symbolsTested.push(symbolResult);
          
          // GeÃ§ersiz sembol iÃ§in veri Ã§ekme testi yapma
          testResults.errors.push(`${stock.symbol} -> ${stock.yahooSymbol}: GeÃ§ersiz sembol`);
          return;
        }
        
        // 3.2. Veri Ã§ekme testi (5 gÃ¼nlÃ¼k)
        testResults.totalTests++;
        console.log(`   ğŸ“¡ 5 gÃ¼nlÃ¼k veri Ã§ekiliyor...`);
        
        const startFetch = new Date();
        const data = YahooFinanceStockService.fetchDailyHistory(stock.yahooSymbol, '5d');
        const fetchTime = (new Date() - startFetch) / 1000;
        
        if (data && Array.isArray(data) && data.length > 0) {
          console.log(`   âœ… ${data.length} gÃ¼n veri alÄ±ndÄ± (${fetchTime.toFixed(2)}s)`);
          
          // Veri kalitesi kontrolÃ¼
          const validData = data.filter(d => d.close > 0);
          if (validData.length > 0) {
            const lastRecord = validData[validData.length - 1];
            console.log(`   ğŸ“Š Son fiyat: ${lastRecord.close} ${stock.birimi}`);
            console.log(`   ğŸ“… Son tarih: ${lastRecord.tarih.toISOString().split('T')[0]}`);
            
            symbolResult.status = 'success';
            symbolResult.dataCount = data.length;
            symbolResult.lastPrice = lastRecord.close;
            
            testResults.passed++;
          } else {
            console.log(`   âš ï¸ Veri var ama geÃ§ersiz fiyatlar`);
            symbolResult.status = 'invalid_data';
            testResults.warnings++;
          }
        } else {
          console.log(`   âŒ Veri alÄ±namadÄ±`);
          symbolResult.status = 'no_data';
          symbolResult.error = 'Veri alÄ±namadÄ±';
          testResults.failed++;
          testResults.errors.push(`${stock.symbol} -> ${stock.yahooSymbol}: Veri alÄ±namadÄ±`);
        }
        
      } catch (error) {
        console.log(`   ğŸ’¥ Hata: ${error.message}`);
        symbolResult.status = 'error';
        symbolResult.error = error.message;
        testResults.failed++;
        testResults.errors.push(`${stock.symbol} -> ${stock.yahooSymbol}: ${error.message}`);
      }
      
      testResults.symbolsTested.push(symbolResult);
      
      // Rate limit iÃ§in bekle (son hisse deÄŸilse)
      if (index < stocksToTest.length - 1) {
        console.log('   â³ 2 saniye bekleniyor...');
        Utilities.sleep(2000);
      }
    });
    
    console.log('\n' + '='.repeat(50));
    
    // 4. Ã–ZET ANALÄ°Z
    console.log('\n4ï¸âƒ£ TEST Ã–ZET ANALÄ°ZÄ°');
    
    const successfulSymbols = testResults.symbolsTested.filter(s => s.status === 'success');
    const failedSymbols = testResults.symbolsTested.filter(s => s.status === 'error' || s.status === 'no_data');
    const invalidSymbols = testResults.symbolsTested.filter(s => s.status === 'invalid_symbol');
    
    console.log(`âœ… BaÅŸarÄ±lÄ±: ${successfulSymbols.length} hisse`);
    console.log(`âŒ BaÅŸarÄ±sÄ±z: ${failedSymbols.length} hisse`);
    console.log(`âš ï¸  GeÃ§ersiz Sembol: ${invalidSymbols.length} hisse`);
    
    if (successfulSymbols.length > 0) {
      console.log('\nğŸ“ˆ BAÅARILI HÄ°SSELER:');
      successfulSymbols.forEach((symbol, index) => {
        console.log(`   ${index + 1}. ${symbol.symbol} -> ${symbol.yahooSymbol}: ${symbol.lastPrice}`);
      });
    }
    
    if (failedSymbols.length > 0) {
      console.log('\nâŒ BAÅARISIZ HÄ°SSELER:');
      failedSymbols.forEach((symbol, index) => {
        console.log(`   ${index + 1}. ${symbol.symbol} -> ${symbol.yahooSymbol}: ${symbol.error}`);
      });
    }
    
    if (invalidSymbols.length > 0) {
      console.log('\nâš ï¸  GEÃ‡ERSÄ°Z SEMBOLLER (Yahoo Finance\'te yok):');
      invalidSymbols.forEach((symbol, index) => {
        console.log(`   ${index + 1}. ${symbol.symbol} -> ${symbol.yahooSymbol}`);
      });
      
      console.log('\nğŸ’¡ Ã–NERÄ°: Bu hisseler iÃ§in sembolleri kontrol edin:');
      console.log('   - BIST hisseleri iÃ§in ".IS" uzantÄ±sÄ± doÄŸru mu?');
      console.log('   - ABD hisseleri iÃ§in sembol doÄŸru mu?');
      console.log('   - Yahoo Finance\'te sembolÃ¼ ara: finance.yahoo.com');
    }
    
    // 5. TÃœM PORTFÃ–Y Ä°Ã‡Ä°N HIZLI DURUM KONTROLÃœ
    console.log('\n5ï¸âƒ£ TÃœM PORTFÃ–Y HIZLI DURUM KONTROLÃœ');
    
    // GeÃ§erli sembolleri test etmeden kontrol et
    const allSymbolsStatus = [];
    
    allStocks.forEach((stock, index) => {
      if (index < 15) { // Sadece ilk 15 hisse
        try {
          const isValid = YahooFinanceStockService.validateSymbol(stock.yahooSymbol);
          allSymbolsStatus.push({
            symbol: stock.symbol,
            yahooSymbol: stock.yahooSymbol,
            type: stock.type,
            valid: isValid
          });
        } catch (e) {
          allSymbolsStatus.push({
            symbol: stock.symbol,
            yahooSymbol: stock.yahooSymbol,
            type: stock.type,
            valid: false,
            error: e.message
          });
        }
      }
    });
    
    const validCount = allSymbolsStatus.filter(s => s.valid).length;
    const invalidCount = allSymbolsStatus.filter(s => !s.valid).length;
    
    console.log(`   ğŸ“Š GeÃ§erli sembol: ${validCount}/${allSymbolsStatus.length}`);
    console.log(`   ğŸ“Š GeÃ§ersiz sembol: ${invalidCount}/${allSymbolsStatus.length}`);
    
    if (invalidCount > 0) {
      console.log('\n   ğŸ” GEÃ‡ERSÄ°Z SEMBOLLER:');
      allSymbolsStatus.filter(s => !s.valid).slice(0, 5).forEach((symbol, i) => {
        console.log(`      ${i + 1}. ${symbol.symbol} -> ${symbol.yahooSymbol} (${symbol.type})`);
      });
    }
    
  } catch (error) {
    console.error(`ğŸ’¥ GENEL TEST HATASI: ${error.message}`);
    testResults.errors.push(`Genel hata: ${error.message}`);
  }
  
  // TEST SONUÃ‡LARI
  const duration = (new Date().getTime() - startTime.getTime()) / 1000;
  
  console.log('\n' + '='.repeat(70));
  console.log('ğŸ“Š YAHOO FINANCE TEST SONUÃ‡LARI');
  console.log('='.repeat(70));
  
  console.log(`â±ï¸  Toplam SÃ¼re: ${duration.toFixed(1)} saniye`);
  console.log(`ğŸ“‹ Toplam Test: ${testResults.totalTests}`);
  console.log(`âœ… BaÅŸarÄ±lÄ±: ${testResults.passed}`);
  console.log(`âŒ BaÅŸarÄ±sÄ±z: ${testResults.failed}`);
  console.log(`âš ï¸  UyarÄ±lar: ${testResults.warnings}`);
  
  const successRate = testResults.totalTests > 0 ? 
    ((testResults.passed / testResults.totalTests) * 100).toFixed(1) : 0;
  console.log(`ğŸ“ˆ BaÅŸarÄ± OranÄ±: ${successRate}%`);
  
  // PORTFÃ–Y BAZLI SONUÃ‡ DEÄERLENDÄ°RMESÄ°
  console.log('\n' + '='.repeat(70));
  
  if (testResults.failed === 0 && testResults.totalTests > 0) {
    console.log('ğŸ‰ YAHOO FINANCE SERVÄ°SÄ° PORTFÃ–YÃœNÃœZLE TAM UYUMLU!');
    console.log('   âœ… TÃ¼m hisseleriniz Yahoo Finance\'te mevcut');
    console.log('   âœ… Veri Ã§ekme sorunsuz Ã§alÄ±ÅŸÄ±yor');
  } else if (testResults.passed > testResults.failed) {
    console.log('âš ï¸ YAHOO FINANCE SERVÄ°SÄ° KISMEN Ã‡ALIÅIYOR');
    console.log(`   ${testResults.failed} hissede sorun var`);
    console.log('   âš ï¸ BazÄ± hisselerin sembolleri kontrol edilmeli');
  } else {
    console.log('âŒ YAHOO FINANCE SERVÄ°SÄ°NDE CÄ°DDÄ° SORUNLAR VAR!');
    console.log('   ğŸ”§ Hisse sembollerini ve API baÄŸlantÄ±sÄ±nÄ± kontrol edin');
  }
  
  console.log('\nğŸ’¡ PORTFÃ–Y Ä°Ã‡Ä°N Ã–NERÄ°LER:');
  console.log('1. GeÃ§ersiz sembollÃ¼ hisseleri portfÃ¶yden Ã§Ä±karÄ±n');
  console.log('2. BIST hisseleri iÃ§in ".IS" uzantÄ±sÄ±nÄ± kontrol edin');
  console.log('3. ABD hisseleri iÃ§in doÄŸru sembol kullanÄ±n');
  console.log('4. DÃ¼zenli olarak sembol doÄŸrulama testi yapÄ±n');
  
  console.log('='.repeat(70));
  
  return testResults;
}

/**
 * ğŸ” YAHOO FINANCE BAÄLANTI KONTROLÃœ (PORTFÃ–Y Ä°LE)
 * 
 * PortfÃ¶ydeki hisselerle hÄ±zlÄ± baÄŸlantÄ± testi
 */
function check_YahooFinance_Portfolio_Connection() {
  console.log('ğŸ” YAHOO FINANCE BAÄLANTI KONTROLÃœ - PORTFÃ–Y');
  console.log('='.repeat(50));
  
  try {
    // PortfÃ¶yÃ¼ oku
    const portfolio = DataReader.readPortfolio();
    console.log(`ğŸ“¦ PortfÃ¶y: ${portfolio.length} kayÄ±t`);
    
    if (portfolio.length === 0) {
      console.log('âŒ PortfÃ¶y boÅŸ!');
      return;
    }
    
    // Hisseleri Ã§Ä±kar
    const allStocks = HisseGecmisKayitService._extractAllStocks(portfolio);
    console.log(`ğŸ“ˆ Hisseler: ${allStocks.length} adet`);
    
    if (allStocks.length === 0) {
      console.log('âŒ PortfÃ¶yde hisse bulunamadÄ±!');
      return;
    }
    
    // ABD ve BIST sayÄ±larÄ±
    const usStocks = allStocks.filter(s => s.type === 'ABD');
    const bistStocks = allStocks.filter(s => s.type === 'BIST');
    console.log(`   ğŸ‡ºğŸ‡¸ ABD: ${usStocks.length}, ğŸ‡¹ğŸ‡· BIST: ${bistStocks.length}`);
    
    // Test iÃ§in 3 hisse seÃ§ (1 ABD, 1 BIST, 1 rastgele)
    const testStocks = [];
    if (usStocks.length > 0) testStocks.push(usStocks[0]);
    if (bistStocks.length > 0) testStocks.push(bistStocks[0]);
    if (allStocks.length > 2) testStocks.push(allStocks[2]);
    
    console.log(`\nğŸ”¬ ${testStocks.length} hisse test edilecek:`);
    
    const results = [];
    
    testStocks.forEach((stock, index) => {
      console.log(`\n${index + 1}. ${stock.symbol} -> ${stock.yahooSymbol} (${stock.type}):`);
      
      try {
        const start = new Date();
        const data = YahooFinanceStockService.fetchDailyHistory(stock.yahooSymbol, '1d');
        const duration = (new Date() - start) / 1000;
        
        if (data && data.length > 0) {
          const record = data[0];
          console.log(`   âœ… BAÄLANDI (${duration.toFixed(2)}s)`);
          console.log(`      Tarih: ${record.tarih.toISOString().split('T')[0]}`);
          console.log(`      Fiyat: ${record.close} ${stock.birimi}`);
          results.push({ 
            symbol: stock.symbol, 
            yahooSymbol: stock.yahooSymbol,
            type: stock.type,
            status: 'success', 
            time: duration,
            price: record.close
          });
        } else {
          console.log(`   âŒ BAÄLANAMADI (veri yok)`);
          results.push({ 
            symbol: stock.symbol, 
            yahooSymbol: stock.yahooSymbol,
            type: stock.type,
            status: 'no_data', 
            time: duration 
          });
        }
      } catch (error) {
        console.log(`   âŒ HATA: ${error.message}`);
        results.push({ 
          symbol: stock.symbol, 
          yahooSymbol: stock.yahooSymbol,
          type: stock.type,
          status: 'error', 
          message: error.message 
        });
      }
      
      if (index < testStocks.length - 1) {
        Utilities.sleep(2000);
      }
    });
    
    // Ã–zet
    const successCount = results.filter(r => r.status === 'success').length;
    const totalCount = results.length;
    
    console.log('\n' + '='.repeat(50));
    console.log(`ğŸ“Š SONUÃ‡: ${successCount}/${totalCount} baÅŸarÄ±lÄ±`);
    
    if (successCount === totalCount) {
      console.log('âœ… YAHOO FINANCE PORTFÃ–Y BAÄLANTISI SORUNSUZ');
    } else if (successCount > 0) {
      console.log('âš ï¸ YAHOO FINANCE BAÄLANTISI KISMEN Ã‡ALIÅIYOR');
      
      // Hangi tÃ¼r hisselerde sorun var?
      const failedTypes = results
        .filter(r => r.status !== 'success')
        .map(r => r.type)
        .filter((value, index, self) => self.indexOf(value) === index);
      
      if (failedTypes.length > 0) {
        console.log(`   ğŸ” Sorunlu hisse tÃ¼rleri: ${failedTypes.join(', ')}`);
      }
    } else {
      console.log('âŒ YAHOO FINANCE BAÄLANTISI TAMAMEN KOPUK');
      console.log('   ğŸ”§ Ä°nternet baÄŸlantÄ±nÄ±zÄ± veya proxy ayarlarÄ±nÄ±zÄ± kontrol edin');
    }
    
    // TÃ¼m portfÃ¶y iÃ§in geÃ§erli sembol oranÄ± (hÄ±zlÄ± kontrol)
    console.log('\nğŸ“Š TÃœM PORTFÃ–Y SEMBOL KONTROLÃœ (Ã¶rnekleme):');
    const sampleSymbols = allStocks.slice(0, 8); // Ä°lk 8 hisse
    let validSampleCount = 0;
    
    sampleSymbols.forEach(symbol => {
      try {
        const isValid = YahooFinanceStockService.validateSymbol(symbol.yahooSymbol);
        if (isValid) validSampleCount++;
      } catch (e) {
        // GeÃ§ersiz say
      }
    });
    
    const sampleValidRate = (validSampleCount / sampleSymbols.length * 100).toFixed(0);
    console.log(`   Ã–rnek ${sampleSymbols.length} hisse: %${sampleValidRate} geÃ§erli sembol`);
    
    if (parseInt(sampleValidRate) < 70) {
      console.log('   âš ï¸  YÃ¼ksek oranda geÃ§ersiz sembol olabilir!');
    }
    
    return results;
    
  } catch (error) {
    console.error(`ğŸ’¥ Kontrol hatasÄ±: ${error.message}`);
    return null;
  }
}
