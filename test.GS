/**
 * =========================================================
 * TEST: DataReader (DETAYLI DEBUG)
 * =========================================================
 * AMAÃ‡:
 * - Okunan TÃœM kayÄ±tlarÄ± gÃ¶rmek
 * - SatÄ±r bazÄ±nda kontrol
 * - YapÄ±sal hata var mÄ± anlamak
 * =========================================================
 */
function test_DataReader_Debug() {
  console.log('ğŸ§ª TEST BAÅLADI: DataReader (DETAYLI)');

  try {
    const data = DataReader.readPortfolio();

    console.log('ğŸ“¦ Toplam kayÄ±t sayÄ±sÄ±:', data.length);

    if (data.length === 0) {
      console.warn('âš ï¸ Veri yok, test sonlandÄ±rÄ±ldÄ±');
      return;
    }

    // -----------------------------------------------------
    // 1ï¸âƒ£ TÃœM VERÄ°NÄ°N HAM JSON DUMP'I
    // -----------------------------------------------------
    console.log('ğŸ“š TÃœM VERÄ° (JSON DUMP BAÅLANGIÃ‡)');
    console.log(JSON.stringify(data, null, 2));
    console.log('ğŸ“š TÃœM VERÄ° (JSON DUMP BÄ°TÄ°Å)');

    // -----------------------------------------------------
    // 2ï¸âƒ£ SATIR SATIR OKUNABÄ°LÄ°R DEBUG
    // -----------------------------------------------------
    console.log('ğŸ§¾ SATIR SATIR DETAYLI DEBUG');

    data.forEach((row, index) => {
      console.log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`);
      console.log(`ğŸ”¢ KAYIT #${index + 1}`);
      console.log('ID:', row.id);
      console.log('Tarih:', row.tarih);
      console.log('Ä°ÅŸlem TÃ¼rÃ¼:', row.islemTuru);
      console.log('BaÅŸlÄ±k:', row.baslik);
      console.log('Adet:', row.adet);
      console.log('Birim Fiyat:', row.birimFiyat);
      console.log('Toplam Tutar:', row.toplamTutar);
      console.log('Kategori:', row.kategori);
      console.log('Platform:', row.platform);
      console.log('Durum:', row.durum);
    });

    // -----------------------------------------------------
    // 3ï¸âƒ£ HIZLI SAÄLIK KONTROLLERÄ°
    // -----------------------------------------------------
    const hataliKayitlar = data.filter(d =>
      !d.tarih ||
      typeof d.toplamTutar !== 'number' ||
      isNaN(d.toplamTutar)
    );

    if (hataliKayitlar.length > 0) {
      console.warn(
        `âš ï¸ ${hataliKayitlar.length} adet ÅŸÃ¼pheli kayÄ±t bulundu`,
        hataliKayitlar
      );
    } else {
      console.log('âœ… TÃ¼m kayÄ±tlar temel kontrollerden geÃ§ti');
    }

    console.log('ğŸ‰ TEST BAÅARIYLA TAMAMLANDI');

  } catch (error) {
    console.error('ğŸ’¥ TEST HATASI:', error);
  }
}

/**
 * ======================================================
 * TEST: CalculationEngine
 * ------------------------------------------------------
 * - GERÃ‡EK Sheet datasÄ± kullanÄ±r
 * - TÃ¼m hesaplamalarÄ± sÄ±rayla Ã§alÄ±ÅŸtÄ±rÄ±r
 * - Debug iÃ§in detaylÄ± log basar
 * ======================================================
 */
function CalculationEngine_Debug() {
  console.log('ğŸ§ª TEST BAÅLADI: CalculationEngine');

  // 1ï¸âƒ£ DATA OKU
  const portfolio = DataReader.readPortfolio();
  console.log(`ğŸ“¦ Toplam kayÄ±t: ${portfolio.length}`);

  // 2ï¸âƒ£ FIFO
  const fifo = CalculationEngine.calculateFIFOProfitLoss(portfolio);
  console.log('ğŸ§® FIFO KAR/ZARAR MAP');
  console.log(JSON.stringify(fifo, null, 2));

  // 3ï¸âƒ£ FIFO sonucunu portfÃ¶ye yaz
  portfolio.forEach(p => {
    if (fifo[p.id] !== undefined) {
      p.karZarar = fifo[p.id];
    }
  });

  console.log('ğŸ“Œ KAR/ZARAR YAZILMIÅ KAYITLAR');
  console.log(
    JSON.stringify(
      portfolio.filter(p => p.karZarar !== 0),
      null,
      2
    )
  );

  // 4ï¸âƒ£ ORTALAMALAR
  console.log('ğŸ“Š ORTALAMA ALIÅ');
  console.log(
    JSON.stringify(
      CalculationEngine.calculateAveragePurchasePrice(portfolio),
      null,
      2
    )
  );

  console.log('ğŸ“Š ORTALAMA SATIÅ');
  console.log(
    JSON.stringify(
      CalculationEngine.calculateAverageSalePrice(portfolio),
      null,
      2
    )
  );

  // 5ï¸âƒ£ Ã–ZETLER
  console.log('ğŸ“ˆ HÄ°SSE Ã–ZETLERÄ°');
  console.log(
    JSON.stringify(
      CalculationEngine.calculateStockSummaries(portfolio),
      null,
      2
    )
  );

  console.log('âœ… TEST TAMAMLANDI');
}

/**
 * ğŸ§ª TEST: AlphaVantageService (DETAYLI DEBUG)
 *
 * AMAÃ‡:
 * - Tek API Ã§aÄŸrÄ±sÄ± ile Alpha Vantage davranÄ±ÅŸÄ±nÄ± gÃ¶rmek
 * - Rate limit / Note / Error ayrÄ±mÄ±nÄ± net loglamak
 * - GÃ¼nlÃ¼k veri yapÄ±sÄ±nÄ± analiz etmek
 */
function test_AlphaVantageService() {
  console.log('ğŸ§ª TEST BAÅLADI: AlphaVantageService');
  console.log('ğŸ¯ Test sembolÃ¼: AAPL');

  const startTime = new Date();

  try {
    const data = AlphaVantageStockService.fetchDailyHistory('AAPL');

    console.log('ğŸ“¦ HAM VERÄ° UZUNLUÄU:', data.length);

    if (data.length === 0) {
      console.warn('âš ï¸ HiÃ§ veri gelmedi â†’ Rate limit / sembol hatasÄ± olabilir');
      return;
    }

    // Tarih analizi
    const dates = data.map(d => d.tarih).sort();
    console.log('ğŸ“… TARÄ°H ARALIÄI', {
      enEski: dates[0],
      enYeni: dates[dates.length - 1]
    });

    // Ä°lk / son kayÄ±t
    console.log('ğŸ“„ Ä°LK 3 GÃœN', data.slice(0, 3));
    console.log('ğŸ“„ SON 3 GÃœN', data.slice(-3));

    // YapÄ± kontrolÃ¼
    const sample = data[0];
    console.log('ğŸ§¬ VERÄ° ÅEMASI KONTROLÃœ', {
      symbol: typeof sample.symbol,
      tarih: typeof sample.tarih,
      open: typeof sample.open,
      high: typeof sample.high,
      low: typeof sample.low,
      close: typeof sample.close,
      volume: typeof sample.volume
    });

    const duration = (new Date().getTime() - startTime.getTime()) / 1000;
    console.log(`â±ï¸ API sÃ¼resi: ${duration} sn`);
    console.log('âœ… AlphaVantageService TEST BAÅARIYLA TAMAMLANDI');

  } catch (e) {
    console.error('ğŸ’¥ AlphaVantageService TEST HATASI', e);
  }
}


/**
 * ğŸ§ª BIST HÄ°SSELERÄ° TESTÄ°
 */
function test_BIST_Stocks() {
  console.log('ğŸ§ª BIST HÄ°SSELERÄ° TESTÄ°');
  
  try {
    const portfolio = DataReader.readPortfolio();
    const stocks = HisseGecmisKayitService._extractAllStocks(portfolio);
    const bistStocks = stocks.filter(s => s.type === 'BIST');
    
    console.log(`ğŸ” ${bistStocks.length} BIST hissesi bulundu.`);
    
    let validCount = 0;
    let invalidCount = 0;
    
    bistStocks.forEach((stock, index) => {
      console.log(`\n${index + 1}. ${stock.symbol} -> ${stock.yahooSymbol}`);
      
      // Yahoo Finance'te var mÄ± kontrol et
      const isValid = YahooFinanceStockService.validateSymbol(stock.yahooSymbol);
      
      if (isValid) {
        console.log(`   âœ… Yahoo Finance'te geÃ§erli`);
        
        // Test verisi al (sadece 5 gÃ¼n)
        const testData = YahooFinanceStockService.fetchDailyHistory(stock.yahooSymbol, '5d');
        
        if (testData && testData.length > 0) {
          console.log(`   ğŸ“ˆ ${testData.length} gÃ¼n veri alÄ±nabildi`);
          console.log(`   ğŸ’° Son fiyat: ${testData[testData.length-1].close} ${stock.birimi}`);
          validCount++;
        } else {
          console.log(`   âš ï¸ Veri alÄ±namadÄ±`);
          invalidCount++;
        }
      } else {
        console.log(`   âŒ Yahoo Finance'te bulunamadÄ±`);
        invalidCount++;
      }
      
      // Rate limit iÃ§in bekle
      if (index < bistStocks.length - 1) {
        Utilities.sleep(2000);
      }
    });
    
    console.log('\nğŸ“Š TEST SONUCU:');
    console.log(`   Toplam BIST hissesi: ${bistStocks.length}`);
    console.log(`   GeÃ§erli: ${validCount}`);
    console.log(`   GeÃ§ersiz: ${invalidCount}`);
    
    if (invalidCount === 0) {
      console.log('ğŸ‰ TÃœM BIST HÄ°SSELERÄ° GEÃ‡ERLÄ°!');
    }
    
  } catch (error) {
    console.error('ğŸ’¥ Test hatasÄ±:', error);
  }
}

/**
 * TÃœM HÄ°SSELER Ä°Ã‡Ä°N Ä°LK SENKRONÄ°ZASYON
 */
function run_Initial_Sync_All() {
  console.log('ğŸš€ TÃœM HÄ°SSE SENKRONÄ°ZASYONU BAÅLATILIYOR');
  console.log('â±ï¸  Tahmini sÃ¼re: 40-50 saniye');
  console.log('   (10 ABD hissesi + 12 BIST hissesi = 22 hisse)');
  
  HisseGecmisKayitService.syncAllStockHistory();
}

/**
 * TÃœM HÄ°SSELER Ä°Ã‡Ä°N GÃœNLÃœK GÃœNCELLEME
 
function run_Daily_Update_All() {
  console.log('ğŸ”„ TÃœM HÄ°SSE GÃœNCELLEMESÄ° BAÅLATILIYOR');
  HisseGecmisKayitService.updateAllStocks();
}
*/
/**
 * PORTFÃ–Y ANALÄ°ZÄ° (DETAYLI)
 */
function analyze_Portfolio_Detailed() {
  console.log('ğŸ“Š PORTFÃ–Y DETAYLI ANALÄ°Z');
  
  try {
    const portfolio = DataReader.readPortfolio();
    
    console.log(`ğŸ“¦ Toplam kayÄ±t: ${portfolio.length}`);
    
    // Kategorilere gÃ¶re grupla
    const categories = {};
    
    portfolio.forEach(item => {
      const category = item.kategori || 'Belirsiz';
      categories[category] = (categories[category] || 0) + 1;
    });
    
    console.log('\nğŸ“‹ KATEGORÄ° DAÄILIMI:');
    Object.entries(categories).forEach(([category, count]) => {
      console.log(`   ${category}: ${count} kayÄ±t`);
    });
    
    // TÃ¼m hisseleri ayÄ±kla
    const allStocks = HisseGecmisKayitService._extractAllStocks(portfolio);
    const usStocks = allStocks.filter(s => s.type === 'ABD');
    const bistStocks = allStocks.filter(s => s.type === 'BIST');
    
    console.log(`\nğŸ¯ Ä°ÅLENECEK HÄ°SSELER (${allStocks.length}):`);
    console.log(`   ğŸ‡ºğŸ‡¸ ABD Hisseleri (${usStocks.length}):`);
    usStocks.forEach(stock => {
      console.log(`      - ${stock.symbol} -> ${stock.yahooSymbol} (${stock.birimi})`);
    });
    
    console.log(`\n   ğŸ‡¹ğŸ‡· BIST Hisseleri (${bistStocks.length}):`);
    bistStocks.forEach(stock => {
      console.log(`      - ${stock.symbol} -> ${stock.yahooSymbol} (${stock.birimi})`);
    });
    
    // DiÄŸer yatÄ±rÄ±mlar
    const otherInvestments = portfolio.filter(item => {
      const kategori = (item.kategori || '').toString().toUpperCase();
      return !kategori.includes('NASDAQ') && 
             !kategori.includes('NYSE') && 
             !kategori.includes('AMEX') &&
             !kategori.includes('BIST');
    });
    
    console.log(`\nğŸ’° DÄ°ÄER YATIRIMLAR (${otherInvestments.length}):`);
    const otherSymbols = [...new Set(otherInvestments.map(item => item.baslik).filter(Boolean))];
    console.log(`   ${otherSymbols.join(', ')}`);
    
    console.log('\nğŸ’¡ Ã–NERÄ°:');
    console.log(`   â€¢ Toplam ${allStocks.length} hisse iÃ§in veri Ã§ekilecek.`);
    console.log(`   â€¢ Tahmini sÃ¼re: ${allStocks.length * 3} saniye.`);
    console.log(`   â€¢ Her hisse iÃ§in ~62 gÃ¼nlÃ¼k veri alÄ±nacak.`);
    
  } catch (error) {
    console.error('ğŸ’¥ Analiz hatasÄ±:', error);
  }
}

